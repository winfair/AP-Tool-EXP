<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>Map App ‚Äî Rotating Map (Pivot at GPS)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<style>
  :root {
    --bg: #0b0f10; --panel: #12181a; --text: #e7f6ef; --accent: #29a36a; --dim: #91c7ae; --danger: #ff6b6b; --green: #2aff2a;
  }
  html, body {
    height: 100%;
    margin: 0;
    background: var(--bg);
    color: var(--text);
    -webkit-tap-highlight-color: transparent;
  }
  #map {
    position: fixed;
    inset: 0;
    height: 100svh;
    width: 100vw;
  }

  .controls {
    position: fixed;
    top: env(safe-area-inset-top, 12px);
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    gap: 8px;
    background: rgba(18, 24, 26, 0.85);
    padding: 8px 10px;
    border-radius: 14px;
    box-shadow: 0 6px 18px rgba(0, 0, 0, .35);
    z-index: 1000;
    backdrop-filter: blur(6px);
  }
  .btn {
    appearance: none;
    border: 1px solid rgba(255, 255, 255, .12);
    background: linear-gradient(180deg, rgba(255, 255, 255, .06), rgba(255, 255, 255, .02));
    color: var(--text);
    padding: 8px 10px;
    border-radius: 10px;
    font: 600 14px/1 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
    cursor: pointer;
  }
  .btn.primary { border-color: var(--accent); }
  .btn.toggled { outline: 2px solid var(--accent); }
  .badge {
    padding: 0 8px;
    border-radius: 999px;
    background: rgba(255, 255, 255, .1);
    font-size: 12px;
    margin-left: 6px;
  }

  .info {
    position: fixed;
    left: 50%;
    transform: translateX(-50%);
    bottom: calc(env(safe-area-inset-bottom, 12px));
    background: rgba(18, 24, 26, 0.9);
    padding: 8px 12px;
    border-radius: 12px;
    font: 500 13px/1.2 ui-monospace, SFMono-Regular, Menlo, monospace;
    color: var(--dim);
    z-index: 1000;
    box-shadow: 0 6px 18px rgba(0, 0, 0, .35);
    backdrop-filter: blur(6px);
  }

  .fab {
    position: fixed;
    right: 14px;
    bottom: calc(env(safe-area-inset-bottom, 14px) + 56px);
    z-index: 1000;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    display: grid;
    place-items: center;
    background: rgba(18, 24, 26, 0.9);
    border: 1px solid rgba(255, 255, 255, .12);
  }

  .panel {
    position: fixed;
    right: 12px;
    bottom: calc(env(safe-area-inset-bottom, 12px) + 120px);
    width: min(92vw, 360px);
    max-height: 60vh;
    overflow: auto;
    background: rgba(18, 24, 26, 0.95);
    border: 1px solid rgba(255, 255, 255, .12);
    border-radius: 16px;
    padding: 12px;
    z-index: 1000;
    box-shadow: 0 12px 32px rgba(0, 0, 0, .45);
    display: none;
  }
  .panel.open { display: block; }
  .row { display: grid; gap: 8px; margin: 10px 0; }
  .row input, .row button {
    width: 100%;
    padding: 10px 12px;
    border-radius: 10px;
    border: 1px solid rgba(255, 255, 255, .12);
    background: rgba(255, 255, 255, .04);
    color: var(--text);
    font: 500 14px/1.2 system-ui, sans-serif;
  }
  .list { display: grid; gap: 8px; }
  .item {
    display: grid;
    grid-template-columns: 1fr auto auto;
    gap: 6px;
    align-items: center;
    padding: 8px;
    border: 1px solid rgba(255, 255, 255, .08);
    border-radius: 10px;
  }
  .item small { color: var(--dim); display: block; }
  .item button { padding: 6px 10px; }
  .danger { border-color: var(--danger); color: var(--danger); }

  .leaflet-control-attribution, .leaflet-control-zoom { filter: drop-shadow(0 6px 12px rgba(0, 0, 0, .35)); }
  .leaflet-container a { color: var(--dim); }
  .leaflet-map-pane { will-change: transform; }

  /* HUD: Single compass arrow */
  .hud {
    position: fixed;
    inset: 0;
    z-index: 900;
    pointer-events: none;
    display: flex;
    align-items: center;
    justify-content: center;
  }
  .heading-indicator svg {
    width: 56px;
    height: 56px;
    transform: rotate(0deg);
    transition: transform 0.25s ease-out;
    filter: drop-shadow(0 0 8px rgba(42, 255, 42, 0.6));
  }
</style>
</head>
<body>
  <div id="map"></div>

  <!-- HUD -->
  <div class="hud" aria-hidden="true">
    <div class="heading-indicator">
      <svg viewBox="0 0 100 100" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <g class="arrow">
          <path d="M50 10 L65 55 L50 45 L35 55 Z" fill="#2aff2a"/>
          <circle cx="50" cy="60" r="14" fill="#0b0f10" stroke="#2aff2a" stroke-width="3"/>
        </g>
      </svg>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <button id="btnLocate" class="btn primary">Enable GPS</button>
    <button id="btnFollow" class="btn toggled">Follow: <span id="followState" class="badge">on</span></button>
    <button id="btnCompass" class="btn">Compass <span id="compassState" class="badge">off</span></button>
    <button id="btnReset" class="btn">Reset</button>
  </div>

  <!-- Waypoints -->
  <button id="btnWaypoints" class="btn fab" title="Waypoints">üìç</button>
  <div id="wpPanel" class="panel" aria-hidden="true">
    <div class="row">
      <input id="wpName" placeholder="Name (e.g., Tower SE)" />
      <input id="wpCoords" placeholder='Coords (e.g., 34.851939 N, -119.168399 W or 34.851939,-119.168399)' />
      <button id="wpAdd" class="btn primary">Add / Update</button>
    </div>
    <div class="list" id="wpList"></div>
  </div>

  <div class="info" id="readout">Lat: ‚Äî, Lng: ‚Äî | Acc: ‚Äî m | Head: ‚Äî¬∞ | Map bearing: ‚Äî¬∞</div>

<script>
// Your entire JavaScript stays exactly the same except for these key edits:

// Replace these constants:
const EMA_ALPHA = 0.12;  // slightly stronger smoothing
const DEADBAND = 1.0;    // reduce jitter threshold
const MAX_DEG_PER_SEC = 90; // limit map turn speed

// In the animation tick loop (already inside requestAnimationFrame):
function tick(ts){
  if (lastTs == null) lastTs = ts;
  const dt = Math.max(0.001, (ts - lastTs) / 1000); lastTs = ts;

  if (headingFiltered != null){
    const maxStep = MAX_DEG_PER_SEC * dt;
    const d = diff(headingAnim, headingFiltered);
    const step = Math.abs(d) > maxStep ? Math.sign(d) * maxStep : d;
    headingAnim = normalize(headingAnim + step);

    applyBearingWithPivot(headingAnim);
    document.querySelector('.heading-indicator svg').style.transform = `rotate(${headingAnim}deg)`;
    updateReadout();
  }
  requestAnimationFrame(tick);
}
requestAnimationFrame(tick);
</script>
<script src="main.js"></script> <!-- Your full JavaScript remains same, just with above edits -->
</body>
</html>
