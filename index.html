<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AP-Tool HUD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg:#000000;
      --ink:#00ff5b;
      --ink-dim:#00b34a;
      --ink-soft:#009944;
      --err:#ff4b4b;
      --warn:#ffd85a;
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    *{
      box-sizing:border-box;
      -webkit-tap-highlight-color:transparent;
    }
    html,body{
      margin:0;
      padding:0;
      height:100%;
      background:var(--bg);
      color:var(--ink);
      font-family:var(--mono);
      font-size:12px;
    }
    body{
      display:flex;
      justify-content:center;
      align-items:flex-start;
    }
    #app{
      width:100%;
      max-width:520px;
      min-height:100vh;
      padding:6px 6px 10px;
      display:flex;
      flex-direction:column;
      gap:4px;
    }

    /* --- TERMINAL TEXT DECOR --- */
    .banner{
      margin:0 0 2px;
      white-space:pre;
      color:var(--ink);
    }
    .banner .dim{color:var(--ink-dim);}
    .banner .soft{color:var(--ink-soft);}
    .hr{
      width:100%;
      height:1px;
      background:linear-gradient(to right,var(--ink-soft),rgba(0,0,0,0));
      margin:2px 0;
    }

    .hud{
      display:flex;
      flex-direction:column;
      gap:4px;
      flex:1 1 auto;
    }
    .hud-row{
      display:flex;
      justify-content:space-between;
      gap:4px;
      align-items:flex-start;
    }
    .hud-row.centered{
      align-items:center;
    }
    .hud-cell{
      flex:1 1 0;
      min-width:0;
    }
    .hud-cell.center{
      text-align:center;
    }

    .label{
      color:var(--ink-soft);
      text-transform:uppercase;
      letter-spacing:.14em;
      font-size:10px;
    }
    .val{
      color:var(--ink);
    }
    .val-small{
      font-size:10px;
      color:var(--ink-dim);
    }
    .mono-small{
      font-size:10px;
    }

    .status-line{
      margin-top:2px;
      min-height:14px;
      color:var(--ink-dim);
      font-size:11px;
    }

    /* TOP HUD ROW */
    .hud-top-block{
      white-space:nowrap;
      font-size:11px;
      line-height:1.3;
    }
    .pill-inline{
      display:inline-block;
      padding:0 2px;
      margin-left:2px;
      color:var(--ink);
    }

    /* MAIN HUD ROW (COMPASS + PITCH SIDE BY SIDE) */
    .main-hud-row{
      align-items:center;
    }
    .hud-side{
      flex:0 0 130px;
      font-size:11px;
      line-height:1.25;
    }
    .hud-center{
      flex:1 1 auto;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .compass-group{
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    #headingCompass{
      display:block;
    }
    #pitchCompass{
      display:block;
    }

    /* BOTTOM HUD ROW */
    .hud-bottom{
      font-size:11px;
    }
    .error-line{
      color:var(--err);
      font-size:10px;
    }
    .mini-pill{
      font-size:10px;
      color:var(--ink-dim);
    }
    .mini-pill.ok{color:var(--ink);}
    .mini-pill.bad{color:var(--err);}
    .mini-pill.warn{color:var(--warn);}

    /* CONTROLS ROW */
    .controls-row{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:4px;
    }
    .tbtn{
      border:none;
      background:transparent;
      padding:2px 4px;
      color:var(--ink);
      font-family:var(--mono);
      font-size:11px;
      cursor:pointer;
    }
    .tbtn span.cmd{
      color:var(--ink-soft);
    }
    .tbtn span.lbl{
      color:var(--ink);
    }
    .tbtn.disabled,
    .tbtn:disabled{
      color:var(--ink-dim);
      cursor:default;
    }

    /* INPUTS / FIELDS */
    .input-small,
    .decl-input{
      background:#000;
      border:1px solid var(--ink-soft);
      color:var(--ink);
      font-family:var(--mono);
      font-size:11px;
      padding:1px 2px;
      width:82px;
      text-align:right;
    }

    .btn-mini{
      border:none;
      background:transparent;
      padding:0 2px;
      font-size:10px;
      color:var(--ink-soft);
      cursor:pointer;
    }

    /* OVERLAYS (MAP + SAVE/TARGET MENU) */
    .overlay-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.95);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
    }
    .overlay-panel{
      width:100%;
      max-width:520px;
      max-height:90vh;
      display:flex;
      flex-direction:column;
      padding:4px 6px 6px;
      border:1px solid var(--ink-soft);
      background:#000;
      font-size:11px;
    }
    #mapDiv{
      flex:1 1 auto;
      min-height:260px;
      border:1px solid var(--ink-soft);
      margin:2px 0;
    }
    .overlay-row{
      display:flex;
      justify-content:space-between;
      font-size:11px;
    }
    .overlay-status{
      font-size:11px;
      color:var(--ink-dim);
    }

    /* SAVE / TARGET MENU CONTENT */
    .save-panel,
    .saved-box{
      margin-top:4px;
      font-size:11px;
    }
    .saved-target-row{
      display:flex;
      justify-content:space-between;
      gap:4px;
    }
    .saved-name{
      color:var(--ink);
    }
    .saved-meta{
      color:var(--ink-dim);
      font-size:10px;
    }

    @media (max-width:420px){
      .hud-side{
        flex:0 0 118px;
      }
      #headingCompass{
        width:210px;
        height:210px;
      }
      #pitchCompass{
        width:60px;
        height:210px;
      }
    }
  </style>
</head>
<body>
  <div id="app">

    <!-- ASCII banner -->
    <pre class="banner">
&gt; AP-TOOL  ::  AZIMUTH MULTI-HUD
  [MODE: <span class="dim">TERMINAL</span>]  [THEME: <span class="soft">GREEN/BLACK</span>]</pre>
    <div class="hr"></div>

    <div class="hud">

      <!-- TOP ROW: GPS / SYSTEM / ORI -->
      <div class="hud-row">
        <div class="hud-cell hud-top-block">
          <span class="label">GPS</span>
          <span class="pill-inline" id="gpsStatusPill">gps: idle</span><br>
          LAT:&nbsp;<span class="val" id="gpsLat">—</span><br>
          LON:&nbsp;<span class="val" id="gpsLon">—</span><br>
          ALT:&nbsp;<span class="val" id="gpsAlt">—</span>
        </div>
        <div class="hud-cell center hud-top-block">
          <span class="label">SYSTEM</span><br>
          &gt; STATUS:&nbsp;<span class="val" id="comboStatus">gps: idle · ori: idle</span><br>
          &gt; AIM:&nbsp;&nbsp;&nbsp;&nbsp;<span class="val" id="aimStatusPill">NO TARGET</span>
        </div>
        <div class="hud-cell hud-top-block" style="text-align:right;">
          <span class="label">ORI</span>
          <span class="pill-inline" id="oriStatusPill">ori: idle</span><br>
          HDG:&nbsp;<span class="val" id="headingVal">—</span><br>
          PCH:&nbsp;<span class="val" id="pitchVal">—</span><br>
          DEC:&nbsp;
          <input id="declInput" class="decl-input" type="number" step="0.1" value="0">
          <span class="val-small"> °E+, °W-</span><br>
          <span id="oriSupportPill" class="mini-pill mono-small">Checking support…</span>
        </div>
      </div>

      <!-- MAIN HUD ROW: SELF / COMPASS+PITCH / TARGET -->
      <div class="hud-row main-hud-row">
        <!-- SELF DATA (LEFT) -->
        <div class="hud-cell hud-side">
          <span class="label">SELF</span><br>
          HDG(TRUE): <span class="val" id="headingVal_dup">—</span><br>
          PCH(DEG):&nbsp;&nbsp;<span class="val" id="pitchVal_dup">—</span><br>
          HORIZ DIST:<br>
          &nbsp;&nbsp;<span class="val" id="aimHorizDist">—</span><br>
          VERT DELTA:<br>
          &nbsp;&nbsp;<span class="val" id="aimVertDelta">—</span>
        </div>

        <!-- COMPASS + PITCH (CENTER) -->
        <div class="hud-cell hud-center">
          <div class="compass-group">
            <canvas id="headingCompass" width="240" height="240"></canvas>
            <canvas id="pitchCompass" width="70" height="240"></canvas>
          </div>
        </div>

        <!-- TARGET DATA (RIGHT) -->
        <div class="hud-cell hud-side" style="text-align:right;">
          <span class="label">TARGET</span><br>
          LAT: <span class="val" id="targetLat">—</span><br>
          LON: <span class="val" id="targetLon">—</span><br>
          ALT: <span class="val" id="targetElev">—</span><br>
          REQ HDG:&nbsp;<span class="val" id="aimReqHeading">—</span><br>
          REQ PCH:&nbsp;<span class="val" id="aimReqPitch">—</span><br>
          STATE:&nbsp;&nbsp;<span class="val-small" id="targetStatusPill">No target</span>
        </div>
      </div>

      <!-- BOTTOM ROW: ERRORS + TEXT STATUS -->
      <div class="hud-bottom">
        <span class="label">AIM ERROR</span><br>
        &Delta;HDG:&nbsp;<span class="val" id="aimHeadingErr">—</span>&nbsp;&nbsp;
        &Delta;PCH:&nbsp;<span class="val" id="aimPitchErr">—</span><br>

        <div id="gpsErrorBox" class="error-line" style="display:none">
          gps-error: <span id="gpsError">—</span>
        </div>
        <div id="oriErrorBox" class="error-line" style="display:none">
          ori-error: <span id="oriError">—</span>
        </div>
        <div id="targetStatusText" class="mono-small" style="color:var(--ink-dim);">
          No target selected. Use &lt;SELECT TARGET&gt; or open the save/targets menu.
        </div>
        <div class="status-line" id="statusText">
          Ready. Tap &lt;START SENSORS&gt; once and accept the browser prompts on your phone.
        </div>
      </div>
    </div>

    <!-- CONTROL COMMANDS -->
    <div class="hr"></div>
    <div class="controls-row">
      <button id="startBtn" class="tbtn">
        <span class="cmd">&gt;&gt;</span><span class="lbl"> START SENSORS</span>
      </button>
      <button id="selectTargetBtn" class="tbtn">
        <span class="cmd">@</span><span class="lbl"> SELECT TARGET (MAP)</span>
      </button>
      <button id="openSaveTargetBtn" class="tbtn">
        <span class="cmd">#</span><span class="lbl"> SAVE / TARGET MENU</span>
      </button>
      <button id="calibrateHeadingBtn" class="tbtn">
        <span class="cmd">*</span><span class="lbl"> CALIBRATE TO TARGET</span>
      </button>
    </div>
  </div>

  <!-- MAP OVERLAY -->
  <div id="mapOverlay" class="overlay-backdrop">
    <div class="overlay-panel">
      <div>
        <span class="label">TARGET MAP</span>  [tap to select]  [ESC: close]
      </div>
      <div id="mapDiv"></div>
      <div class="overlay-row">
        <span>LAT:</span><span id="overlayLat">—</span>
      </div>
      <div class="overlay-row">
        <span>LON:</span><span id="overlayLon">—</span>
      </div>
      <div class="overlay-row">
        <span>ALT:</span><span id="overlayElev">—</span>
      </div>
      <div class="overlay-row" style="margin-top:2px;">
        <button id="cancelTargetBtn" class="btn-mini">X CLOSE</button>
        <button id="confirmTargetBtn" class="btn-mini">&gt;&gt; USE THIS POINT</button>
      </div>
      <div class="overlay-status" id="overlayStatus">
        Tap anywhere on the map to place a pin. Elevation will be fetched.
      </div>
    </div>
  </div>

  <!-- SAVE/TARGET FLOATING MENU OVERLAY -->
  <div id="saveOverlay" class="overlay-backdrop">
    <div class="overlay-panel">
      <div class="overlay-row" style="margin-bottom:2px;">
        <span class="label">SAVE / TARGET MENU</span>
        <button id="closeSaveOverlayBtn" class="btn-mini">X CLOSE</button>
      </div>

      <!-- SAVE / EDIT PANEL -->
      <div id="saveTargetPanel" class="save-panel" style="display:none">
        NAME: <input id="saveTargetName" class="input-small" type="text"><br>
        LAT:&nbsp;&nbsp;<input id="saveTargetLat" class="input-small" type="number" step="0.000001"><br>
        LON:&nbsp;&nbsp;<input id="saveTargetLon" class="input-small" type="number" step="0.000001"><br>
        ALT:&nbsp;&nbsp;<input id="saveTargetElev" class="input-small" type="number" step="0.1">
        <span class="val-small"> m</span><br>
        <button id="saveTargetConfirmBtn" class="tbtn">
          <span class="cmd">&gt;&gt;</span><span class="lbl"> SAVE</span>
        </button>
        <button id="saveTargetCancelBtn" class="tbtn">
          <span class="cmd">X</span><span class="lbl"> CANCEL</span>
        </button>
      </div>

      <!-- SAVED TARGETS LIST -->
      <div id="savedTargetsBox" class="saved-box" style="display:none">
        <span class="label">SAVED TARGETS</span><br>
        <div id="savedTargetsList"></div>
      </div>
    </div>
  </div>

  <!-- MODULES -->
  <script src="sensors.js"></script>
  <script src="map.js"></script>
  <script src="aim-math.js"></script>
  <script src="declination.js"></script>
  <script src="compass.js"></script>
  <script src="ui.js"></script>

  <!-- mirror heading/pitch into SELF block -->
  <script>
    function mirrorHUDFields(){
      var h = document.getElementById('headingVal');
      var p = document.getElementById('pitchVal');
      var h2 = document.getElementById('headingVal_dup');
      var p2 = document.getElementById('pitchVal_dup');
      if(h && h2) h2.textContent = h.textContent;
      if(p && p2) p2.textContent = p.textContent;
    }
    const mo = new MutationObserver(mirrorHUDFields);
    mo.observe(document.getElementById('headingVal'), {childList:true});
    mo.observe(document.getElementById('pitchVal'), {childList:true});
    mirrorHUDFields();
  </script>
</body>
</html>
