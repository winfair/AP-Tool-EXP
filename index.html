<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>AP Tool — Azimuth Multi-Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <style>
    :root { --bg:#020617; --card:#0b1220; --ink:#e5e7eb; --muted:#94a3b8; --accent:#38bdf8; --ok:#22c55e; --warn:#f59e0b; --vio:#a855f7; --line:rgba(148,163,184,.2); }
    * { box-sizing: border-box; }
    html, body { margin:0; height:100%; background:var(--bg); color:var(--ink); font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif; }
    #ap-root { height:100svh; max-width:480px; margin:0 auto; display:flex; flex-direction:column; }
    .appbar { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--line); }
    .appbar .title { font-weight:700; letter-spacing:.3px; }
    .content { flex:1; overflow:auto; padding:10px; display:flex; flex-direction:column; gap:10px; }
    .grid-actions { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
    .btn { border:none; border-radius:12px; padding:12px; font-weight:700; font-size:.9rem; cursor:pointer; }
    .btn:disabled { opacity:.6; cursor:default; }
    .btn-green{ background:var(--ok); color:#062e22; }
    .btn-blue { background:#0ea5e9; color:#02131d; }
    .btn-vio  { background:var(--vio); color:#17052a; }
    .btn-amber{ background:var(--warn); color:#271400; }
    .btn-slate{ background:#64748b; color:#0b1220; }
    .card { background:#030712; border:1px solid var(--line); border-radius:12px; padding:10px; }
    .row { display:flex; align-items:center; justify-content:space-between; gap:8px; }
    .row-ctrl { display:flex; align-items:center; justify-content:space-between; gap:8px; margin-bottom:8px; font-size:.85rem; }
    .metric-grid { display:grid; grid-template-columns:1fr 1fr; gap:6px 10px; font-size:.85rem; }
    .metric-grid .k { opacity:.75; font-size:.78rem; }
    .pill { padding:5px 8px; border-radius:999px; background:#0b1220; border:1px solid var(--line); font-size:.72rem; color:var(--muted); }
    .warn { color:#fbbf24; }
    .sheet { position:fixed; left:0; right:0; bottom:-100%; transition:bottom .25s ease; z-index:60; }
    .sheet.open { bottom:0; }
    .sheet .panel { margin:0 auto; max-width:480px; height:70svh; background:var(--card); border-top-left-radius:16px; border-top-right-radius:16px; border:1px solid var(--line); border-bottom:none; display:flex; flex-direction:column; }
    .sheet .head { display:flex; align-items:center; justify-content:space-between; padding:10px 12px; border-bottom:1px solid var(--line); }
    .sheet .body { flex:1; overflow:auto; padding:10px; }
    .sheet .close { border:none; background:#ef4444; color:#111827; border-radius:999px; padding:6px 10px; font-weight:700; cursor:pointer; }
    #map-container { width:100%; height:100%; border-radius:10px; overflow:hidden; }
    input[type="number"], input[type="range"], select { accent-color: var(--accent); }
    input[type="number"] { width:120px; background:#0f172a; border:1px solid #334155; color:var(--ink); border-radius:8px; padding:6px; }
    select { background:#0f172a; border:1px solid #334155; color:var(--ink); border-radius:8px; padding:6px; }
    #compass, #compass-elev { display:block; width:100%; border-radius:12px; background:#0b1220; border:1px solid var(--line); }
    #compass { height:220px; } #compass-elev { height:180px; }
    #compass.on-target, #compass-elev.on-target { border-color:rgba(34,197,94,.9); box-shadow:0 0 0 1px rgba(34,197,94,.7); }
    .caption { font-size:.75rem; color:var(--muted); margin-top:4px; text-align:center; }
  </style>

  <!-- Leaflet CSS -->
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="" />
</head>
<body>
  <div id="ap-root">
    <div class="appbar">
      <div class="title">AP Tool</div>
      <button id="btn-settings" class="btn btn-slate" style="padding:8px 10px;font-weight:600;">Settings</button>
    </div>

    <div class="content">
      <div class="grid-actions">
        <button id="btn-sensors" class="btn btn-green">Start Sensors</button>
        <button id="btn-map" class="btn btn-blue">Pick Target</button>
        <button id="btn-calib-target" class="btn btn-vio">Calibrate to Target</button>
        <button id="btn-calib-axes" class="btn btn-amber">Axes Calibration</button>
      </div>

      <div class="card">
        <div class="row" style="margin-bottom:8px;">
          <div style="font-weight:700;">Live</div>
          <div id="live-status" class="pill">Start sensors & set target</div>
        </div>

        <canvas id="compass"></canvas>
        <div class="caption">Azimuth — target vs heading</div>

        <div style="height:8px"></div>

        <canvas id="compass-elev"></canvas>
        <div class="caption">Elevation — required vs pitch</div>

        <div class="metric-grid" style="margin-top:8px;">
          <div><div class="k">Azimuth → target</div><div><span id="live-azimuth">–</span>°</div></div>
          <div><div class="k">Heading</div><div><span id="live-heading">–</span></div></div>
          <div><div class="k">Turn</div><div><span id="live-turn">–</span></div></div>
          <div><div class="k">Distance</div><div><span id="live-distance">–</span></div></div>
          <div><div class="k">Required elevation</div><div><span id="live-elev-angle">–</span></div></div>
          <div><div class="k">Pitch</div><div><span id="live-pitch">–</span></div></div>
          <div><div class="k">Tilt</div><div><span id="live-tilt">–</span></div></div>
          <div><div class="k">Declination</div><div><span id="live-decl">–</span></div></div>
          <div><div class="k">Obs elev used</div><div><span id="live-obs-elev">–</span></div></div>
          <div><div class="k">ΔZ (tgt−obs)</div><div><span id="live-dz">–</span></div></div>
        </div>

        <div class="row" style="margin-top:10px;gap:8px;">
          <button id="btn-quick-level" class="btn btn-slate" style="flex:1;">Quick Level</button>
          <button id="btn-reset-axes" class="btn btn-slate" style="flex:1;">Reset Axes</button>
        </div>
      </div>

      <div class="card">
        <div class="row" style="margin-bottom:6px;">
          <div style="font-weight:700;">Sensors</div>
          <div id="sensor-status" class="pill">Idle</div>
        </div>
        <div class="metric-grid">
          <div>Lat: <span id="gps-lat">–</span></div>
          <div>Lon: <span id="gps-lon">–</span></div>
          <div>Alt (m): <span id="gps-alt">–</span></div>
          <div>Acc (m): <span id="gps-acc">–</span></div>
          <div>Speed (m/s): <span id="gps-speed">–</span></div>
          <div>GPS head (°): <span id="gps-heading">–</span></div>
          <div>Alpha (°): <span id="ori-alpha">–</span></div>
          <div>Beta (°): <span id="ori-beta">–</span></div>
          <div>Gamma (°): <span id="ori-gamma">–</span></div>
          <div>Abs: <span id="ori-abs">–</span></div>
        </div>
      </div>

      <div class="card">
        <div class="row" style="margin-bottom:6px;">
          <div style="font-weight:700;">Target</div>
          <div class="row" style="gap:8px;">
            <div id="target-status" class="pill">Tap map</div>
            <button id="btn-edit-target-elev" class="btn btn-slate" style="padding:6px 10px;">Edit elevation</button>
            <button id="btn-retry-elev" class="btn btn-blue" style="padding:6px 10px;">Retry elevation</button>
          </div>
        </div>
        <div class="metric-grid">
          <div>Lat: <span id="target-lat">–</span></div>
          <div>Lon: <span id="target-lon">–</span></div>
          <div>Elev (m): <span id="target-elev">–</span></div>
          <div>Src: <span id="target-elev-src">–</span></div>
        </div>
      </div>
    </div>

    <textarea id="gps-json" style="display:none;"></textarea>
    <textarea id="ori-json" style="display:none;"></textarea>
    <textarea id="target-json" style="display:none;"></textarea>
  </div>

  <!-- MAP SHEET -->
  <div id="sheet-map" class="sheet">
    <div class="panel">
      <div class="head">
        <div style="font-weight:700;">Map Picker</div>
        <button id="btn-close-map" class="close">Close</button>
      </div>
      <div class="body">
        <div id="map-status" class="pill" style="margin-bottom:8px;">Tap near your AP / target</div>
        <div id="map-container"></div>
      </div>
    </div>
  </div>

  <!-- SETTINGS SHEET -->
  <div id="sheet-settings" class="sheet">
    <div class="panel">
      <div class="head">
        <div style="font-weight:700;">Settings</div>
        <button id="btn-close-settings" class="close">Close</button>
      </div>
      <div class="body">
        <div class="row-ctrl">
          <input id="toggle-decl" type="checkbox" />
          <label for="toggle-decl">Apply magnetic declination</label>
        </div>

        <div class="row-ctrl" style="gap:12px;">
          <label style="opacity:.9;">Altitude mode</label>
          <select id="select-alt-mode">
            <option value="dem" selected>DEM for observer & target (recommended)</option>
            <option value="gps">GPS altitude for observer</option>
            <option value="manual">Manual observer elevation</option>
          </select>
        </div>

        <div class="row-ctrl">
          <label>Observer instrument height (m)</label>
          <input id="input-instrument-h" type="number" step="0.1" value="1.5" />
        </div>

        <div class="row-ctrl">
          <label>Manual observer elevation (m)</label>
          <input id="input-manual-obs" type="number" step="0.1" value="0" />
        </div>

        <div class="row-ctrl">
          <label>GPS geoid offset (m) — add to GPS alt</label>
          <input id="input-geoid-offset" type="number" step="0.5" value="0" />
        </div>

        <div class="row-ctrl" style="gap:12px;">
          <label style="opacity:.9;">Multi-source elevation</label>
          <input id="toggle-multi-elev" type="checkbox" checked />
        </div>
        <div class="row-ctrl" style="gap:12px;">
          <label style="opacity:.9;">Elevation aggregator</label>
          <select id="select-elev-agg">
            <option value="mean" selected>Mean</option>
            <option value="median">Median</option>
          </select>
        </div>

        <div style="opacity:.9;margin:6px 0 4px;">Manual declination offset (°) — adds to model</div>
        <div class="row-ctrl">
          <input id="manual-decl-range" type="range" min="-30" max="30" step="0.1" value="0" style="flex:1;" />
          <input id="manual-decl-number" type="number" min="-30" max="30" step="0.1" value="0" />
        </div>
        <div id="settings-decl-preview" class="pill">Declination: –</div>
        <div id="settings-alt-preview" class="pill" style="margin-top:6px;">Altitude: –</div>
      </div>
    </div>
  </div>

  <!-- TARGET ELEVATION SHEET -->
  <div id="sheet-target-elev" class="sheet">
    <div class="panel">
      <div class="head">
        <div style="font-weight:700;">Target Elevation</div>
        <button id="btn-close-target-elev" class="close">Close</button>
      </div>
      <div class="body">
        <div id="elev-sources" class="pill" style="margin-bottom:8px;">No sources yet.</div>
        <div id="elev-errors" class="pill warn" style="margin-bottom:8px; display:none;"></div>
        <div class="row-ctrl">
          <label>Manual elevation (m)</label>
          <input id="edit-target-elev" type="number" step="0.1" value="0" />
          <button id="btn-elev-save" class="btn btn-vio" style="padding:8px 12px;">Save</button>
        </div>
        <div class="row" style="gap:8px; margin-top:8px;">
          <button id="btn-elev-use-avg" class="btn btn-blue" style="flex:1;">Use averaged</button>
          <button id="btn-elev-use-gps" class="btn btn-amber" style="flex:1;">Use GPS alt</button>
        </div>
        <div class="row-ctrl" style="margin-top:8px;">
          <input id="toggle-lock-elev" type="checkbox" />
          <label for="toggle-lock-elev">Lock manual elevation (don’t auto-override)</label>
        </div>
      </div>
    </div>
  </div>

  <!-- Leaflet JS + main app script -->
  <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>
  <script defer src="app.js"></script>
</body>
</html>
