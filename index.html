<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<meta name="theme-color" content="#0b0f12"/>
<title>AP Alignment ‚Äî Oriented Minimap</title>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<script src="https://cdn.jsdelivr.net/npm/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<style>
:root{--bg:#0b0f12;--ink:#e9f5f0;--muted:#a8cfc0;--brand:#20d7b7;--accent:#2ac18a;--line:rgba(255,255,255,.12);--line2:rgba(255,255,255,.2)}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:#0b0f12;color:var(--ink);font-family:system-ui,-apple-system,Inter,Segoe UI,Roboto,ui-sans-serif}
.app{position:fixed;inset:0;display:grid;grid-template-rows:auto 1fr auto}
.top{position:sticky;top:0;z-index:50;display:flex;gap:10px;align-items:center;padding:calc(env(safe-area-inset-top,0px)+6px) 10px 6px;background:linear-gradient(180deg,rgba(0,0,0,.42),rgba(0,0,0,.14));border-bottom:1px solid var(--line2);backdrop-filter:blur(6px)}
.brand{font-weight:800;font-size:13px;letter-spacing:.2px;opacity:.9}
.alignbar{flex:1;min-width:160px;height:26px;border:1px solid var(--line2);border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,.05),rgba(255,255,255,.02));display:grid;grid-template-columns:1fr auto;overflow:hidden}
.alignbar .needle{--err:0deg;position:relative}
.alignbar .needle::before{content:"";position:absolute;inset:0;background:linear-gradient(90deg,rgba(32,215,183,0),rgba(32,215,183,.8) 50%,rgba(32,215,183,0));transform:translateX(calc(var(--err)*.6));filter:blur(2px);opacity:.7}
.alignbar .txt{display:flex;align-items:center;padding:0 8px;font:800 12px/1 system-ui}
.btn{appearance:none;border:1px solid var(--line);background:rgba(255,255,255,.05);color:var(--ink);border-radius:12px;padding:8px 10px;font-weight:800;cursor:pointer}
.btn.icon{width:40px;height:40px;display:grid;place-items:center}
.btn.on{border-color:var(--brand);box-shadow:0 0 0 1px rgba(32,215,183,.22) inset}
.stage{display:grid;place-items:center;padding:8px 10px}
.minimap{position:relative;width:min(92vmin,720px);aspect-ratio:1;border-radius:50%;box-shadow:0 8px 24px rgba(0,0,0,.5),0 0 0 1px var(--line) inset;background:radial-gradient(60% 60% at 50% 50%, rgba(32,215,183,.06), rgba(32,215,183,.01) 60%, rgba(0,0,0,.0) 62%)}
.mapwrap{position:absolute;inset:4%;border-radius:50%;overflow:hidden;will-change:transform}
#map{position:absolute;inset:-6%;width:112%;height:112%}
.radar{position:absolute;inset:0;border-radius:50%;border:1px dashed rgba(255,255,255,.14);pointer-events:none}
.radar2{position:absolute;inset:7%;border-radius:50%;border:1.5px solid rgba(32,215,183,.16);pointer-events:none}
.cardinals{position:absolute;inset:0;pointer-events:none;color:#bff3e8a6;font:800 10px/1 system-ui}
.cardinals span{position:absolute}.N{top:2%}.S{bottom:2%}.E{right:3%}.W{left:3%}
.modechip{position:absolute;left:50%;top:8%;transform:translate(-50%,-50%);display:flex;gap:4px;padding:4px;border:1px solid var(--line);border-radius:12px;background:rgba(0,0,0,.5)}
.modechip button{border-radius:10px;border:1px solid var(--line);background:rgba(255,255,255,.05);color:var(--ink);font:800 12px/1 system-ui;padding:6px 10px}
.modechip button.on{border-color:var(--brand);background:rgba(32,215,183,.16)}
.quick{position:absolute;right:10%;bottom:10%;width:44px;height:44px;border-radius:12px;border:1px solid var(--line2);background:rgba(255,255,255,.06);font-weight:900}
.ray{position:absolute;inset:0;border-radius:50%;pointer-events:none}
.ray > .arm{position:absolute;left:50%;top:50%;width:2px;height:47%;background:linear-gradient(180deg,rgba(32,215,183,0),rgba(32,215,183,.9));transform-origin:top center;transform:translate(-50%,-100%) rotate(0deg)}
.sweep{position:absolute;inset:4%;border-radius:50%;overflow:hidden;pointer-events:none}
.sweep::before{content:"";position:absolute;inset:-20%;background:conic-gradient(from 0deg,rgba(32,215,183,0) 0deg,rgba(32,215,183,.08) 10deg,rgba(32,215,183,0) 22deg);animation:spin 5.5s linear infinite;filter:blur(1px)}
@keyframes spin{to{transform:rotate(360deg)}}
@media (prefers-reduced-motion: reduce){.sweep::before{animation:none}}
.ringctrl{position:absolute;left:50%;top:50%;width:88%;height:88%;transform:translate(-50%,-50%);pointer-events:none}
.rc{--a:0deg;position:absolute;left:50%;top:50%;transform:rotate(var(--a)) translate(calc(50% + 4px)) rotate(calc(-1*var(--a)));pointer-events:auto}
.ping{position:absolute;width:9px;height:9px;border-radius:50%;background:radial-gradient(circle,#d8fff6,#20d7b7 60%,#20d7b700 62%);box-shadow:0 0 18px rgba(32,215,183,.65),0 0 0 1px rgba(32,215,183,.7) inset;transform:translate(-50%,-50%);pointer-events:none;opacity:0;transition:opacity .12s}
.ping.show{opacity:1}.ping.flash{animation:ping .6s ease-out 1}
@keyframes ping{0%{box-shadow:0 0 0 2px rgba(32,215,183,.9),0 0 20px rgba(32,215,183,.9)}100%{box-shadow:0 0 0 10px rgba(32,215,183,0),0 0 38px rgba(32,215,183,0)}}
.edge{position:absolute;padding:4px 8px;border-radius:10px;border:1px solid var(--line2);background:rgba(0,0,0,.52);color:#e5fbf5;font:800 11px/1 system-ui;transform:translate(-50%,-50%);white-space:nowrap;user-select:none}
.hud{position:sticky;bottom:0;z-index:40;padding:8px 10px calc(env(safe-area-inset-bottom,0px)+10px);display:grid;grid-template-columns:1fr 1fr;gap:10px;align-items:center;background:linear-gradient(0deg,rgba(0,0,0,.42),rgba(0,0,0,.14));border-top:1px solid var(--line2);backdrop-filter:blur(6px)}
.stat{display:flex;gap:10px;align-items:baseline;flex-wrap:wrap}.k{color:var(--muted);font:700 12px/1 system-ui}.v{font-weight:900;font-variant-numeric:tabular-nums}
.chip{padding:6px 8px;border-radius:9px;border:1px solid var(--line);background:rgba(255,255,255,.05);font-weight:800}.chip.lock{border-color:#ff9f43;color:#ffd8a6}
.sheet{position:fixed;left:0;right:0;bottom:0;transform:translateY(110%);z-index:60;background:rgba(12,18,20,.9);border-top:1px solid var(--line2);border-radius:16px 16px 0 0;padding:14px 12px calc(env(safe-area-inset-bottom,0px)+14px);box-shadow:0 -24px 48px rgba(0,0,0,.45);transition:transform .22s;max-height:78vh;overflow:auto}
.sheet.open{transform:translateY(0%)}.sheet h3{margin:8px 4px;font-size:13px;letter-spacing:.3px;opacity:.85}.row{display:grid;gap:8px;margin:8px 0}.inline{display:flex;gap:8px;align-items:center;flex-wrap:wrap}.input{padding:10px 12px;border-radius:12px;border:1px solid var(--line);background:rgba(255,255,255,.05);color:var(--ink);font-weight:600}
.toast{position:fixed;left:12px;right:12px;top:calc(env(safe-area-inset-top,0px)+8px);z-index:90;background:#2a1d1d;color:#ffdede;border:1px solid #ff6b6b;border-radius:10px;padding:10px 36px 10px 12px;font-weight:700;display:none}
.toast .x{position:absolute;right:8px;top:6px;background:transparent;border:none;color:#ffdede;font-weight:900;cursor:pointer}
.leaflet-container{background:transparent}.leaflet-control-attribution{filter:drop-shadow(0 6px 12px rgba(0,0,0,.35))}
.divider{height:1px;background:var(--line2);margin:4px 0}
.small{font-size:12px;color:var(--muted)}
</style>
</head>
<body>
<div class="app">
  <div class="top">
    <div class="brand">AP Alignment</div>
    <div class="alignbar"><div id="needle" class="needle"></div><div class="txt" id="alignTxt">‚Äî</div></div>
    <button id="btnSettings" class="btn" title="Settings">‚öôÔ∏é</button>
    <button id="btnWP" class="btn" title="Waypoints & Routes">‚åñ</button>
  </div>

  <div class="stage">
    <div class="minimap">
      <div class="mapwrap">
        <div id="map" aria-label="Map"></div>
        <div class="modechip" role="tablist" aria-label="Map orientation mode">
          <button id="mNorth" role="tab" aria-selected="false">North-Up</button>
          <button id="mTrack" role="tab" aria-selected="true" class="on">Track-Up</button>
        </div>
        <button id="btnQuick" class="btn quick" title="Save map center">Ôºã</button>
        <div id="pingPool" aria-hidden="true"></div>
        <div id="edgePool" aria-hidden="true"></div>
      </div>
      <div class="radar" aria-hidden="true"></div><div class="radar2" aria-hidden="true"></div>
      <div class="cardinals" aria-hidden="true"><span class="N">N</span><span class="S">S</span><span class="E">E</span><span class="W">W</span></div>
      <div class="ray" id="ray" aria-hidden="true"><div class="arm"></div></div>
      <div class="sweep" aria-hidden="true"></div>

      <div class="ringctrl" id="ring" aria-hidden="false">
        <div class="rc" style="--a:-45deg"><button id="bGPS" class="btn icon" title="GPS + Compass (L)">üì°</button></div>
        <div class="rc" style="--a:45deg"><button id="bRotate" class="btn icon on" title="Toggle mode + Compass (R)">üß≠</button></div>
        <div class="rc" style="--a:135deg"><button id="bFollow" class="btn icon on" title="Follow (F)">üéØ</button></div>
        <div class="rc" style="--a:-135deg"><button id="bReset" class="btn icon" title="Reset / Clear (C)">‚Ü∫</button></div>
      </div>
    </div>
  </div>

  <div class="hud">
    <div class="stat"><span class="k">LAT</span><span id="hLat" class="v">‚Äî</span><span class="k">LNG</span><span id="hLng" class="v">‚Äî</span><span class="k">ACC</span><span id="hAcc" class="v">‚Äî m</span></div>
    <div class="stat" style="justify-self:end"><span class="k">HEAD</span><span id="hHead" class="v">‚Äî¬∞</span><span class="k">MAP</span><span id="hMap" class="v">‚Äî¬∞</span><span class="k">DEST</span><span id="hDest" class="v">‚Äî</span><div id="lock" class="chip" style="display:none;margin-left:8px">Pan Locked</div></div>
  </div>
</div>

<!-- Settings -->
<div id="sheetSettings" class="sheet" aria-hidden="true">
  <h3>Settings</h3>
  <div class="row"><div class="inline">
    <label><input type="checkbox" id="invertAndroid"/> Invert Android heading</label>
    <label><input type="checkbox" id="autoStart"/> Auto-start GPS & Compass</label>
    <label><input type="checkbox" id="edgeOffOnly" checked/> Edge pucks only when off-circle</label>
  </div></div>
  <div class="row">
    <label>Declination</label>
    <input id="decl" type="range" min="-30" max="30" step="0.1" class="input" aria-label="Declination"/>
    <div class="inline">True = Magnetic + <b id="declVal">0.0¬∞</b><button id="declSave" class="btn" style="margin-left:auto">Save</button></div>
  </div>
  <div class="row" style="text-align:right"><button id="sClose" class="btn">Close</button></div>
</div>

<!-- Waypoints + Routes -->
<div id="sheetWP" class="sheet" aria-hidden="true">
  <h3>Waypoints</h3>
  <div class="row">
    <div class="inline" style="width:100%">
      <input id="wpName" class="input" placeholder="Name (optional)"/>
      <input id="wpCoords" class="input" placeholder="34.851939,-119.168399  or  34.851939 N, 119.168399 W"/>
      <button id="wpAdd" class="btn">Add / Update</button>
      <button id="wpCenter" class="btn">Use Map Center</button>
      <button id="wpHere" class="btn">Use My Location</button>
    </div>
  </div>
  <div id="wpList" class="row" style="max-height:32vh;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:6px"></div>

  <div class="divider"></div>
  <h3>Routes</h3>
  <div class="row">
    <div class="inline" style="width:100%">
      <input id="routeName" class="input" placeholder="New route name"/>
      <button id="routeNew" class="btn">New</button>
      <input id="routeImport" type="file" accept=".gpx,.geojson,.json" style="margin-left:auto"/>
      <button id="routeExportGeo" class="btn">Export GeoJSON</button>
      <button id="routeExportGpx" class="btn">Export GPX</button>
    </div>
    <div class="small">Tip: use ‚ÄúAppend‚Äù on a waypoint or pin to add to the active route.</div>
  </div>
  <div id="routeList" class="row" style="max-height:26vh;overflow:auto;border:1px solid var(--line);border-radius:12px;padding:6px"></div>

  <div class="row" style="text-align:right"><button id="wClose" class="btn">Close</button></div>
</div>

<div id="toast" class="toast" role="alert"><button id="tx" class="x" aria-label="Close">√ó</button><span id="tmsg"></span></div>

<script>
'use strict';
(function(){
  const $=id=>document.getElementById(id);
  const ready=fn=>{ if(document.readyState!=='loading') fn(); else document.addEventListener('DOMContentLoaded',fn,{once:true}); };
  const R=d=>d*Math.PI/180, Dg=r=>r*180/Math.PI, N=d=>((d%360)+360)%360;
  const Œî=(a,b)=>{let d=N(b)-N(a); if(d>180)d-=360; else if(d<-180)d+=360; return d;};
  const blend=(p,n,a)=>p==null?n:N(p+a*Œî(p,n));
  const fix=v=>Number(v).toFixed(6); const clamp=(x,a,b)=>Math.min(b,Math.max(a,x));
  const fmtDist=m=>(m<1000?Math.round(m)+' m':(m/1000).toFixed(2)+' km');
  const haversine=(a,b)=>{const Rm=6371000,œÜ1=R(a.lat),œÜ2=R(b.lat),dœÜ=R(b.lat-a.lat),dŒª=R(b.lng-a.lng);const s=Math.sin(dœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(dŒª/2)**2;return 2*Rm*Math.asin(Math.min(1,Math.sqrt(s)));};
  const bearing=(a,b)=>{const œÜ1=R(a.lat),œÜ2=R(b.lat),Œª1=R(a.lng),Œª2=R(b.lng);const y=Math.sin(Œª2-Œª1)*Math.cos(œÜ2);const x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(Œª2-Œª1);return N(Dg(Math.atan2(y,x)));};
  const DotIcon=s=>L.divIcon({className:'ping',iconSize:[s,s],iconAnchor:[s/2,s/2]});
  const makeDot=(lat,lng,s=9)=>L.marker([lat,lng],{icon:DotIcon(s),riseOnHover:true});
  const screenAngle=()=> (screen&&screen.orientation&&typeof screen.orientation.angle==='number')?screen.orientation.angle:(typeof window.orientation==='number'?(window.orientation%360+360)%360:0);
  const isAndroid=()=>/Android/i.test(navigator.userAgent||'')||/\bAdr\b/i.test(navigator.userAgent||'');
  const idify=s=>('edge-'+String(s||'').toLowerCase().trim().replace(/[^a-z0-9_-]+/g,'-')).slice(0,64);
  const throttle=(fn,ms)=>{let t=0,raf=false,args=null;return function(...a){args=a;const now=performance.now();if(now-t>=ms){t=now;fn.apply(this,args);args=null;}else if(!raf){raf=true;requestAnimationFrame(()=>{raf=false;const now2=performance.now();if(now2-t>=ms&&args){t=now2;fn.apply(this,args);args=null;}});} } };
  const toast=m=>{const t=$('toast'),s=$('tmsg'); if(!t||!s){alert(m);return;} s.textContent=m; t.style.display='block'; setTimeout(()=>t.style.display='none',2500);}; $('tx')?.addEventListener('click',()=>$('toast').style.display='none');

  const Store={
    k:'orient.v2', kOld:'orient.v1', w:'wps.v3', rk:'routes.v1',
    load(){try{const v2=JSON.parse(localStorage.getItem(this.k)||'{}'); if(Object.keys(v2).length) return v2; const v1=JSON.parse(localStorage.getItem(this.kOld)||'{}'); return v1;}catch{return{}}},
    save(s){try{localStorage.setItem(this.k,JSON.stringify(s))}catch{}},
    lw(){try{return JSON.parse(localStorage.getItem(this.w)||'[]')}catch{return[]}},
    sw(a){try{localStorage.setItem(this.w,JSON.stringify(a))}catch{} },
    lr(){try{return JSON.parse(localStorage.getItem(this.rk)||'[]')}catch{return[]}},
    sr(a){try{localStorage.setItem(this.rk,JSON.stringify(a))}catch{} }
  };

  const App={
    mode:'trackUp',
    S:{follow:true,rotate:true,decl:0,heading:null,mapBearing:0,compass:false,edgeOffOnly:true,autostart:false,invertAndroid:false},
    DEF:{lat:34.9,lng:-119.17,z:16},
    map:null,last:null,acc:null,ray:null,origin:null,nav:null,
    _warmTs:null,DEAD:0.5,MAX:5,_tHUD:0,_gps:null,_panned:false,
    init(){
      const s=Store.load(); Object.assign(this.S,{
        follow: s.follow ?? true, rotate: s.rotate ?? true, decl: s.decl ?? 0,
        edgeOffOnly: s.edgeOffOnly ?? true, autostart: s.autostart ?? false, invertAndroid: s.invertAndroid ?? false
      }); if(s.mode) this.mode=s.mode;

      this.map=L.map('map',{zoomControl:false,attributionControl:true,inertia:true});
      const topo=L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Topo_Map/MapServer/tile/{z}/{y}/{x}',{maxZoom:19,attribution:'Tiles ¬© Esri, USGS, NPS'});
      const otm=L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png',{maxZoom:17,attribution:'¬© OpenTopoMap, ¬© OSM'});
      topo.addTo(this.map).on('tileerror',()=>otm.addTo(this.map));
      this.map.setView([this.DEF.lat,this.DEF.lng],this.DEF.z);
      this.acc=L.circle([this.DEF.lat,this.DEF.lng],{radius:0,color:'#4df8ff',weight:1,opacity:.6,fillOpacity:.08}).addTo(this.map);

      this.bind();
      this.loop();
      if(this.S.autostart){ this.startGPS(); this.enableCompass(); }
      setTimeout(()=>this.map.invalidateSize(),80);
      addEventListener('beforeunload',()=>this.cleanup(),{once:true});
    },
    bind(){
      const open=(el,b)=>{ el.classList.toggle('open',b); el.setAttribute('aria-hidden',String(!b)); };

      $('btnSettings').onclick=()=>open($('sheetSettings'),true);
      $('sClose').onclick=()=>open($('sheetSettings'),false);
      $('btnWP').onclick=()=>{ WP.render(); Routes.render(); open($('sheetWP'),true); };
      $('wClose').onclick=()=>open($('sheetWP'),false);

      $('decl').oninput=()=>{ const v=parseFloat($('decl').value)||0; this.S.decl=v; $('declVal').textContent=v.toFixed(1)+'¬∞'; };
      $('declSave').onclick=()=>{ this.persist(); $('declSave').textContent='Saved ‚úì'; setTimeout(()=>$('declSave').textContent='Save',900); };
      $('edgeOffOnly').onchange=e=>{ this.S.edgeOffOnly=e.target.checked; this.persist(); UI.updateEdges(); };
      $('autoStart').onchange=e=>{ this.S.autostart=e.target.checked; this.persist(); };
      $('invertAndroid').onchange=e=>{ this.S.invertAndroid=e.target.checked; this.persist(); };

      const setNorth=()=>{ this.mode='northUp'; $('mNorth').classList.add('on'); $('mNorth').setAttribute('aria-selected','true'); $('mTrack').classList.remove('on'); $('mTrack').setAttribute('aria-selected','false'); this.applyMapBearing(0,true); this.enableCompass(); this.persist(); };
      const setTrack=()=>{ this.mode='trackUp'; $('mTrack').classList.add('on'); $('mTrack').setAttribute('aria-selected','true'); $('mNorth').classList.remove('on'); $('mNorth').setAttribute('aria-selected','false'); this.enableCompass(); this.persist(); };
      $('mNorth').onclick=setNorth; $('mTrack').onclick=setTrack;

      $('bGPS').onclick=()=>{ this.startGPS(); this.enableCompass(); };
      $('bRotate').onclick=()=>{ if(this.mode==='trackUp') setNorth(); else setTrack(); };
      $('bFollow').onclick=()=>this.toggleFollow();
      $('bReset').onclick=()=>this.reset();

      $('btnQuick').onclick=()=>WP.addCenter(($('wpName').value||'').trim());

      $('wpAdd').onclick=()=>WP.addFromInputs();
      $('wpCenter').onclick=()=>WP.addCenter();
      $('wpHere').onclick=()=>WP.addHere(this.last);
      $('wpList').addEventListener('click',WP.onListClick);

      // Routes UI
      $('routeNew').onclick=()=>Routes.new(($('routeName').value||'').trim());
      $('routeExportGeo').onclick=()=>Routes.exportGeoJSON();
      $('routeExportGpx').onclick=()=>Routes.exportGPX();
      $('routeImport').addEventListener('change',Routes.importFile);

      const wrap=document.querySelector('.mapwrap'); let t=0;
      wrap.addEventListener('pointerdown',e=>{ const now=performance.now(); if(now-t<350 && this.last){ this._panned=false; $('lock').style.display='none'; this.centerOnUser(true);} t=now; },{passive:true});

      (()=>{ let timer=null,start=null;
        const begin=e=>{ start={x:e.clientX,y:e.clientY}; timer=setTimeout(()=>{ timer=null;
          const r=wrap.getBoundingClientRect(); const pt=L.point(e.clientX-r.left,e.clientY-r.top);
          const ll=this.map.containerPointToLatLng(pt); Pin.drop(ll.lat,ll.lng); UI.pingLL(ll,true);
        },420); };
        const move=e=>{ if(!timer||!start) return; if(Math.hypot(e.clientX-start.x,e.clientY-start.y)>8){ clearTimeout(timer); timer=null; } };
        const end=()=>{ if(timer){ clearTimeout(timer); timer=null; } };
        wrap.addEventListener('pointerdown',begin,{passive:true});
        wrap.addEventListener('pointermove',move,{passive:true});
        wrap.addEventListener('pointerup',end,{passive:true});
        wrap.addEventListener('pointercancel',end,{passive:true});
        wrap.addEventListener('pointerleave',end,{passive:true});
      })();

      const lock=$('lock'); const showLock=v=>{ lock.style.display=v?'inline-flex':'none'; lock.classList.toggle('lock',v); };
      this.map.on('movestart',()=>{ this._panned=true; showLock(true); });
      this.map.on('moveend',()=>{ if(this.S.follow && this.last && !this._panned) this.centerOnUser(false); });

      const onViewChange=throttle(()=>{ this.applyMapBearing(this.S.mapBearing,false); UI.updateEdges(); this.refreshRay(); Routes.redrawAll(); },80);
      this.map.on('move zoom zoomend',onViewChange);
      addEventListener('resize',onViewChange,{passive:true});

      addEventListener('deviceorientationabsolute',e=>this.onOrient(e),true);
      addEventListener('deviceorientation',e=>this.onOrient(e),true);

      addEventListener('keydown',e=>{
        if(/INPUT|TEXTAREA/.test(e.target.tagName)) return;
        const k=(e.key||'').toLowerCase();
        if(k==='l'){ this.startGPS(); this.enableCompass(); }
        else if(k==='r'){ if(this.mode==='trackUp') $('mNorth').click(); else $('mTrack').click(); }
        else if(k==='f') this.toggleFollow();
        else if(k==='c') this.reset();
      });
    },
    persist(){ Store.save({follow:this.S.follow,rotate:this.S.rotate,decl:this.S.decl,edgeOffOnly:this.S.edgeOffOnly,autostart:this.S.autostart,mode:this.mode,invertAndroid:this.S.invertAndroid}); },
    centerOnUser(anim){ const {latitude,longitude}=this.last.coords; this.map.setView([latitude,longitude],Math.max(this.map.getZoom(),16),{animate:!!anim}); },
    toggleFollow(){ this.S.follow=!this.S.follow; $('bFollow').classList.toggle('on',this.S.follow); if(this.S.follow&&this.last){ this._panned=false; $('lock').style.display='none'; this.centerOnUser(false); } this.persist(); },

    computeHeading(e){
      let h=null;
      if(typeof e.webkitCompassHeading==='number' && Number.isFinite(e.webkitCompassHeading)) h=e.webkitCompassHeading;
      else if(typeof e.alpha==='number' && Number.isFinite(e.alpha)){ h=(360 - e.alpha + screenAngle())%360; }
      if(h==null) return null;
      if(isAndroid() && this.S.invertAndroid) h=(360-h)%360; /* why: some Androids invert Œ± */
      h=(h + (this.S.decl||0))%360; if(h<0) h+=360; return h;
    },
    onOrient(e){
      const h=this.computeHeading(e); if(h==null) return;
      if(this.S.heading==null){ this.S.heading=h; this._warmTs=performance.now(); return; }
      const diff=((h - this.S.heading + 540)%360)-180;
      if(Math.abs(diff)>=this.DEAD) this.S.heading=(this.S.heading + Math.sign(diff)*Math.min(Math.abs(diff),this.MAX) + 360)%360;
    },
    applyMapBearing(b,force){
      const pane=this.map.getPane('mapPane'); if(!pane) return;
      let origin='50% 50%';
      if(this.last){ const p=this.map.latLngToContainerPoint([this.last.coords.latitude,this.last.coords.longitude]); origin=`${p.x}px ${p.y}px`; }
      const base=(pane.style.transform||'').replace(/rotate\([^)]*\)/g,'');
      pane.style.transformOrigin=origin; pane.style.transform=base+` rotate(${-b}deg)`;
      const rot=` rotate(${b}deg)`;
      const fixEl=el=>{ const base=(el.style.transform||'').replace(/rotate\([^)]*\)/g,''); el.style.transformOrigin='left center'; el.style.transform=base+rot; };
      this.map.getPanes().popupPane?.querySelectorAll('.leaflet-popup').forEach(fixEl);
      this.map.getPanes().tooltipPane?.querySelectorAll('.leaflet-tooltip').forEach(fixEl);
      if(force) this.refreshRay();
    },
    refreshRay(){
      if(!this.last) return;
      const originLL=L.latLng(this.last.coords.latitude,this.last.coords.longitude);
      if(!this.origin) this.origin=L.circleMarker(originLL,{radius:3,color:'#20d7b7',weight:2,fillColor:'#20d7b7',fillOpacity:1,interactive:false}).addTo(this.map);
      else this.origin.setLatLng(originLL).bringToFront();

      if(this.S.heading==null) return;
      const len=(()=>{ const s=this.map.getSize(); const a=this.map.containerPointToLatLng(L.point(s.x/2,s.y/2)); const b=this.map.containerPointToLatLng(L.point(s.x/2+1,s.y/2)); const m=this.map.distance(a,b)||1; return Math.max(Math.hypot(s.x,s.y)*m*1.35+200,3000); })();
      const dest=(ll,brg,dm)=>{const br=R(brg),dr=dm/6371000,lat1=R(ll.lat),lon1=R(ll.lng);const lat2=Math.asin(Math.sin(lat1)*Math.cos(dr)+Math.cos(lat1)*Math.sin(dr)*Math.cos(br));const lon2=lon1+Math.atan2(Math.sin(br)*Math.sin(dr)*Math.cos(lat1),Math.cos(dr)-Math.sin(lat1)*Math.sin(lat2));return L.latLng(Dg(lat2),Dg(lon2));};
      if(!this.ray) this.ray=L.polyline([], {color:'#20d7b7',weight:3,opacity:.95,interactive:false}).addTo(this.map);
      this.ray.setLatLngs([originLL, dest(originLL,this.S.heading,len)]).bringToFront();

      const arm=$('ray')?.querySelector('.arm'); if(arm){ const visual = (this.mode==='trackUp') ? this.S.mapBearing : this.S.heading; arm.style.transform=`translate(-50%,-100%) rotate(${-visual}deg)`; }
    },
    updateHUD(){
      const now=performance.now(); if(now-this._tHUD<120) return; this._tHUD=now;
      $('hLat').textContent=this.last?.coords?.latitude?.toFixed(6) ?? '‚Äî';
      $('hLng').textContent=this.last?.coords?.longitude?.toFixed(6) ?? '‚Äî';
      $('hAcc').textContent=(this.last?.coords?.accuracy?Math.round(this.last.coords.accuracy):'‚Äî')+' m';
      $('hHead').textContent=this.S.heading!=null?this.S.heading.toFixed(1)+'¬∞':'‚Äî¬∞';
      $('hMap').textContent=N(-this.S.mapBearing).toFixed(1)+'¬∞';
      if(this.S.dest && this.last){
        const from=L.latLng(this.last.coords.latitude,this.last.coords.longitude);
        const to=L.latLng(this.S.dest.lat,this.S.dest.lng);
        const br=bearing(from,to), d=haversine(from,to);
        const steer=(this.S.heading!=null)?Œî(this.S.heading,br).toFixed(1):'‚Äî';
        $('hDest').textContent=`${this.S.dest.name||'Dest'}  ${fmtDist(d)}  brg ${br.toFixed(1)}¬∞  Œî ${steer}¬∞`;
      } else $('hDest').textContent='‚Äî';
    },
    checkAlignment(){
      if(!this.last || this.S.heading==null) { $('needle').style.setProperty('--err','0deg'); $('alignTxt').textContent='‚Äî'; return; }
      const from=L.latLng(this.last.coords.latitude,this.last.coords.longitude);
      const cand=UI.candidates();
      if(!cand.length){ $('needle').style.setProperty('--err','0deg'); $('alignTxt').textContent='‚Äî'; return; }
      let best=null, bestErr=Infinity, bestDist=Infinity;
      for(const c of cand){ const br=bearing(from,c.ll); const err=Math.abs(Œî(this.S.heading,br)); const dist=haversine(from,c.ll);
        if(err<bestErr-1e-6 || (Math.abs(err-bestErr)<1e-6 && dist<bestDist)){ best={...c,br}, bestErr=err, bestDist=dist; } }
      $('needle').style.setProperty('--err', clamp(Œî(this.S.heading,best.br),-45,45)+'deg');
      $('alignTxt').textContent=best.name;
    },
    startGPS(){
      if(!('geolocation' in navigator)){ toast('Geolocation not supported.'); return; }
      if(this._gps!=null) return;
      this._gps=navigator.geolocation.watchPosition(p=>{
        this.last=p; this.acc.setLatLng([p.coords.latitude,p.coords.longitude]).setRadius(Math.max(p.coords.accuracy||0,0));
        if(this.S.follow) { this._panned=false; $('lock').style.display='none'; this.centerOnUser(false); }
      },err=>toast('GPS error: '+err.message),{enableHighAccuracy:true,maximumAge:2000,timeout:15000});
    },
    enableCompass(){
      if(this.S.compass) return true;
      if(location.protocol!=='https:' && location.hostname!=='localhost'){ toast('Compass requires HTTPS.'); return false; }
      if(typeof DeviceOrientationEvent!=='undefined' && typeof DeviceOrientationEvent.requestPermission==='function'){
        DeviceOrientationEvent.requestPermission().then(p=>{ if(p==='granted') this.S.compass=true; else toast('Compass permission denied.'); });
      } else { this.S.compass=true; }
      return this.S.compass;
    },
    reset(){
      if(this.S.dest){ this.S.dest=null; UI.updateEdges(); if(this.nav) this.nav.setLatLngs([]); $('hDest').textContent='‚Äî'; return; }
      if(this.last) this.centerOnUser(true); else this.map.setView([this.DEF.lat,this.DEF.lng],this.DEF.z);
    },
    loop(){
      const tgt = (this.mode==='trackUp' && this.S.heading!=null) ? this.S.heading : 0;
      const err=Math.abs(Œî(this.S.mapBearing,tgt));
      const a=0.15;
      this.S.mapBearing = err<0.08 ? this.S.mapBearing : blend(this.S.mapBearing,tgt,a);
      this.applyMapBearing(this.S.mapBearing,false);
      this.refreshRay();

      if(this.S.dest && this.last){
        const from=L.latLng(this.last.coords.latitude,this.last.coords.longitude);
        const to=L.latLng(this.S.dest.lat,this.S.dest.lng);
        if(!this.nav) this.nav=L.polyline([from,to],{color:'#2ac18a',weight:3,opacity:.95,dashArray:'6 6'}).addTo(this.map);
        this.nav.setLatLngs([from,to]).bringToFront();
      }
      this.updateHUD();
      this.checkAlignment();
      UI.updateEdgesThrottled();
      requestAnimationFrame(()=>this.loop());
    },
    cleanup(){
      try{ if(this._gps!=null){ navigator.geolocation.clearWatch(this._gps); this._gps=null; } }catch{}
    }
  };

  const UI={
    candidates(){
      const list=[]; WP.markers.forEach((m,name)=>list.push({name,ll:m.getLatLng()}));
      if(Pin.pin){ const ll=Pin.pin.getLatLng(); list.push({name:Pin.pin._nm||`Pin ${fix(ll.lat)},${fix(ll.lng)}`, ll}); }
      return list;
    },
    updateEdges(){
      if(!App.last) return;
      const root=$('edgePool'); const wrap=document.querySelector('.mapwrap'); const rect=wrap.getBoundingClientRect();
      const radius=Math.min(rect.width,rect.height)/2; const center=App.map.latLngToContainerPoint([App.last.coords.latitude,App.last.coords.longitude]);
      const live=new Set();
      this.candidates().forEach(c=>{
        const from=L.latLng(App.last.coords.latitude,App.last.coords.longitude);
        const pt=App.map.latLngToContainerPoint(c.ll);
        const dx=pt.x-center.x, dy=pt.y-center.y; const distPx=Math.hypot(dx,dy);
        const br=bearing(from,c.ll), dist=haversine(from,c.ll);
        const outside = distPx > radius*0.9;
        const safeId=idify(c.name);
        if(App.S.edgeOffOnly && !outside){ const rm=$(safeId); rm&&rm.remove(); return; }
        const angle=R(br - App.S.mapBearing);
        const x=center.x + Math.cos(angle)*radius*0.95, y=center.y + Math.sin(angle)*radius*0.95;
        let el=$(safeId);
        if(!el){
          el=document.createElement('div'); el.id=safeId; el.className='edge';
          el.addEventListener('pointerdown',()=>{ const t=setTimeout(()=>{ App.S.dest={lat:c.ll.lat,lng:c.ll.lng,name:c.name}; },420);
            const cancel=()=>{ clearTimeout(t); el.removeEventListener('pointerup',cancel); el.removeEventListener('pointerleave',cancel); };
            el.addEventListener('pointerup',cancel,{once:true}); el.addEventListener('pointerleave',cancel,{once:true});});
          root.appendChild(el);
        }
        el.textContent=`${c.name} ‚Ä¢ ${dist<1000?Math.round(dist)+'m':(dist/1000).toFixed(1)+'km'}`;
        el.style.left=x+'px'; el.style.top=y+'px';
        live.add(safeId);
      });
      Array.from(root.children).forEach(ch=>{ if(!live.has(ch.id)) ch.remove(); });
    },
    updateEdgesThrottled: throttle(function(){ UI.updateEdges(); },120),
    pingLL(ll,strong){ try{ const pt=App.map.latLngToContainerPoint(ll); Ping.flash(pt.x,pt.y,strong); }catch{} }
  };

  const Ping=(()=>{ const pool=[]; const root=$('pingPool'); const get=()=>{ const f=pool.find(p=>!p.busy); if(f) return f; const el=document.createElement('div'); el.className='ping'; root.appendChild(el); const it={el,busy:false}; pool.push(it); return it; }; return{flash(x,y,strong){ const it=get(); it.busy=true; const el=it.el; el.style.left=x+'px'; el.style.top=y+'px'; el.classList.add('show'); el.classList.remove('flash'); void el.offsetWidth; el.classList.add('flash'); setTimeout(()=>{ el.classList.remove('show'); it.busy=false; }, strong?750:600); }}})();

  const WP={
    markers:new Map(),
    list(){ return Store.lw(); }, save(a){ Store.sw(a); },
    onListClick(e){
      const t=e.target, i=+t.getAttribute('data-i'); if(Number.isNaN(i)) return;
      if(t.hasAttribute('data-go')) WP.go(i);
      else if(t.hasAttribute('data-guide')) WP.guide(i);
      else if(t.hasAttribute('data-append')) WP.appendToRoute(i);
      else if(t.hasAttribute('data-edit')) WP.edit(i);
      else if(t.hasAttribute('data-save')) WP.saveEdit(i);
      else if(t.hasAttribute('data-del')) WP.del(i);
      else if(t.hasAttribute('data-cancel')) WP.render();
    },
    render(){
      const el=$('wpList'); el.innerHTML='';
      WP.list().forEach((w,i)=>{
        const row=document.createElement('div');
        row.style.display='grid'; row.style.gridTemplateColumns='1fr auto auto auto auto auto'; row.style.gap='6px'; row.style.alignItems='center'; row.style.padding='6px'; row.style.borderBottom='1px solid var(--line)';
        const left=document.createElement('div');
        const b=document.createElement('b'); b.textContent=w.name;
        const small=document.createElement('small'); small.style.color='var(--muted)'; small.textContent=`${w.lat.toFixed(6)}, ${w.lng.toFixed(6)}`;
        left.appendChild(b); left.appendChild(document.createElement('br')); left.appendChild(small);
        const mkBtn=(txt,attr)=>{ const btn=document.createElement('button'); btn.className='btn'; btn.textContent=txt; btn.setAttribute('data-i',String(i)); btn.setAttribute(attr,''); return btn; };
        row.appendChild(left);
        row.appendChild(mkBtn('Go','data-go'));
        row.appendChild(mkBtn('Guide','data-guide'));
        row.appendChild(mkBtn('Append','data-append')); // append to active route
        row.appendChild(mkBtn('Edit','data-edit'));
        row.appendChild(mkBtn('Del','data-del'));
        el.appendChild(row);
      });
      UI.updateEdges(); WP.syncMarkers();
    },
    addFromInputs(){
      const nm=($('wpName').value||'').trim(); const txt=($('wpCoords').value||'').trim();
      if(!txt){ WP.addCenter(nm); return; }
      const p=parseCoords(txt); if(!p){ toast('Could not parse coordinates.'); return; }
      WP.upsert(nm,p.lat,p.lng); $('wpName').value=''; $('wpCoords').value='';
    },
    addCenter(name){
      const ll=App.map.getCenter(); WP.upsert((name||$('wpName').value||'').trim(), ll.lat, ll.lng); $('wpName').value=''; $('wpCoords').value='';
    },
    addHere(last){
      if(!last){ toast('No GPS fix yet.'); return; }
      WP.upsert(($('wpName').value||'').trim(), last.coords.latitude, last.coords.longitude); $('wpName').value=''; $('wpCoords').value='';
    },
    upsert(name,lat,lng){
      const a=WP.list(); const nm=(name||`WP ${Date.now().toString().slice(-5)}`).slice(0,48);
      const ix=a.findIndex(w=>w.name.toLowerCase()===nm.toLowerCase());
      const e={name:nm,lat,lng}; if(ix>=0)a[ix]=e; else a.push(e); WP.save(a); WP.render();
    },
    go(i){ const w=WP.list()[i]; if(!w) return; App.S.follow=false; $('bFollow').classList.remove('on'); App.map.setView([w.lat,w.lng],16); const m=WP.ensure(w.name); m&&m.openPopup(); App.persist(); },
    guide(i){ const w=WP.list()[i]; if(!w) return; App.S.dest={lat:w.lat,lng:w.lng,name:w.name}; },
    appendToRoute(i){ const w=WP.list()[i]; if(!w) return; if(Routes.activeIndex<0){ toast('Create/select a route first.'); return; } Routes.appendPoint(Routes.activeIndex,{lat:w.lat,lng:w.lng,name:w.name}); toast(`Appended ${w.name} to ${Routes.list()[Routes.activeIndex].name}`); },
    edit(i){
      const a=WP.list(); const w=a[i]; const el=$('wpList').children[i];
      el.innerHTML='';
      const wrap=document.createElement('div'); wrap.style.display='grid'; wrap.style.gap='6px';
      const nameI=document.createElement('input'); nameI.className='input'; nameI.value=w.name; nameI.setAttribute('data-n',''); wrap.appendChild(nameI);
      const grid=document.createElement('div'); grid.style.display='grid'; grid.style.gridTemplateColumns='1fr 1fr'; grid.style.gap='6px';
      const latI=document.createElement('input'); latI.className='input'; latI.value=w.lat.toFixed(6); latI.setAttribute('data-la','');
      const lngI=document.createElement('input'); lngI.className='input'; lngI.value=w.lng.toFixed(6); lngI.setAttribute('data-lo','');
      grid.appendChild(latI); grid.appendChild(lngI); wrap.appendChild(grid);
      const save=document.createElement('button'); save.className='btn'; save.textContent='Save'; save.setAttribute('data-i',String(i)); save.setAttribute('data-save','');
      const cancel=document.createElement('button'); cancel.className='btn'; cancel.textContent='Cancel'; cancel.setAttribute('data-cancel','');
      el.appendChild(wrap); el.appendChild(save); el.appendChild(cancel);
    },
    saveEdit(i){
      const a=WP.list(); const el=$('wpList').children[i];
      const nm=(el.querySelector('[data-n]').value||'').trim()||a[i].name;
      const lat=parseFloat(el.querySelector('[data-la]').value);
      const lng=parseFloat(el.querySelector('[data-lo]').value);
      if(!Number.isFinite(lat)||!Number.isFinite(lng)||Math.abs(lat)>90||Math.abs(lng)>180) { toast('Invalid coordinates.'); return; }
      a[i]={name:nm.slice(0,48),lat,lng}; WP.save(a); WP.render();
    },
    del(i){
      const a=WP.list(); const [rm]=a.splice(i,1); WP.save(a); WP.render();
      if(rm && WP.markers.has(rm.name)){ App.map.removeLayer(WP.markers.get(rm.name)); WP.markers.delete(rm.name); }
    },
    ensure(name){ return WP.markers.get(name)||null; },
    syncMarkers(){
      const a=WP.list();
      a.forEach(w=>{
        if(!WP.markers.has(w.name)){
          const m=makeDot(w.lat,w.lng,9).addTo(App.map);
          bindMarker(m,{name:w.name,lat:w.lat,lng:w.lng});
          WP.markers.set(w.name,m);
        } else {
          const m=WP.markers.get(w.name);
          m.setLatLng([w.lat,w.lng]);
          bindMarker(m,{name:w.name,lat:w.lat,lng:w.lng});
        }
      });
      Array.from(WP.markers.keys()).forEach(n=>{ if(!WP.list().some(w=>w.name===n)){ App.map.removeLayer(WP.markers.get(n)); WP.markers.delete(n); } });
    }
  };

  const Routes={
    _routes: Store.lr(),
    lines: new Map(), // idx -> L.Polyline
    activeIndex: -1,
    list(){ return this._routes; },
    save(){ Store.sr(this._routes); },
    new(name){
      const nm = (name||`Route ${this._routes.length+1}`).slice(0,60);
      this._routes.push({name:nm, points:[], show:true});
      this.activeIndex=this._routes.length-1;
      this.save(); this.render(); this.redrawAll(); toast(`Created & selected ${nm}`);
    },
    delete(i){
      const r=this._routes[i]; if(!r) return;
      if(this.lines.has(i)){ App.map.removeLayer(this.lines.get(i)); this.lines.delete(i); }
      this._routes.splice(i,1);
      // reindex polylines map
      const newMap=new Map(); Array.from(this.lines.entries()).forEach(([idx,pl])=>{ if(idx>i){ newMap.set(idx-1,pl);} else if(idx<i){ newMap.set(idx,pl);} });
      this.lines=newMap;
      if(this.activeIndex===i) this.activeIndex=-1; else if(this.activeIndex>i) this.activeIndex--;
      this.save(); this.render(); this.redrawAll();
    },
    setActive(i){ if(i<0||i>=this._routes.length) { this.activeIndex=-1; } else { this.activeIndex=i; } this.render(); this.redrawAll(); },
    toggleShow(i){ const r=this._routes[i]; if(!r) return; r.show=!r.show; this.save(); this.render(); this.redrawAll(); },
    appendPoint(i,{lat,lng,name}){
      const r=this._routes[i]; if(!r) return;
      r.points.push({lat,lng,name:name||`P${r.points.length+1}`});
      this.save(); this.draw(i,true);
    },
    draw(i,bring){
      const r=this._routes[i]; if(!r) return;
      if(!r.show){ if(this.lines.has(i)){ App.map.removeLayer(this.lines.get(i)); this.lines.delete(i);} return; }
      const latlngs=r.points.map(p=>L.latLng(p.lat,p.lng));
      let pl=this.lines.get(i);
      if(!pl){
        pl=L.polyline(latlngs,{weight:(i===this.activeIndex)?4:3,opacity:(i===this.activeIndex)?1:.65,color:(i===this.activeIndex)?'#ffd166':'#a0e3d2',dashArray:(i===this.activeIndex)?null:'6 6'}).addTo(App.map);
        this.lines.set(i,pl);
      }else{
        pl.setLatLngs(latlngs);
        pl.setStyle({weight:(i===this.activeIndex)?4:3,opacity:(i===this.activeIndex)?1:.65,color:(i===this.activeIndex)?'#ffd166':'#a0e3d2',dashArray:(i===this.activeIndex)?null:'6 6'});
      }
      if(bring) pl.bringToFront();
    },
    redrawAll(){ this._routes.forEach((_,i)=>this.draw(i,false)); },
    render(){
      const host=$('routeList'); host.innerHTML='';
      this._routes.forEach((r,i)=>{
        const row=document.createElement('div');
        row.style.display='grid'; row.style.gridTemplateColumns='1fr auto auto auto'; row.style.gap='6px'; row.style.alignItems='center'; row.style.padding='6px'; row.style.borderBottom='1px solid var(--line)';
        const left=document.createElement('div');
        const b=document.createElement('b'); b.textContent=r.name+(i===this.activeIndex?' ‚Ä¢ active':''); left.appendChild(b);
        const small=document.createElement('div'); small.className='small'; small.textContent=`${r.points.length} point(s) ‚Ä¢ ${r.show?'visible':'hidden'}`; left.appendChild(small);
        const mk=(txt,attr)=>{ const btn=document.createElement('button'); btn.className='btn'; btn.textContent=txt; btn.setAttribute(attr,''); btn.setAttribute('data-i',String(i)); return btn; };
        const sel=mk('Select','data-sel'); const vis=mk(r.show?'Hide':'Show','data-vis'); const del=mk('Del','data-del');
        row.appendChild(left); row.appendChild(sel); row.appendChild(vis); row.appendChild(del);
        host.appendChild(row);
      });
      host.onclick=(e)=>{
        const t=e.target; const i=+t.getAttribute('data-i'); if(Number.isNaN(i)) return;
        if(t.hasAttribute('data-sel')) this.setActive(i);
        else if(t.hasAttribute('data-vis')) this.toggleShow(i);
        else if(t.hasAttribute('data-del')) this.delete(i);
      };
    },
    // ----- Import / Export -----
    exportGeoJSON(){
      const features=[];
      // waypoints
      WP.list().forEach(w=>{
        features.push({type:'Feature',properties:{name:w.name,type:'waypoint'},geometry:{type:'Point',coordinates:[w.lng,w.lat]}});
      });
      // routes
      this._routes.forEach(r=>{
        if(!r.points.length) return;
        features.push({type:'Feature',properties:{name:r.name,type:'route'},geometry:{type:'LineString',coordinates:r.points.map(p=>[p.lng,p.lat])}});
      });
      const fc={type:'FeatureCollection',features};
      const blob=new Blob([JSON.stringify(fc,null,2)],{type:'application/geo+json'});
      downloadBlob(blob,`ap-alignment-${Date.now()}.geojson`);
      toast('Exported GeoJSON');
    },
    exportGPX(){
      const esc=s=>String(s).replace(/[<&>"]/g,c=>({ '<':'&lt;','>':'&gt;','&':'&amp;','"':'&quot;'}[c]));
      let xml=`<?xml version="1.0" encoding="UTF-8"?>\n<gpx version="1.1" creator="AP Alignment" xmlns="http://www.topografix.com/GPX/1/1">\n`;
      // wpts
      WP.list().forEach(w=>{ xml+=`  <wpt lat="${w.lat.toFixed(6)}" lon="${w.lng.toFixed(6)}"><name>${esc(w.name)}</name></wpt>\n`; });
      // routes as tracks
      this._routes.forEach(r=>{
        if(!r.points.length) return;
        xml+=`  <trk><name>${esc(r.name)}</name><trkseg>\n`;
        r.points.forEach(p=>{ xml+=`    <trkpt lat="${p.lat.toFixed(6)}" lon="${p.lng.toFixed(6)}"${p.ele?` ele="${p.ele}"`:''}></trkpt>\n`; });
        xml+=`  </trkseg></trk>\n`;
      });
      xml+=`</gpx>\n`;
      const blob=new Blob([xml],{type:'application/gpx+xml'});
      downloadBlob(blob,`ap-alignment-${Date.now()}.gpx`);
      toast('Exported GPX');
    },
    importFile(e){
      const f=e.target.files?.[0]; if(!f){ toast('No file selected'); return; }
      const name=f.name.toLowerCase();
      const reader=new FileReader();
      reader.onload=()=>{ try{
        if(name.endsWith('.geojson')||name.endsWith('.json')) Routes._importGeoJSON(reader.result);
        else if(name.endsWith('.gpx')) Routes._importGPX(reader.result);
        else toast('Unsupported file type');
      }catch(err){ console.error(err); toast('Failed to import'); } finally { e.target.value=''; } };
      reader.readAsText(f);
    },
    _importGeoJSON(text){
      const gj=JSON.parse(text);
      const feats=(gj.type==='FeatureCollection')?gj.features: (gj.type==='Feature')?[gj]: [];
      if(!feats.length){ toast('No features in GeoJSON'); return; }
      let addedW=0, addedR=0;
      feats.forEach(f=>{
        const t=f.geometry?.type;
        if(t==='Point'){
          const [lng,lat]=f.geometry.coordinates||[];
          if(Number.isFinite(lat)&&Number.isFinite(lng)) { WP.upsert((f.properties?.name||'WP').slice(0,48),lat,lng); addedW++; }
        }else if(t==='LineString'){
          const coords=f.geometry.coordinates||[];
          const points=coords.map(([lng,lat])=>({lat,lng,name:''})).filter(p=>Number.isFinite(p.lat)&&Number.isFinite(p.lng));
          if(points.length){ this._routes.push({name:(f.properties?.name||`Route ${this._routes.length+1}`).slice(0,60),points,show:true}); addedR++; }
        }else if(t==='MultiLineString'){
          const mls=f.geometry.coordinates||[];
          mls.forEach(seg=>{
            const points=seg.map(([lng,lat])=>({lat,lng,name:''})).filter(p=>Number.isFinite(p.lat)&&Number.isFinite(p.lng));
            if(points.length){ this._routes.push({name:(f.properties?.name||`Route ${this._routes.length+1}`).slice(0,60),points,show:true}); addedR++; }
          });
        }
      });
      this.save(); WP.render(); this.render(); this.redrawAll();
      toast(`Imported ${addedW} waypoint(s), ${addedR} route(s)`);
    },
    _importGPX(text){
      const doc=new DOMParser().parseFromString(text,'application/xml');
      const nsResolver = doc.createNSResolver(doc.documentElement);
      const q=(xp)=>Array.from(doc.evaluate(xp,doc,nsResolver,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null)).map((_,i)=>doc.evaluate(xp,doc,nsResolver,XPathResult.ORDERED_NODE_SNAPSHOT_TYPE,null).snapshotItem(i));
      const wpts=q('/*[local-name()="gpx"]/*[local-name()="wpt"]');
      let addedW=0, addedR=0;
      wpts.forEach(w=>{
        const lat=parseFloat(w.getAttribute('lat')); const lng=parseFloat(w.getAttribute('lon'));
        const nameEl=w.getElementsByTagNameNS('*','name')[0]; const nm=nameEl?.textContent||'WP';
        if(Number.isFinite(lat)&&Number.isFinite(lng)) { WP.upsert(nm,lat,lng); addedW++; }
      });
      const trks=q('/*[local-name()="gpx"]/*[local-name()="trk"]');
      trks.forEach(trk=>{
        const nm=(trk.getElementsByTagNameNS('*','name')[0]?.textContent||`Track ${this._routes.length+1}`).slice(0,60);
        const segs=Array.from(trk.getElementsByTagNameNS('*','trkseg'));
        segs.forEach(seg=>{
          const pts=Array.from(seg.getElementsByTagNameNS('*','trkpt')).map(pt=>({lat:parseFloat(pt.getAttribute('lat')),lng:parseFloat(pt.getAttribute('lon'))})).filter(p=>Number.isFinite(p.lat)&&Number.isFinite(p.lng));
          if(pts.length){ this._routes.push({name:nm,points:pts,show:true}); addedR++; }
        });
      });
      const rtes=q('/*[local-name()="gpx"]/*[local-name()="rte"]');
      rtes.forEach(rte=>{
        const nm=(rte.getElementsByTagNameNS('*','name')[0]?.textContent||`Route ${this._routes.length+1}`).slice(0,60);
        const pts=Array.from(rte.getElementsByTagNameNS('*','rtept')).map(pt=>({lat:parseFloat(pt.getAttribute('lat')),lng:parseFloat(pt.getAttribute('lon'))})).filter(p=>Number.isFinite(p.lat)&&Number.isFinite(p.lng));
        if(pts.length){ this._routes.push({name:nm,points:pts,show:true}); addedR++; }
      });
      this.save(); WP.render(); this.render(); this.redrawAll();
      toast(`Imported ${addedW} waypoint(s), ${addedR} route(s)`);
    }
  };

  const Pin={
    pin:null,_nm:null,
    drop(lat,lng){
      if(this.pin) App.map.removeLayer(this.pin);
      this.pin=makeDot(lat,lng,10).addTo(App.map);
      this._nm=`Pin ${fix(lat)},${fix(lng)}`;
      bindMarker(this.pin,{name:this._nm,lat,lng});
    }
  };

  function bindMarker(m,{name,lat,lng}){
    m.unbindPopup();
    m.bindPopup(()=>{
      const root=document.createElement('div'); root.style.display='grid'; root.style.gap='6px';
      const title=document.createElement('div'); title.style.fontWeight='800'; title.textContent=name||`Pin ${fix(lat)},${fix(lng)}`;
      const coords=document.createElement('div'); coords.style.color='var(--muted)'; coords.style.fontSize='12px'; coords.textContent=`${fix(lat)}, ${fix(lng)}`;
      const btns=document.createElement('div'); btns.style.display='flex'; btns.style.gap='6px'; btns.style.justifyContent='flex-end';
      const copy=document.createElement('button'); copy.className='btn'; copy.textContent='Copy';
      const guide=document.createElement('button'); guide.className='btn'; guide.textContent='Guide';
      const append=document.createElement('button'); append.className='btn'; append.textContent='Append';
      btns.appendChild(copy); btns.appendChild(guide); btns.appendChild(append);
      root.appendChild(title); root.appendChild(coords); root.appendChild(btns);
      copy.onclick=async()=>{ const txt=`${fix(lat)}, ${fix(lng)}`; try{ await navigator.clipboard.writeText(txt); copy.textContent='Copied'; setTimeout(()=>copy.textContent='Copy',900);}catch{ prompt('Copy to clipboard:',txt);} };
      guide.onclick=()=>{ App.S.dest={lat,lng,name:name||'Dest'}; m.closePopup(); };
      append.onclick=()=>{ if(Routes.activeIndex<0){ toast('Create/select a route first.'); return; } Routes.appendPoint(Routes.activeIndex,{lat,lng,name}); toast(`Point appended to ${Routes.list()[Routes.activeIndex].name}`); };
      setTimeout(()=>App.applyMapBearing(App.S.mapBearing,false));
      return root;
    },{className:'floating-popup',autoClose:true,closeButton:true,offset:[0,-6]});
  }

  function parseCoords(t){
    const s=t.trim().replace(/\s+/g,' ').replace(/[,;]+/g,',');
    const m=s.match(/^\s*([+-]?\d+(\.\d+)?)\s*,\s*([+-]?\d+(\.\d+)?)\s*$/i);
    if(m){ const lat=+m[1],lng=+m[3]; if(Math.abs(lat)<=90&&Math.abs(lng)<=180) return {lat,lng}; }
    const parts=s.split(','); if(parts.length===2){
      const one=q=>{ const x=q.trim().match(/^([NSEW])?\s*([+-]?\d+(\.\d+)?)\s*([NSEW])?$/i); if(!x) return null; const h=(x[1]||x[4]||'').toUpperCase(); let v=parseFloat(x[2]); if(h==='S'||h==='W') v=-Math.abs(v); if(h==='N'||h==='E') v=Math.abs(v); return {v,h}; };
      const a=one(parts[0]),b=one(parts[1]); if(a&&b){ const lat=(a.h==='N'||a.h==='S')?a.v:b.v; const lng=(a.h==='E'||a.h==='W')?a.v:b.v; if(Math.abs(lat)<=90&&Math.abs(lng)<=180) return {lat,lng}; }
    }
    return null;
  }

  function downloadBlob(blob, filename){
    const url=URL.createObjectURL(blob);
    const a=document.createElement('a');
    a.href=url; a.download=filename; document.body.appendChild(a); a.click();
    setTimeout(()=>{ document.body.removeChild(a); URL.revokeObjectURL(url); },100);
  }

  ready(()=>{ if(!window.L){ toast('Leaflet failed to load.'); return; }
    App.init(); WP.render(); Routes.render(); Routes.redrawAll();
    $('decl').value=App.S.decl; $('declVal').textContent=App.S.decl.toFixed(1)+'¬∞';
    $('autoStart').checked=!!App.S.autostart; $('edgeOffOnly').checked=!!App.S.edgeOffOnly; $('invertAndroid').checked=!!App.S.invertAndroid;
    if(App.S.autostart) App.enableCompass();
  });
})();
</script>
</body>
</html>
