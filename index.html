<!-- File: index.html -->
<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no" />
<title>Map App ‚Äî Rotating Map (Heading Ray Only)</title>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous" />
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>

<style>
:root{--bg:#0b0f10;--panel:#12181a;--text:#e7f6ef;--accent:#29a36a;--dim:#91c7ae;--danger:#ff6b6b;--green:#2aff2a}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);-webkit-tap-highlight-color:transparent}
#map{position:fixed;inset:0;height:100svh;width:100vw}
.controls{position:fixed;top:env(safe-area-inset-top,12px);left:50%;transform:translateX(-50%);display:flex;gap:8px;background:rgba(18,24,26,.85);padding:8px 10px;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.35);z-index:1000;backdrop-filter:blur(6px)}
.btn{appearance:none;border:1px solid rgba(255,255,255,.12);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--text);padding:8px 10px;border-radius:10px;font:600 14px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;cursor:pointer}
.btn.primary{border-color:var(--accent)}.btn.toggled{outline:2px solid var(--accent)}
.badge{padding:0 8px;border-radius:999px;background:rgba(255,255,255,.1);font-size:12px;margin-left:6px}
.info{position:fixed;left:50%;transform:translateX(-50%);bottom:calc(env(safe-area-inset-bottom,12px));background:rgba(18,24,26,.9);padding:8px 12px;border-radius:12px;font:500 13px/1.2 ui-monospace,SFMono-Regular,Menlo,monospace;color:var(--dim);z-index:1000;box-shadow:0 6px 18px rgba(0,0,0,.35);backdrop-filter:blur(6px)}
.fab{position:fixed;right:14px;bottom:calc(env(safe-area-inset-bottom,14px) + 56px);z-index:1000;width:48px;height:48px;border-radius:50%;display:grid;place-items:center;background:rgba(18,24,26,.9);border:1px solid rgba(255,255,255,.12)}
.panel{position:fixed;right:12px;bottom:calc(env(safe-area-inset-bottom,12px) + 120px);width:min(92vw,360px);max-height:60vh;overflow:auto;background:rgba(18,24,26,.95);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:12px;z-index:1000;box-shadow:0 12px 32px rgba(0,0,0,.45);display:none}
.panel.open{display:block}
.row{display:grid;gap:8px;margin:10px 0}
.row input,.row button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text);font:500 14px/1.2 system-ui,sans-serif}
.list{display:grid;gap:8px}
.item{display:grid;grid-template-columns:1fr auto auto;gap:6px;align-items:center;padding:8px;border:1px solid rgba(255,255,255,.08);border-radius:10px}
.item small{color:var(--dim);display:block}.item button{padding:6px 10px}
.danger{border-color:var(--danger);color:var(--danger)}
.leaflet-control-attribution,.leaflet-control-zoom{filter:drop-shadow(0 6px 12px rgba(0,0,0,.35))}
.leaflet-container a{color:var(--dim)}.leaflet-map-pane{will-change:transform}
</style>
</head>
<body>
<div id="map"></div>

<div class="controls">
  <button id="btnLocate" class="btn primary">Enable GPS</button>
  <button id="btnFollow" class="btn toggled">Follow: <span id="followState" class="badge">on</span></button>
  <button id="btnCompass" class="btn">Compass <span id="compassState" class="badge">off</span></button>
  <button id="btnReset" class="btn">Reset</button>
</div>

<button id="btnWaypoints" class="btn fab" title="Waypoints">üìç</button>
<div id="wpPanel" class="panel" aria-hidden="true">
  <div class="row">
    <input id="wpName" placeholder="Name (e.g., Tower SE)" />
    <input id="wpCoords" placeholder='Coords (e.g., 34.851939 N, -119.168399 W or 34.851939,-119.168399)' />
    <button id="wpAdd" class="btn primary">Add / Update</button>
  </div>
  <div class="list" id="wpList"></div>
</div>

<div class="info" id="readout">Lat: ‚Äî, Lng: ‚Äî | Acc: ‚Äî m | Head: ‚Äî¬∞ | Map bearing: ‚Äî¬∞</div>

<script>
(() => {
  // --- Utils ---
  const $ = id => document.getElementById(id);
  const normalize = d => (d % 360 + 360) % 360;
  const diff = (a,b) => { let d = normalize(b) - normalize(a); return d>180?d-360:d<-180?d+360:d; };
  const emaAngle = (prev, next, a) => prev==null ? next : normalize(prev + a*diff(prev,next));
  const toRad = d => d * Math.PI / 180, toDeg = r => r * 180 / Math.PI;

  // --- Map ---
  const map = L.map('map', { zoomControl:true, attributionControl:true });
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    maxZoom:20, minZoom:2,
    attribution:'&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>'
  }).addTo(map);
  const DEFAULT = { lat:34.9, lng:-119.17, z:16 };
  map.setView([DEFAULT.lat, DEFAULT.lng], DEFAULT.z);

  // --- State ---
  let lastPos = null, follow = true;
  let headingFiltered = null, mapApplied = 0;
  let compassEnabled = false, rotateMap = true; // map follows heading when on
  const EMA_ALPHA = 0.12, DEADBAND = 1.0;

  // --- DOM ---
  const readout = $('readout'), compassBadge = $('compassState'), followBadge = $('followState'), btnFollow = $('btnFollow');

  // --- Layers ---
  const accuracy = L.circle([DEFAULT.lat, DEFAULT.lng], { radius:0, color:'#4db6ff', weight:1, opacity:.6, fillOpacity:.08 }).addTo(map);
  let ray = null;

  // ‚ÄúInfinite‚Äù ray from user along heading
  function destination(latlng, bearingDeg, distMeters){
    const R = 6371000, br = toRad(bearingDeg), dr = distMeters / R;
    const lat1 = toRad(latlng.lat), lon1 = toRad(latlng.lng);
    const lat2 = Math.asin(Math.sin(lat1)*Math.cos(dr) + Math.cos(lat1)*Math.sin(dr)*Math.cos(br));
    const lon2 = lon1 + Math.atan2(Math.sin(br)*Math.sin(dr)*Math.cos(lat1), Math.cos(dr)-Math.sin(lat1)*Math.sin(lat2));
    return L.latLng(toDeg(lat2), toDeg(lon2));
  }
  function refreshRay(){
    if (!lastPos || headingFiltered == null){
      if (ray) ray.setLatLngs([]);
      return;
    }
    if (!ray){
      ray = L.polyline([], { color:'#2aff2a', weight:2, opacity:1, interactive:false }).addTo(map);
    }
    const origin = L.latLng(lastPos.coords.latitude, lastPos.coords.longitude);
    const diag = map.distance(map.getNorthWest(), map.getSouthEast()) || 1000000;
    const dest = destination(origin, headingFiltered, diag * 1.2 + 1000); // keep beyond viewport
    ray.setLatLngs([origin, dest]);
  }

  // --- Map rotation around user pivot (keeps rotation natural while panning) ---
  function applyBearingWithPivot(deg){
    const pane = map.getPane('mapPane'); if (!pane) return;
    let origin = '50% 50%';
    if (lastPos){
      const p = map.latLngToContainerPoint([lastPos.coords.latitude, lastPos.coords.longitude]);
      origin = `${p.x}px ${p.y}px`;
    }
    const base = pane.style.transform || '';
    pane.style.transformOrigin = origin;
    pane.style.transform = `${base.replace(/rotate\([^)]*\)/g,'').trim()} rotate(${-deg}deg)`;
  }

  function updateReadout(){
    const lat = lastPos?.coords?.latitude?.toFixed(6) ?? '‚Äî';
    const lng = lastPos?.coords?.longitude?.toFixed(6) ?? '‚Äî';
    const acc = lastPos?.coords?.accuracy ? Math.round(lastPos.coords.accuracy) : '‚Äî';
    const hdg = headingFiltered != null ? Math.round(headingFiltered) : '‚Äî';
    const mapBear = Math.round(normalize(-mapApplied));
    readout.textContent = `Lat: ${lat}, Lng: ${lng} | Acc: ${acc} m | Head: ${hdg}¬∞ | Map bearing: ${mapBear}¬∞`;
  }

  // --- Animation ---
  (function tick(){
    // Target map rotation (heading when rotateMap, else north-up)
    const target = rotateMap ? (headingFiltered ?? 0) : 0;
    mapApplied += diff(normalize(mapApplied), target);
    applyBearingWithPivot(mapApplied);
    updateReadout();
    requestAnimationFrame(tick);
  })();

  // Keep pivot + ray correct on interactions / resize
  map.on('move moveend zoom zoomend zoomanim', () => { applyBearingWithPivot(mapApplied); refreshRay(); });
  window.addEventListener('resize', () => { map.invalidateSize(); applyBearingWithPivot(mapApplied); refreshRay(); }, { passive:true });

  // --- Compass ---
  function handleOrientation(e){
    let h = typeof e.webkitCompassHeading === 'number' ? e.webkitCompassHeading
          : typeof e.alpha === 'number' ? e.alpha : null;
    if (h==null || isNaN(h)) return;
    h = normalize(h);
    if (headingFiltered == null){
      headingFiltered = h;
      if (rotateMap) mapApplied = h; // avoid initial snap only when rotating map
      refreshRay();
    }else{
      const a = Math.abs(diff(headingFiltered, h)) < 12 ? EMA_ALPHA : 0.3;
      const next = emaAngle(headingFiltered, h, a);
      if (Math.abs(diff(headingFiltered, next)) >= DEADBAND) { headingFiltered = next; refreshRay(); }
    }
  }
  async function ensureCompassActive(){
    if (compassEnabled) return true;
    try{
      if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function'){
        if ((await DeviceOrientationEvent.requestPermission()) !== 'granted'){ alert('Compass permission denied.'); return false; }
      }
      window.addEventListener('deviceorientationabsolute', handleOrientation, true);
      window.addEventListener('deviceorientation', handleOrientation, true);
      compassEnabled = true; return true;
    }catch(e){ console.error(e); alert('Compass access failed.'); return false; }
  }

  // --- GPS ---
  function startGPS(){
    if (!('geolocation' in navigator)) return alert('Geolocation not supported.');
    navigator.geolocation.watchPosition(
      pos => {
        lastPos = pos;
        const { latitude, longitude, accuracy: acc } = pos.coords, ll = [latitude, longitude];
        accuracy.setLatLng(ll).setRadius(Math.max(acc || 0, 0));
        if (follow) map.setView(ll, Math.max(map.getZoom(), 16), { animate:false });
        applyBearingWithPivot(mapApplied);
        refreshRay();
        updateReadout();
      },
      err => { console.warn('GPS error:', err); alert('Unable to get location: ' + err.message); },
      { enableHighAccuracy:true, maximumAge:2000, timeout:15000 }
    );
  }

  // --- View / Follow ---
  function resetView(){
    if (lastPos){
      const { latitude, longitude } = lastPos.coords;
      map.setView([latitude, longitude], Math.max(map.getZoom(), 16));
    } else map.setView([DEFAULT.lat, DEFAULT.lng], DEFAULT.z);
    applyBearingWithPivot(mapApplied);
  }
  function setFollow(val){
    follow = !!val;
    followBadge.textContent = follow ? 'on' : 'off';
    btnFollow.classList.toggle('toggled', follow);
    if (follow && lastPos){
      const { latitude, longitude } = lastPos.coords;
      map.setView([latitude, longitude], Math.max(map.getZoom(), 16), { animate:false });
      applyBearingWithPivot(mapApplied);
    }
  }

  // --- Waypoints (unchanged) ---
  const wpKey = 'mapapp.waypoints.v1', wpMarkers = new Map();
  const loadWPs = () => { try{ return JSON.parse(localStorage.getItem(wpKey)||'[]'); }catch{ return []; } };
  const saveWPs = arr => localStorage.setItem(wpKey, JSON.stringify(arr));
  function renderWPs(){
    const list = $('wpList'); list.innerHTML = '';
    loadWPs().forEach((wp,idx)=>{
      const div = document.createElement('div');
      div.className = 'item';
      div.innerHTML = `<div><strong>${wp.name}</strong><small>${wp.lat.toFixed(6)}, ${wp.lng.toFixed(6)}</small></div>
        <button class="btn" data-go="${idx}">Go</button>
        <button class="btn danger" data-del="${idx}">Del</button>`;
      list.appendChild(div);
    });
  }
  function addOrUpdateWP(name, lat, lng){
    const data = loadWPs(), nm = name?.trim() || `WP ${Date.now().toString().slice(-5)}`;
    const i = data.findIndex(w => w.name.toLowerCase() === nm.toLowerCase()), entry = { name:nm, lat, lng };
    if (i>=0) data[i]=entry; else data.push(entry);
    saveWPs(data); renderWPs(); syncMarkers();
  }
  function deleteWP(index){
    const data = loadWPs(); const [rm] = data.splice(index,1);
    saveWPs(data); renderWPs();
    if (rm && wpMarkers.has(rm.name)){ map.removeLayer(wpMarkers.get(rm.name)); wpMarkers.delete(rm.name); }
  }
  function syncMarkers(){
    const data = loadWPs();
    data.forEach(wp=>{
      if (!wpMarkers.has(wp.name)){
        const m = L.marker([wp.lat, wp.lng]).addTo(map)
          .bindPopup(`<b>${wp.name}</b><br>${wp.lat.toFixed(6)}, ${wp.lng.toFixed(6)}`);
        wpMarkers.set(wp.name, m);
      } else wpMarkers.get(wp.name).setLatLng([wp.lat, wp.lng]);
    });
    [...wpMarkers.keys()].forEach(n => { if (!data.some(w => w.name===n)){ map.removeLayer(wpMarkers.get(n)); wpMarkers.delete(n); } });
  }
  function parseCoords(input){
    const t = input.trim().replace(/\s+/g,' ').replace(/[,;]+/g,',');
    const dec = t.match(/^\s*([+-]?\d+(\.\d+)?)\s*,\s*([+-]?\d+(\.\d+)?)\s*$/i);
    if (dec){
      const lat = parseFloat(dec[1]), lng = parseFloat(dec[3]);
      if (Number.isFinite(lat)&&Number.isFinite(lng)&&Math.abs(lat)<=90&&Math.abs(lng)<=180) return {lat,lng};
    }
    const parts = t.split(','); if (parts.length!==2) return null;
    const parseOne = s => {
      const m = s.trim().match(/^([NSEW])?\s*([+-]?\d+(\.\d+)?)\s*([NSEW])?$/i);
      if (!m) return null;
      const hemi=(m[1]||m[4]||'').toUpperCase(); let v=parseFloat(m[2]);
      if (hemi==='S'||hemi==='W') v=-Math.abs(v); if (hemi==='N'||hemi==='E') v=Math.abs(v);
      return {v,hemi};
    };
    const a=parseOne(parts[0]), b=parseOne(parts[1]); if (!a||!b) return null;
    const lat = (a.hemi==='N'||a.hemi==='S') ? a.v : b.v, lng = (a.hemi==='E'||a.hemi==='W') ? a.v : b.v;
    return (Math.abs(lat)<=90&&Math.abs(lng)<=180) ? {lat,lng} : null;
  }

  // --- UI ---
  $('btnLocate').addEventListener('click', startGPS);
  $('btnCompass').addEventListener('click', async () => {
    const ok = await ensureCompassActive(); if (!ok) return;
    rotateMap = !rotateMap;
    compassBadge.textContent = rotateMap ? 'on' : 'off';
    $('btnCompass').classList.toggle('toggled', rotateMap);
    applyBearingWithPivot(mapApplied);
    if (rotateMap) setFollow(true);
  });
  $('btnReset').addEventListener('click', resetView);
  btnFollow.addEventListener('click', () => setFollow(!follow));

  const btnWaypoints = $('btnWaypoints'), wpPanel = $('wpPanel'), wpList = $('wpList'), wpName = $('wpName'), wpCoords = $('wpCoords');
  btnWaypoints.addEventListener('click', () => {
    wpPanel.classList.toggle('open');
    wpPanel.setAttribute('aria-hidden', wpPanel.classList.contains('open') ? 'false' : 'true');
  });
  $('wpAdd').addEventListener('click', () => {
    const parsed = parseCoords(wpCoords.value);
    if (!parsed) return alert('Could not parse coordinates. Try "34.851939,-119.168399" or "34.851939 N, -119.168399 W".');
    addOrUpdateWP(wpName.value, parsed.lat, parsed.lng);
    wpName.value=''; wpCoords.value='';
  });
  wpList.addEventListener('click', e => {
    const t=e.target, go=t.getAttribute('data-go'), del=t.getAttribute('data-del');
    if (go!=null){ const w=loadWPs()[+go]; if (w){ map.setView([w.lat,w.lng],16); wpMarkers.get(w.name)?.openPopup(); } }
    if (del!=null) deleteWP(+del);
  });

  renderWPs(); syncMarkers(); applyBearingWithPivot(mapApplied); refreshRay();
})();
</script>
</body>
</html>
