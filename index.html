<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
<title>Map App ‚Äî Ultra Lean</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<style>
:root{--bg:#0b0f10;--panel:#12181a;--text:#e7f6ef;--accent:#29a36a;--dim:#91c7ae;--danger:#ff6b6b}
html,body{margin:0;height:100%;background:var(--bg);color:var(--text)}
#map{position:fixed;inset:0}
.dot-pin{border-radius:50%;background:var(--panel);border:2px solid var(--accent);box-shadow:0 0 8px rgba(0,0,0,.35)}
.controls{position:fixed;top:12px;left:50%;transform:translateX(-50%);display:flex;gap:8px;z-index:1000;
background:rgba(18,24,26,.85);padding:8px 10px;border-radius:14px;backdrop-filter:blur(6px)}
.btn{border:1px solid rgba(255,255,255,.15);background:rgba(255,255,255,.05);color:var(--text);
padding:8px 10px;border-radius:10px;font:600 14px system-ui;cursor:pointer}
.btn.primary{border-color:var(--accent)}.btn.toggled{outline:2px solid var(--accent)}
.badge{padding:0 6px;margin-left:4px;border-radius:999px;background:rgba(255,255,255,.1);font-size:12px}
.fab{position:fixed;right:14px;bottom:70px;width:48px;height:48px;border-radius:50%;
display:grid;place-items:center;background:rgba(18,24,26,.9);z-index:1000}
.panel{position:fixed;right:12px;bottom:130px;width:min(92vw,340px);max-height:60vh;overflow:auto;
background:rgba(18,24,26,.95);padding:12px;border-radius:16px;z-index:900;display:none}
.panel.open{display:block}
.row{display:grid;gap:8px;margin:10px 0}
.row input,.row button{padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,.1);
background:rgba(255,255,255,.04);color:var(--text);font:500 14px system-ui}
.list{display:grid;gap:8px}
.item{display:grid;grid-template-columns:1fr auto auto;gap:6px;align-items:center;padding:8px;
border:1px solid rgba(255,255,255,.08);border-radius:10px}
.item small{color:var(--dim)}.danger{border-color:var(--danger);color:var(--danger)}
.info{position:fixed;left:12px;right:12px;bottom:12px;background:rgba(18,24,26,.9);padding:10px 12px;border-radius:14px;
font:500 13px ui-monospace;color:var(--dim);z-index:900;backdrop-filter:blur(6px);pointer-events:none}
.metric{display:flex;gap:6px}.metric .value{color:var(--text)}
</style></head><body>
<div id="map"></div>
<div class="controls">
 <button id="gps" class="btn primary">GPS</button>
 <button id="follow" class="btn toggled">Follow<span id="fB" class="badge">on</span></button>
 <button id="comp" class="btn">Compass<span id="cB" class="badge">off</span></button>
 <button id="reset" class="btn">Reset</button>
</div>
<button id="wps" class="btn fab">üìç</button>
<div id="wpPanel" class="panel">
 <div class="row"><input id="n" placeholder="Name"/><input id="xy" placeholder="34.85,-119.16"/><button id="add" class="btn primary">Add</button></div>
 <div id="lst" class="list"></div>
</div>
<div id="info" class="info"></div>

<script>
document.addEventListener('DOMContentLoaded',()=>{
const $=i=>document.getElementById(i),R=d=>d*Math.PI/180,D=r=>r*180/Math.PI,N=d=>(d%360+360)%360,F=n=>+n.toFixed(6),
Œî=(a,b)=>{let d=N(b)-N(a);return d>180?d-360:d<-180?d+360:d},
bl=(a,b,s)=>a==null?b:N(a+s*Œî(a,b)),fmt=m=>m<1e3?m.toFixed(0)+'m':(m/1e3).toFixed(2)+'km',
dist=(A,B)=>6371e3*2*Math.asin(Math.sqrt(Math.sin(R(B.lat-A.lat)/2)**2+Math.cos(R(A.lat))*Math.cos(R(B.lat))*Math.sin(R(B.lng-A.lng)/2)**2)),
bear=(A,B)=>N(D(Math.atan2(Math.sin(R(B.lng-A.lng))*Math.cos(R(B.lat)),Math.cos(R(A.lat))*Math.sin(R(B.lat))-Math.sin(R(A.lat))*Math.cos(R(B.lat))*Math.cos(R(B.lng-A.lng))))),
fwd=(A,b,d)=>{const br=R(b),dr=d/6371e3,œÜ1=R(A.lat),Œª1=R(A.lng),œÜ2=Math.asin(Math.sin(œÜ1)*Math.cos(dr)+Math.cos(œÜ1)*Math.sin(dr)*Math.cos(br)),
Œª2=Œª1+Math.atan2(Math.sin(br)*Math.sin(dr)*Math.cos(œÜ1),Math.cos(dr)-Math.sin(œÜ1)*Math.sin(œÜ2));return L.latLng(D(œÜ2),D(Œª2))};

const App={
S:{follow:1,heading:null,bearing:0,rotate:1,dest:null},map:null,last:null,acc:null,ray:null,nav:null,mark:new Map(),
init(){
 this.map=L.map('map').setView([34.9,-119.17],16);
 L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{attribution:'¬©OSM',maxZoom:20}).addTo(this.map);
 this.acc=L.circle([34.9,-119.17],{radius:0,color:'#4db6ff',weight:1,fillOpacity:.08}).addTo(this.map);
 this.loop();UI.init();WPs.init();
},
loop(){const S=this.S;S.bearing+=Œî(S.bearing,S.rotate?(S.heading??0):0);this.update();requestAnimationFrame(()=>this.loop())},
update(){this.rot();this.rayF();this.navF();UI.read(this)},
rot(){const p=this.map.getPane('mapPane');if(!p)return;let o='50% 50%';
if(this.last){const q=this.map.latLngToContainerPoint([this.last.coords.latitude,this.last.coords.longitude]);o=`${q.x}px ${q.y}px`;}
p.style.transformOrigin=o;p.style.transform=`rotate(${-this.S.bearing}deg)`},
rayF(){const S=this.S;if(!this.last||S.heading==null)return;
const o=L.latLng(this.last.coords.latitude,this.last.coords.longitude);
this.ray??=L.polyline([], {color:'#2aff2a',weight:3}).addTo(this.map);
this.ray.setLatLngs([o,fwd(o,S.heading,5000)])},
navF(){const S=this.S;if(!S.dest||!this.last)return;
const me=L.latLng(this.last.coords.latitude,this.last.coords.longitude),to=L.latLng(S.dest.lat,S.dest.lng),
b=bear(me,to),d=dist(me,to),hit=Math.abs(Œî(S.heading,b))<.5;
this.nav??=L.polyline([], {weight:3,dashArray:'6 6'}).addTo(this.map);
this.nav.setLatLngs([me,to]).setStyle({color:hit?'#f44':'#29a36a',weight:hit?4:3});
UI.nav={b,d,S}},
gps(p){this.last=p;const {latitude,longitude,accuracy:a,heading}=p.coords,ll=[latitude,longitude];
this.acc.setLatLng(ll).setRadius(a||0);if(this.S.follow)this.map.setView(ll,16);
if(isFinite(heading))this.S.heading=bl(this.S.heading,heading,0.3)},
startGPS(){navigator.geolocation?.watchPosition(p=>this.gps(p),e=>alert(e.message),{enableHighAccuracy:1})},
toggleF(){this.S.follow^=1;UI.follow(this.S.follow)},
toggleC(){UI.compass(this.S.rotate^=1)},
reset(){this.S.dest?this.S.dest=null:this.last&&this.map.setView([this.last.coords.latitude,this.last.coords.longitude],16)}
};

const WPs={
k:'map.wps',init(){this.draw();},
load(){try{return JSON.parse(localStorage.getItem(this.k)||'[]')}catch{return[]}},
save(a){localStorage.setItem(this.k,JSON.stringify(a));this.draw();},
draw(){const Ls=$('lst');Ls.innerHTML='';this.load().forEach((w,i)=>{
const div=document.createElement('div');div.className='item';
div.innerHTML=`<div><b>${w.name}</b><small>${F(w.lat)},${F(w.lng)}</small></div>
<button class='btn' data-go=${i}>Go</button><button class='btn danger' data-del=${i}>Del</button>`;
Ls.append(div);if(!App.mark.has(w.name)){const m=L.marker([w.lat,w.lng],{icon:L.divIcon({className:'dot-pin',iconSize:[12,12]})})
.addTo(App.map).bindPopup(`<b>${w.name}</b><br>${F(w.lat)},${F(w.lng)}<br><button data-guide>Guide</button>`)
.on('popupopen',e=>e.popup._contentNode.querySelector('[data-guide]').onclick=()=>App.S.dest=w);
App.mark.set(w.name,m);}});},
add(n,lat,lng){const a=this.load(),nm=n?.trim()||`WP${Date.now()%1e5}`,i=a.findIndex(w=>w.name==nm),e={name:nm,lat,lng};
i>=0?a[i]=e:a.push(e);this.save(a);}
};

const UI={
nav:null,init(){
 $('gps').onclick=()=>App.startGPS();
 $('follow').onclick=()=>App.toggleF();
 $('comp').onclick=()=>App.toggleC();
 $('reset').onclick=()=>App.reset();
 $('wps').onclick=()=>$('wpPanel').classList.toggle('open');
 $('add').onclick=()=>{const t=$('xy').value.split(',').map(parseFloat);
 if(t.length!=2||t.some(isNaN))return alert('Bad coords');WPs.add($('n').value,t[0],t[1]);$('n').value=$('xy').value='';};
 $('lst').onclick=e=>{const g=e.target.dataset.go,d=e.target.dataset.del;
 if(g!=null){const w=WPs.load()[g];App.map.setView([w.lat,w.lng],16);App.mark.get(w.name)?.openPopup();}
 if(d!=null){const a=WPs.load();a.splice(d,1);WPs.save(a);}};
},read(A){const c=A.last?.coords||{},S=A.S,h=S.heading?.toFixed(1)||'‚Äî',mb=N(-S.bearing).toFixed(1);
let m=`<div class='metric'><span>Lat</span><b class='value'>${c.latitude?.toFixed?.(6)||'‚Äî'}</b></div>
<div class='metric'><span>Lng</span><b class='value'>${c.longitude?.toFixed?.(6)||'‚Äî'}</b></div>
<div class='metric'><span>Acc</span><b class='value'>${c.accuracy?Math.round(c.accuracy):'‚Äî'}m</b></div>
<div class='metric'><span>Head</span><b class='value'>${h}¬∞</b></div>
<div class='metric'><span>Map</span><b class='value'>${mb}¬∞</b></div>`;
if(this.nav)m+=`<div class='metric'><span>Dist</span><b class='value'>${fmt(this.nav.d)}</b></div>`;
$('info').innerHTML=m;},
follow(v){$('fB').textContent=v?'on':'off';$('follow').classList.toggle('toggled',v)},
compass(v){$('cB').textContent=v?'on':'off';$('comp').classList.toggle('toggled',v)}
};

addEventListener('deviceorientation',e=>{
let h=e.webkitCompassHeading??e.alpha;if(h==null)return;App.S.heading=bl(App.S.heading,h,0.3);
},!0);

App.init();
});
</script>
</body></html>
