<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AP-Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <style>
    :root{
      --bg:#020912;
      --bg2:#000000;
      --card:#020308;
      --ink:#bbf7d0;
      --muted:#4ade80;
      --accent:#22c55e;
      --accent-soft:rgba(34,197,94,.12);
      --border:rgba(34,197,94,.55);
      --danger:#f97373;
      --shadow:0 18px 40px rgba(0,0,0,.9);
      --mono:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
    }
    *{
      box-sizing:border-box;
      -webkit-tap-highlight-color:transparent;
    }
    html,body{
      margin:0;padding:0;height:100%;
      background:
        radial-gradient(circle at top,var(--bg) 0,var(--bg) 40%,var(--bg2) 100%),
        repeating-linear-gradient(
          to bottom,
          rgba(22,101,52,.25) 0,
          rgba(22,101,52,.25) 1px,
          transparent 1px,
          transparent 3px
        );
      color:var(--ink);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
    }
    #app{
      min-height:100vh;
      max-width:520px;
      margin:0 auto;
      padding:10px 10px 18px;
      display:flex;
      flex-direction:column;
      gap:8px;
      position:relative;
      z-index:1;
    }

    /* Generic layout helpers */
    .row{display:flex;align-items:center}
    .between{justify-content:space-between}
    .col{display:flex;flex-direction:column}

    /* Cards / floating panels */
    .card{
      background:radial-gradient(circle at top left,#020617 0,var(--card) 55%,#000 100%);
      border-radius:14px;
      border:1px solid var(--border);
      padding:10px 12px;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:0;
      background:
        linear-gradient(120deg,rgba(34,197,94,.12),transparent 35%,transparent 65%,rgba(16,185,129,.18));
      opacity:.3;
      pointer-events:none;
      mix-blend-mode:screen;
    }
    .card-inner{position:relative;z-index:1}

    .card-head{
      display:flex;
      align-items:center;
      justify-content:space-between;
      margin-bottom:6px;
      gap:8px;
    }
    .card-title{
      font-size:11px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:.14em;
      color:var(--muted);
    }

    /* Header */
    header{
      padding:4px 8px 6px;
      border-radius:14px;
      border:1px solid rgba(34,197,94,.6);
      background:radial-gradient(circle at top,#022c22 0,#020617 70%,#000 100%);
      box-shadow:0 14px 40px rgba(0,0,0,.9);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .title-main{
      font-family:var(--mono);
      font-size:16px;
      font-weight:600;
      letter-spacing:.2em;
      text-transform:uppercase;
      color:#4ade80;
    }
    .title-sub{
      font-size:10px;
      color:#16a34a;
      font-family:var(--mono);
    }
    .badge{
      font-size:10px;
      border-radius:999px;
      border:1px solid rgba(22,163,74,.9);
      padding:2px 10px;
      color:#bbf7d0;
      background:rgba(6,95,70,.75);
      white-space:nowrap;
      font-family:var(--mono);
    }

    /* Pills, labels */
    .pill{
      font-size:10px;
      border-radius:999px;
      border:1px solid var(--border);
      padding:2px 8px;
      color:var(--muted);
      max-width:55%;
      text-align:right;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
      font-family:var(--mono);
    }
    .label{
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:.1em;
      color:#16a34a;
      font-family:var(--mono);
    }
    .status-text{
      font-size:11px;
      margin:0;
      color:var(--ink);
      min-height:18px;
      font-family:var(--mono);
    }

    /* Terminal buttons */
    .controls-card .card-inner{display:flex;flex-direction:column;gap:6px}
    .controls-row{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
    }
    .tbtn{
      border-radius:999px;
      border:1px solid rgba(34,197,94,.85);
      padding:8px 10px;
      font-size:11px;
      font-family:var(--mono);
      background:rgba(0,0,0,.9);
      color:#bbf7d0;
      cursor:pointer;
      display:inline-flex;
      align-items:center;
      gap:6px;
      box-shadow:0 10px 26px rgba(0,0,0,.9);
    }
    .tbtn span.cmd{
      color:#22c55e;
    }
    .tbtn span.lbl{
      color:#bbf7d0;
    }
    .tbtn:active{
      transform:translateY(1px) scale(.99);
      box-shadow:0 6px 16px rgba(0,0,0,.9);
    }
    .tbtn.disabled,
    .tbtn:disabled{
      opacity:.55;
      cursor:default;
      box-shadow:none;
    }

    /* Mini buttons (saved list) */
    .btn-mini{
      border-radius:999px;
      border:1px solid rgba(34,197,94,.5);
      background:rgba(0,0,0,.9);
      color:#bbf7d0;
      font-size:9px;
      font-family:var(--mono);
      padding:3px 6px;
      cursor:pointer;
    }

    /* Compass layout */
    .compass-card .card-inner{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .compass-shell{
      display:flex;
      gap:10px;
      justify-content:center;
      align-items:center;
    }
    .compass-block{
      flex:1 1 0;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:2px;
    }
    .compass-block-heading{
      max-width:260px;
    }
    .compass-block-pitch{
      max-width:80px;
    }
    .compass-label{
      font-size:10px;
      color:#16a34a;
      font-family:var(--mono);
      text-transform:uppercase;
      letter-spacing:.15em;
    }
    canvas{
      display:block;
    }
    .hint-line{
      font-size:10px;
      color:var(--muted);
      font-family:var(--mono);
    }

    .accent-box{
      margin-top:4px;
      padding:5px 7px;
      border-radius:10px;
      border:1px solid rgba(34,197,94,.6);
      background:radial-gradient(circle at top left,var(--accent-soft),transparent);
      font-size:10px;
      color:var(--muted);
      font-family:var(--mono);
    }

    /* Telemetry layout */
    .telemetry-grid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:8px;
    }
    .row-data{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:6px;
      margin-bottom:3px;
    }
    .val{
      font-family:var(--mono);
      font-size:11px;
      text-align:right;
    }
    .val-lg{font-size:12px}

    .mini-pill{
      font-size:9px;
      padding:3px 7px;
      border-radius:999px;
      border:1px solid rgba(34,197,94,.45);
      background:rgba(0,0,0,.85);
      color:var(--muted);
      font-family:var(--mono);
    }
    .mini-pill.ok{
      border-color:rgba(34,197,94,.8);
      background:rgba(5,46,22,.9);
      color:#bbf7d0;
    }
    .mini-pill.bad{
      border-color:rgba(248,113,113,.8);
      background:rgba(127,29,29,.9);
      color:#fecaca;
    }
    .mini-pill.warn{
      border-color:rgba(250,204,21,.8);
      background:rgba(113,63,18,.9);
      color:#facc15;
    }
    .mini-row{
      display:flex;
      flex-wrap:wrap;
      gap:4px;
      margin-top:4px;
    }
    .error-box{
      margin-top:4px;
      padding:4px 6px;
      border-radius:9px;
      border:1px solid rgba(239,68,68,.7);
      background:rgba(127,29,29,.85);
      font-size:10px;
      color:#fee2e2;
      font-family:var(--mono);
    }

    .target-status-text{
      font-size:10px;
      color:var(--muted);
      font-family:var(--mono);
      margin-top:4px;
      min-height:12px;
    }

    .saved-box{
      margin-top:6px;
      padding:5px 7px 6px;
      border-radius:10px;
      border:1px dashed rgba(34,197,94,.6);
      background:rgba(0,0,0,.8);
      font-size:10px;
      font-family:var(--mono);
      color:var(--muted);
    }

    .saved-target-row{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:6px;
      padding:3px 0;
      border-bottom:1px dashed rgba(34,197,94,.25);
    }
    .saved-target-row:last-child{border-bottom:none}
    .saved-name{
      font-size:10px;
      color:#bbf7d0;
    }
    .saved-meta{
      font-size:9px;
      color:var(--muted);
    }

    .decl-input,
    .input-small{
      width:80px;
      padding:2px 4px;
      border-radius:6px;
      border:1px solid var(--border);
      background:#020617;
      color:var(--ink);
      font-size:11px;
      font-family:var(--mono);
      text-align:right;
    }
    .decl-unit{
      font-size:9px;
      color:var(--muted);
      white-space:nowrap;
      font-family:var(--mono);
    }

    .save-panel{
      margin-top:6px;
      padding:5px 7px 6px;
      border-radius:10px;
      border:1px solid rgba(34,197,94,.7);
      background:rgba(0,0,0,.9);
      font-family:var(--mono);
    }

    /* Overlay / map */
    .overlay-backdrop{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.9);
      display:none;
      align-items:center;
      justify-content:center;
      z-index:50;
      backdrop-filter:blur(4px);
    }
    .overlay-panel{
      width:100%;
      max-width:520px;
      max-height:90vh;
      background:#020617;
      border-radius:14px;
      border:1px solid rgba(34,197,94,.7);
      box-shadow:0 24px 60px rgba(0,0,0,.95);
      display:flex;
      flex-direction:column;
      overflow:hidden;
      font-family:var(--mono);
      color:#bbf7d0;
    }
    .overlay-head,
    .overlay-foot{
      padding:8px 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:8px;
      border-color:rgba(34,197,94,.5);
    }
    .overlay-head{border-bottom:1px solid rgba(34,197,94,.5)}
    .overlay-foot{border-top:1px solid rgba(34,197,94,.5)}
    .overlay-title{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:.16em;
      color:#4ade80;
    }
    .overlay-body{
      padding:6px 10px 8px;
      display:flex;
      flex-direction:column;
      gap:6px;
      font-size:10px;
      color:#a7f3d0;
    }
    #mapDiv{
      flex:1 1 auto;
      min-height:260px;
      border-radius:9px;
      overflow:hidden;
    }
    .overlay-row{
      display:flex;
      justify-content:space-between;
      font-size:10px;
    }
    .overlay-label{opacity:.7}
    .overlay-status{
      font-size:10px;
      margin-top:2px;
      color:#4ade80;
    }
  </style>
</head>
<body>
  <div id="app">
    <!-- HEADER -->
    <header class="row between">
      <div class="col">
        <div class="title-main">AP-TOOL</div>
        <div class="title-sub">geo · orientation · target · aim</div>
      </div>
      <div class="badge">MATRIX CONSOLE</div>
    </header>

    <!-- MAIN COMPASS CONSOLE (PRIMARY FOCUS) -->
    <section class="card compass-card">
      <div class="card-inner">
        <div class="card-head">
          <div class="card-title">Aiming Console</div>
          <div class="pill" id="aimStatusPill">NO TARGET</div>
        </div>

        <div class="compass-shell">
          <!-- Heading compass -->
          <div class="compass-block compass-block-heading">
            <div class="compass-label">&lt;HDG&gt; ASCII ROSE</div>
            <canvas id="headingCompass" width="240" height="240"></canvas>
          </div>

          <!-- Pitch gauge (vertical bar) -->
          <div class="compass-block compass-block-pitch">
            <div class="compass-label">&lt;PCH&gt; VERTICAL BAR</div>
            <canvas id="pitchCompass" width="80" height="240"></canvas>
          </div>
        </div>

        <div class="accent-box">
          <span class="label">Hint</span><br />
          <span class="hint-line">
            Rotate until &lt;HDG&gt; arrow and &lt;PCH&gt; bar line up with the target marks.
            When both glow bright, you are on target (±3°).
          </span>
        </div>
      </div>
    </section>

    <!-- TELEMETRY (SECONDARY FOCUS: TEXT DATA) -->
    <section class="card">
      <div class="card-inner">
        <div class="card-head">
          <div class="card-title">Sensor Telemetry</div>
          <div class="pill" id="comboStatus">gps: idle · ori: idle</div>
        </div>
        <p class="status-text" id="statusText">
          Ready. Tap &lt;START SENSORS&gt; once and accept the browser prompts on your phone.
        </p>

        <div class="telemetry-grid">
          <!-- GPS -->
          <article>
            <div class="row between" style="margin-bottom:4px;">
              <span class="label">GPS</span>
              <span class="pill" id="gpsStatusPill">gps: idle</span>
            </div>
            <div class="row-data">
              <div class="label">Latitude</div>
              <div class="val val-lg" id="gpsLat">—</div>
            </div>
            <div class="row-data">
              <div class="label">Longitude</div>
              <div class="val val-lg" id="gpsLon">—</div>
            </div>
            <div class="row-data">
              <div class="label">Elevation</div>
              <div class="val val-lg" id="gpsAlt">—</div>
            </div>
            <div id="gpsErrorBox" class="error-box" style="display:none">
              <strong>GPS error:</strong> <span id="gpsError">—</span>
            </div>
          </article>

          <!-- Orientation + Declination -->
          <article>
            <div class="row between" style="margin-bottom:4px;">
              <span class="label">Orientation</span>
              <span class="pill" id="oriStatusPill">ori: idle</span>
            </div>
            <div class="row-data">
              <div class="label">Heading (true)</div>
              <div class="val val-lg" id="headingVal">—</div>
            </div>
            <div class="row-data">
              <div class="label">Pitch</div>
              <div class="val val-lg" id="pitchVal">—</div>
            </div>
            <div class="row-data" style="margin-top:4px">
              <div class="label">Declination</div>
              <div class="val">
                <input id="declInput" class="decl-input" type="number" step="0.1" value="0" />
                <span class="decl-unit">° (E=+, W=-)</span>
              </div>
            </div>

            <div id="oriErrorBox" class="error-box" style="display:none">
              <strong>Orientation error:</strong> <span id="oriError">—</span>
            </div>
            <div class="mini-row">
              <span class="mini-pill" id="oriSupportPill">Checking support…</span>
            </div>
          </article>
        </div>
      </div>
    </section>

    <!-- TARGET + NUMERIC AIM DATA -->
    <section class="card">
      <div class="card-inner">
        <div class="card-head">
          <div class="card-title">Target &amp; Numeric Aim Data</div>
          <div class="pill" id="targetStatusPill">No target</div>
        </div>

        <div class="row-data" style="margin-top:2px">
          <div class="label">Target lat</div>
          <div class="val val-lg" id="targetLat">—</div>
        </div>
        <div class="row-data">
          <div class="label">Target lon</div>
          <div class="val val-lg" id="targetLon">—</div>
        </div>
        <div class="row-data">
          <div class="label">Target elev</div>
          <div class="val val-lg" id="targetElev">—</div>
        </div>

        <div class="target-status-text" id="targetStatusText">
          No target selected. Use &lt;SELECT TARGET&gt; or load a saved point.
        </div>

        <div style="margin-top:6px">
          <div class="row-data">
            <div class="label">Req heading</div>
            <div class="val val-lg" id="aimReqHeading">—</div>
          </div>
          <div class="row-data">
            <div class="label">Req pitch</div>
            <div class="val val-lg" id="aimReqPitch">—</div>
          </div>
          <div class="row-data">
            <div class="label">Head error</div>
            <div class="val val-lg" id="aimHeadingErr">—</div>
          </div>
          <div class="row-data">
            <div class="label">Pitch error</div>
            <div class="val val-lg" id="aimPitchErr">—</div>
          </div>
          <div class="row-data">
            <div class="label">Horiz dist</div>
            <div class="val val-lg" id="aimHorizDist">—</div>
          </div>
          <div class="row-data">
            <div class="label">Vert delta</div>
            <div class="val val-lg" id="aimVertDelta">—</div>
          </div>
        </div>

        <!-- Save / edit current target -->
        <div id="saveTargetPanel" class="save-panel" style="display:none">
          <div class="label" style="margin-bottom:4px">Save / edit target</div>
          <div class="row-data">
            <div class="label">Name</div>
            <input id="saveTargetName" class="input-small" type="text" />
          </div>
          <div class="row-data">
            <div class="label">Lat</div>
            <input id="saveTargetLat" class="input-small" type="number" step="0.000001" />
          </div>
          <div class="row-data">
            <div class="label">Lon</div>
            <input id="saveTargetLon" class="input-small" type="number" step="0.000001" />
          </div>
          <div class="row-data">
            <div class="label">Elev (m)</div>
            <input id="saveTargetElev" class="input-small" type="number" step="0.1" />
          </div>
          <div class="controls-row" style="margin-top:4px">
            <button id="saveTargetConfirmBtn" class="tbtn">
              <span class="cmd">&gt;&gt;</span><span class="lbl">SAVE</span>
            </button>
            <button id="saveTargetCancelBtn" class="tbtn">
              <span class="cmd">X</span><span class="lbl">CANCEL</span>
            </button>
          </div>
        </div>

        <!-- Saved targets list -->
        <div id="savedTargetsBox" class="saved-box" style="display:none">
          <div class="label" style="margin-bottom:4px">Saved targets</div>
          <div id="savedTargetsList"></div>
        </div>
      </div>
    </section>

    <!-- CONTROLS (ALL MAIN BUTTONS IN ONE PLACE) -->
    <section class="card controls-card">
      <div class="card-inner">
        <div class="card-head">
          <div class="card-title">Control Bus</div>
          <div class="pill">tap a command below</div>
        </div>

        <div class="controls-row">
          <button id="startBtn" class="tbtn">
            <span class="cmd">&gt;&gt;</span><span class="lbl">START SENSORS</span>
          </button>
          <button id="selectTargetBtn" class="tbtn">
            <span class="cmd">@</span><span class="lbl">SELECT TARGET (MAP)</span>
          </button>
        </div>

        <div class="controls-row">
          <button id="openSaveTargetBtn" class="tbtn">
            <span class="cmd">+</span><span class="lbl">SAVE / NEW TARGET</span>
          </button>
          <button id="calibrateHeadingBtn" class="tbtn">
            <span class="cmd">*</span><span class="lbl">CALIBRATE TO TARGET</span>
          </button>
        </div>
      </div>
    </section>
  </div>

  <!-- MAP OVERLAY -->
  <div id="mapOverlay" class="overlay-backdrop">
    <div class="overlay-panel">
      <div class="overlay-head">
        <div class="overlay-title">SELECT TARGET POINT</div>
        <button id="cancelTargetBtn" class="btn-mini">X CLOSE</button>
      </div>
      <div class="overlay-body">
        <div>Tap anywhere on the map to place a pin. Elevation is fetched automatically.</div>
        <div id="mapDiv"></div>
        <div class="overlay-row">
          <span class="overlay-label">Lat</span><span id="overlayLat">—</span>
        </div>
        <div class="overlay-row">
          <span class="overlay-label">Lon</span><span id="overlayLon">—</span>
        </div>
        <div class="overlay-row">
          <span class="overlay-label">Elev</span><span id="overlayElev">—</span>
        </div>
        <div class="overlay-status" id="overlayStatus">Tap on the map to place the pin.</div>
      </div>
      <div class="overlay-foot">
        <span></span>
        <button id="confirmTargetBtn" class="btn-mini">&gt;&gt; USE THIS POINT</button>
      </div>
    </div>
  </div>

  <!-- Core modules -->
  <script src="sensors.js"></script>
  <script src="map.js"></script>
  <script src="aim-math.js"></script>
  <script src="declination.js"></script>
  <script src="compass.js"></script>
  <script src="ui.js"></script>
</body>
</html>
