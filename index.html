<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover, user-scalable=no"/>
<meta name="theme-color" content="#0b0f12"/>
<title>Compass — True North</title>
<style>
:root{
  --bg:#0b0f12; --ink:#e9f5f0; --muted:#a8cfc0; --accent:#20d7b7; --line:rgba(255,255,255,.12);
  --disc1:#1a232b; --disc2:#11171d; --disc3:#0b1015;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,"Helvetica Neue",Arial,sans-serif;overscroll-behavior:none}
button,input,select{font:inherit}
.app{min-height:100svh;display:flex;flex-direction:column}
.top{height:48px;display:flex;align-items:center;gap:.5rem;padding:.4rem .8rem;border-bottom:1px solid var(--line);background:linear-gradient(180deg, var(--bg), rgba(11,15,18,.92))}
.badge{background:#121c23;border:1px solid var(--line);color:var(--muted);border-radius:10px;padding:.25rem .6rem;font-size:.9rem;white-space:nowrap}
.grow{margin-left:auto;display:flex;gap:.5rem;align-items:center}
.btn{background:#17242c;border:1px solid var(--line);color:var(--ink);padding:.45rem .8rem;border-radius:10px;cursor:pointer}
.btn:disabled{opacity:.6;cursor:not-allowed}
.main{flex:1;display:grid;place-items:center;padding:.8rem}
.compassWrap{position:relative;width:min(92vw,560px);aspect-ratio:1/1;display:grid;place-items:center}
.compass{
  width:100%;aspect-ratio:1/1;border-radius:50%;
  background:radial-gradient(120% 120% at 50% 0%, var(--disc1) 0%, var(--disc2) 60%, var(--disc3) 100%);
  border:1px solid var(--line);
  box-shadow:inset 0 0 0 2px rgba(255,255,255,.06), inset 0 20px 50px rgba(0,0,0,.55);
  position:relative;
  transform:perspective(900px) rotateX(18deg);
  overflow:hidden;
}
/* tick marks */
.tick{position:absolute;left:50%;top:50%;transform-origin:0% 0%}
.tickLine{width:48%;height:1px;background:rgba(255,255,255,.25);transform-origin:left center}
.tickTxt{position:absolute;right:6%;top:-10px;font-size:.8rem;color:var(--muted)}
/* north arrow */
.arrow{position:absolute;left:50%;top:50%;transform-origin:50% calc(100% - 18px);filter:drop-shadow(0 2px 2px rgba(0,0,0,.6));pointer-events:none}
.arrow svg{width:44%;height:auto;transform:translate(-50%,-72%)}
/* center readout */
.center{position:absolute;left:50%;top:50%;transform:translate(-50%,-50%) rotateX(-18deg);text-align:center;user-select:none}
.big{font-size:clamp(22px,6.2vw,40px);font-weight:800}
.mid{color:var(--muted);font-size:clamp(12px,3.6vw,16px)}
.controls{display:flex;gap:.5rem;align-items:center}
.field{display:flex;gap:.4rem;align-items:center;color:var(--muted)}
input[type="number"]{width:6.5ch;background:#0e171d;border:1px solid var(--line);border-radius:8px;color:var(--ink);padding:.35rem .5rem}
select{background:#0e171d;border:1px solid var(--line);border-radius:8px;color:var(--ink);padding:.35rem .5rem}
.footer{height:44px;display:flex;align-items:center;justify-content:center;color:var(--muted);font-size:.9rem;border-top:1px solid var(--line)}
</style>
</head>
<body>
<div class="app">
  <div class="top">
    <div class="badge" id="magBadge">Mag —</div>
    <div class="badge" id="hzBadge">Hz —</div>
    <div class="badge" id="statusBadge">Ready</div>
    <div class="grow">
      <div class="controls">
        <div class="field">
          <label for="mode">Mode</label>
          <select id="mode">
            <option value="true" selected>True</option>
            <option value="mag">Magnetic</option>
          </select>
        </div>
        <div class="field">
          <label for="decl">Decl (°)</label>
          <input id="decl" type="number" step="0.1" value="0">
        </div>
      </div>
      <button id="start" class="btn">Start</button>
    </div>
  </div>

  <div class="main">
    <div class="compassWrap">
      <div class="compass" id="compass"></div>
      <div class="arrow" id="arrow">
        <!-- north-pointing marker -->
        <svg viewBox="0 0 200 260" xmlns="http://www.w3.org/2000/svg" role="img" aria-label="North arrow">
          <defs>
            <linearGradient id="g" x1="0" y1="0" x2="0" y2="1">
              <stop offset="0" stop-color="#ffffff" stop-opacity="0.92"/>
              <stop offset="1" stop-color="#bcd2d9" stop-opacity="0.92"/>
            </linearGradient>
          </defs>
          <path d="M100 15 L140 200 L100 175 L60 200 Z" fill="url(#g)" stroke="rgba(0,0,0,.25)" stroke-width="2"/>
          <circle cx="100" cy="205" r="18" fill="#0e171d" stroke="rgba(255,255,255,.2)" stroke-width="2"/>
        </svg>
      </div>
      <div class="center">
        <div class="big"><span id="deg">—</span>° <span id="card">---</span></div>
        <div class="mid">Heading to <b>True North</b></div>
      </div>
    </div>
  </div>

  <div class="footer">Tip: switch to “Magnetic” if you don’t know local declination.</div>
</div>

<script>
/* ------- helpers ------- */
const wrap360 = d => (d%360+360)%360;
const card = d => ["N","NNE","NE","ENE","E","ESE","SE","SSE","S","SSW","SW","WSW","W","WNW","NW","NNW"][Math.round(wrap360(d)/22.5)%16];

/* ------- build the dial ------- */
const compass = document.getElementById('compass');
(function buildTicks(){
  for(let d=0; d<360; d+=5){
    const t=document.createElement('div'); t.className='tick';
    t.style.transform=`rotate(${d}deg) translate(-50%,-50%)`;
    const line=document.createElement('div'); line.className='tickLine';
    line.style.opacity=(d%10===0)?1:0.5; line.style.height=(d%30===0)?'2px':'1px';
    t.appendChild(line);
    if(d%30===0){
      const txt=document.createElement('div'); txt.className='tickTxt';
      txt.textContent=(d===0)?"N":(d===90?"E":(d===180?"S":(d===270?"W":d)));
      t.appendChild(txt);
    }
    compass.appendChild(t);
  }
})();

/* ------- UI refs ------- */
const btnStart=document.getElementById('start');
const modeSel=document.getElementById('mode');
const declInput=document.getElementById('decl');
const magBadge=document.getElementById('magBadge');
const hzBadge=document.getElementById('hzBadge');
const statusBadge=document.getElementById('statusBadge');
const arrow=document.getElementById('arrow');
const degOut=document.getElementById('deg');
const cardOut=document.getElementById('card');

/* ------- state ------- */
const state={ heading:null, ema:null, hz:0, smp:0, t0:performance.now() };

/* ------- rendering ------- */
function render(){
  if(state.heading!=null){
    const h=state.heading;
    degOut.textContent=h.toFixed(1);
    cardOut.textContent=card(h);
    // Rotate the arrow so it points to (true) North
    arrow.style.transform=`translate(-50%,-50%) rotate(${h}deg)`;
  }
  hzBadge.textContent = "Hz " + state.hz.toFixed(0);
}

/* ------- sensors ------- */
function onOrientation(e){
  let heading;
  if(typeof e.webkitCompassHeading === "number"){
    // iOS: degrees CW from magnetic North
    heading = e.webkitCompassHeading;
    magBadge.textContent = (typeof e.webkitCompassAccuracy === "number" && e.webkitCompassAccuracy<20) ? "Mag OK" : "Mag noisy";
  }else if(typeof e.alpha === "number"){
    // Generic: alpha is device yaw CCW from screen-top; convert to CW-from-N
    // screen orientation compensation (simple)
    const so = (screen.orientation && screen.orientation.angle) || window.orientation || 0;
    let alpha = e.alpha;
    if(so===90) alpha+=90; else if(so===-90 || so===270) alpha-=90; else if(so===180) alpha+=180;
    heading = 360 - (alpha % 360);
    magBadge.textContent = "Mag —";
  }

  if(heading!=null){
    // True vs Magnetic
    if(modeSel.value === 'true'){
      const decl = parseFloat(declInput.value)||0;
      heading = wrap360(heading + decl);
    }
    // Simple smoothing (EMA)
    const a=0.18;
    state.ema = (state.ema==null)? heading : (state.ema*(1-a) + heading*a);
    state.heading = wrap360(state.ema);
  }

  state.smp++; const now=performance.now();
  if(now - state.t0 > 1000){ state.hz=state.smp; state.smp=0; state.t0=now; }
  render();
}

async function start(){
  try{
    if(typeof DeviceOrientationEvent !== 'undefined' &&
       typeof DeviceOrientationEvent.requestPermission === 'function'){
      const p = await DeviceOrientationEvent.requestPermission();
      if(p!=='granted') throw new Error('Motion permission denied');
    }
    window.addEventListener('deviceorientation', onOrientation, true);
    statusBadge.textContent='Running';
    btnStart.disabled=true;
  }catch(err){
    statusBadge.textContent='Start failed';
    alert(err.message || err);
  }
}

/* ------- wire up ------- */
btnStart.addEventListener('click', start);
modeSel.addEventListener('change', render);
declInput.addEventListener('input', ()=>{ state.ema=null; });

/* first paint */
render();
</script>
</body>
</html>
