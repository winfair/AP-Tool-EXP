<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AP-Tool</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />

  <!-- Leaflet -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    crossorigin=""
  />
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    crossorigin=""
  ></script>

  <style>
    :root {
      --bg:#020617; --bg2:#000; --card:#0b1220;
      --ink:#e5e7eb; --muted:#94a3b8;
      --accent:#38bdf8; --accent-soft:rgba(56,189,248,.15);
      --border:rgba(148,163,184,.4);
    }
    *{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
    html,body{
      margin:0;padding:0;height:100%;
      background:radial-gradient(circle at top,var(--bg) 0,var(--bg) 40%,var(--bg2) 100%);
      color:var(--ink);
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"SF Pro Text","Segoe UI",sans-serif;
    }
    #app{
      min-height:100vh;max-width:480px;margin:0 auto;
      padding:10px 10px 16px;
      display:flex;flex-direction:column;gap:8px;
      position:relative;z-index:1;
    }
    .row{display:flex;align-items:center}
    .between{justify-content:space-between}
    .wrap{flex-wrap:wrap}
    .col{display:flex;flex-direction:column}
    .card{
      background:var(--card);
      border-radius:14px;
      border:1px solid var(--border);
      padding:10px 12px;
      box-shadow:0 14px 28px rgba(15,23,42,.85);
    }
    .card-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:6px}
    .title-main{font-size:17px;font-weight:600;letter-spacing:.06em;text-transform:uppercase}
    .title-sub{font-size:11px;color:var(--muted)}
    .badge{
      font-size:10px;border-radius:999px;border:1px solid var(--border);
      padding:2px 8px;color:var(--muted);background:rgba(15,23,42,.9);white-space:nowrap;
    }
    .card-title{
      font-size:12px;font-weight:600;text-transform:uppercase;
      letter-spacing:.1em;color:var(--muted);
    }
    .pill{
      font-size:10px;border-radius:999px;
      border:1px solid var(--border);
      padding:2px 8px;
      color:var(--muted);
      max-width:55%;text-align:right;white-space:nowrap;overflow:hidden;text-overflow:ellipsis;
    }
    .label{
      font-size:10px;text-transform:uppercase;letter-spacing:.08em;color:var(--muted);
    }
    .status-text{font-size:12px;margin:0;color:var(--ink);min-height:18px}
    .start-row{margin-top:8px;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    button{
      border:none;border-radius:999px;padding:8px 12px;
      font-size:12px;font-weight:600;cursor:pointer;
      color:#0f172a;background:var(--accent);
      box-shadow:0 10px 24px rgba(56,189,248,.4);
      display:inline-flex;align-items:center;gap:6px;
    }
    button:active{transform:translateY(1px) scale(.99);box-shadow:0 6px 16px rgba(15,23,42,.9)}
    button:disabled{opacity:.55;cursor:default;box-shadow:none}
    .btn-secondary{
      background:transparent;color:var(--ink);
      box-shadow:none;border:1px solid var(--border);
    }
    .hint{font-size:10px;color:var(--muted)}
    .grid{
      display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:2px;
    }
    .row-data{
      display:flex;justify-content:space-between;align-items:baseline;
      gap:6px;margin-bottom:3px;
    }
    .val{
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:11px;text-align:right;
    }
    .val-lg{font-size:13px}
    .mini-pill{
      font-size:10px;padding:3px 7px;border-radius:999px;
      border:1px solid rgba(148,163,184,.4);
      background:rgba(15,23,42,.9);color:var(--muted);
    }
    .mini-pill.ok{border-color:rgba(34,197,94,.6);background:rgba(34,197,94,.08);color:#4ade80}
    .mini-pill.bad{border-color:rgba(248,113,113,.7);background:rgba(248,113,113,.1);color:#fecaca}
    .mini-pill.warn{border-color:rgba(250,204,21,.8);background:rgba(250,204,21,.08);color:#facc15}
    .mini-row{display:flex;flex-wrap:wrap;gap:4px;margin-top:4px}
    .accent-box{
      margin-top:5px;padding:5px 7px;
      border-radius:10px;border:1px solid rgba(56,189,248,.3);
      background:radial-gradient(circle at top left,var(--accent-soft),transparent);
      font-size:10px;color:var(--muted);
    }
    .decl-wrap{display:inline-flex;align-items:center;gap:4px}
    .decl-input{
      width:60px;padding:2px 4px;border-radius:999px;
      border:1px solid var(--border);
      background:#020617;color:var(--ink);
      font-size:11px;font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      text-align:right;
    }
    .decl-unit{font-size:10px;color:var(--muted);white-space:nowrap}
    .target-actions{margin-top:6px;display:flex;gap:6px;align-items:center;flex-wrap:wrap}
    .target-status{font-size:10px;color:var(--muted);flex:1 1 0}
    .compass-row{display:flex;gap:8px;margin-top:6px;justify-content:space-between;flex-wrap:nowrap}
    .compass-block{flex:1 1 0;display:flex;flex-direction:column;align-items:center;gap:2px}
    .compass-block canvas{width:100%;max-width:150px;height:auto;display:block}

    /* Overlay */
    .overlay-backdrop{
      position:fixed;inset:0;background:rgba(15,23,42,.9);
      display:none;align-items:center;justify-content:center;
      z-index:50;backdrop-filter:blur(4px);
    }
    .overlay-panel{
      width:100%;max-width:480px;max-height:90vh;
      background:#020617;border-radius:16px;border:1px solid var(--border);
      box-shadow:0 24px 60px rgba(0,0,0,.9);
      display:flex;flex-direction:column;overflow:hidden;
    }
    .overlay-head,.overlay-foot{
      padding:8px 10px;display:flex;align-items:center;justify-content:space-between;gap:8px;
      border-color:var(--border);
    }
    .overlay-head{border-bottom:1px solid var(--border)}
    .overlay-foot{border-top:1px solid var(--border)}
    .overlay-title{
      font-size:12px;text-transform:uppercase;letter-spacing:.1em;color:var(--muted);
    }
    .overlay-body{
      padding:6px 10px 8px;display:flex;flex-direction:column;gap:6px;
      font-size:10px;color:var(--muted);
    }
    #mapDiv{flex:1 1 auto;min-height:260px;border-radius:10px;overflow:hidden}
    .overlay-row{
      display:flex;justify-content:space-between;
      font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,"Liberation Mono","Courier New",monospace;
      font-size:10px;
    }
    .overlay-label{opacity:.7}
    .overlay-status{font-size:10px;margin-top:2px}
  </style>
</head>
<body>
  <div id="app">
    <!-- Header -->
    <header class="row between">
      <div class="col">
        <div class="title-main">AP-Tool</div>
        <div class="title-sub">GPS ¬∑ orientation ¬∑ target ¬∑ aim</div>
      </div>
      <div class="badge">Core module</div>
    </header>

    <!-- Sensor session -->
    <section class="card">
      <div class="card-head">
        <div class="card-title">Sensor Session</div>
        <div class="pill" id="comboStatus">Idle</div>
      </div>
      <div class="label">Status</div>
      <p class="status-text" id="statusText">
        Ready. Tap ‚ÄúStart sensors‚Äù once and accept the browser prompts on your phone.
      </p>
      <div class="start-row">
        <button id="startBtn">‚ñ∂ Start sensors</button>
        <span class="hint">Tap on your phone to enable sensors.</span>
      </div>
    </section>

    <!-- GPS + Orientation -->
    <section class="grid">
      <!-- GPS -->
      <article class="card">
        <div class="card-head">
          <div class="card-title">Location (GPS)</div>
          <div class="pill" id="gpsStatusPill">gps: idle</div>
        </div>
        <div class="row-data">
          <div class="label">Latitude</div>
          <div class="val val-lg" id="gpsLat">‚Äî</div>
        </div>
        <div class="row-data">
          <div class="label">Longitude</div>
          <div class="val val-lg" id="gpsLon">‚Äî</div>
        </div>
        <div class="row-data">
          <div class="label">Elevation</div>
          <div class="val val-lg" id="gpsAlt">‚Äî</div>
        </div>
        <div class="accent-box" id="gpsErrorBox" style="display:none">
          <strong>GPS error:</strong> <span id="gpsError">‚Äî</span>
        </div>
      </article>

      <!-- Orientation -->
      <article class="card">
        <div class="card-head">
          <div class="card-title">Orientation</div>
          <div class="pill" id="oriStatusPill">ori: idle</div>
        </div>
        <div class="row-data">
          <div class="label">Heading (true)</div>
          <div class="val val-lg" id="headingVal">‚Äî</div>
        </div>
        <div class="row-data">
          <div class="label">Pitch</div>
          <div class="val val-lg" id="pitchVal">‚Äî</div>
        </div>
        <div class="row-data" style="margin-top:4px">
          <div class="label">Declination</div>
          <div class="val">
            <span class="decl-wrap">
              <input id="declInput" class="decl-input" type="number" step="0.1" value="0" />
              <span class="decl-unit">¬∞ (E=+, W=-)</span>
            </span>
          </div>
        </div>
        <div class="start-row" style="margin-top:4px">
          <button id="calibrateHeadingBtn" class="btn-secondary">Calibrate to target</button>
          <span class="hint">Point phone at selected target, then tap.</span>
        </div>
        <div class="accent-box" id="oriErrorBox" style="display:none">
          <strong>Orientation error:</strong> <span id="oriError">‚Äî</span>
        </div>
        <div class="mini-row">
          <span class="mini-pill" id="oriSupportPill">Checking support‚Ä¶</span>
        </div>
      </article>
    </section>

    <!-- Target + Aim + Compass -->
    <section class="card">
      <div class="card-head">
        <div class="card-title">Target & Aim</div>
        <div class="pill" id="aimStatusPill">No target</div>
      </div>

      <div class="mini-row">
        <span class="mini-pill" id="targetStatusPill">No target</span>
      </div>

      <div class="row-data" style="margin-top:4px">
        <div class="label">Target lat</div>
        <div class="val val-lg" id="targetLat">‚Äî</div>
      </div>
      <div class="row-data">
        <div class="label">Target lon</div>
        <div class="val val-lg" id="targetLon">‚Äî</div>
      </div>
      <div class="row-data">
        <div class="label">Target elev</div>
        <div class="val val-lg" id="targetElev">‚Äî</div>
      </div>

      <div class="target-actions">
        <button id="selectTargetBtn">üó∫ Select Target</button>
        <span class="target-status" id="targetStatusText">
          No target selected. Tap ‚ÄúSelect Target‚Äù to choose a point on the map.
        </span>
      </div>

      <div style="margin-top:6px">
        <div class="row-data">
          <div class="label">Req heading</div>
          <div class="val val-lg" id="aimReqHeading">‚Äî</div>
        </div>
        <div class="row-data">
          <div class="label">Req pitch</div>
          <div class="val val-lg" id="aimReqPitch">‚Äî</div>
        </div>
        <div class="row-data">
          <div class="label">Head error</div>
          <div class="val val-lg" id="aimHeadingErr">‚Äî</div>
        </div>
        <div class="row-data">
          <div class="label">Pitch error</div>
          <div class="val val-lg" id="aimPitchErr">‚Äî</div>
        </div>
        <div class="row-data">
          <div class="label">Horiz dist</div>
          <div class="val val-lg" id="aimHorizDist">‚Äî</div>
        </div>
        <div class="row-data">
          <div class="label">Vert delta</div>
          <div class="val val-lg" id="aimVertDelta">‚Äî</div>
        </div>
      </div>

      <div class="compass-row">
        <div class="compass-block">
          <div class="label">Heading guide</div>
          <canvas id="headingCompass" width="150" height="150"></canvas>
        </div>
        <div class="compass-block">
          <div class="label">Pitch guide</div>
          <canvas id="pitchCompass" width="150" height="150"></canvas>
        </div>
      </div>

      <div class="accent-box">
        When the arrow overlays the target line (within ¬±3¬∞), the gauge turns green ‚Äî you're on target.
      </div>
    </section>
  </div>

  <!-- Floating map overlay -->
  <div id="mapOverlay" class="overlay-backdrop">
    <div class="overlay-panel">
      <div class="overlay-head">
        <div class="overlay-title">Select target point</div>
        <button id="cancelTargetBtn" class="btn-secondary">‚úï Close</button>
      </div>
      <div class="overlay-body">
        <div>Tap anywhere on the map to place a pin. Elevation is fetched automatically.</div>
        <div id="mapDiv"></div>
        <div class="overlay-row">
          <span class="overlay-label">Lat</span><span id="overlayLat">‚Äî</span>
        </div>
        <div class="overlay-row">
          <span class="overlay-label">Lon</span><span id="overlayLon">‚Äî</span>
        </div>
        <div class="overlay-row">
          <span class="overlay-label">Elev</span><span id="overlayElev">‚Äî</span>
        </div>
        <div class="overlay-status" id="overlayStatus">Tap on the map to place the pin.</div>
      </div>
      <div class="overlay-foot">
        <span></span>
        <button id="confirmTargetBtn">‚úî Use this point</button>
      </div>
    </div>
  </div>

  <!-- Core modules -->
  <script src="sensors.js"></script>
  <script src="map.js"></script>
  <script src="aim-math.js"></script>
  <script src="declination.js"></script>
  <script src="compass.js"></script>
  <script src="ui.js"></script>
</body>
</html>
