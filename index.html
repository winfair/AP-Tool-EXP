<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/><title>Geo Arrow — Stable Target Pointer (WGS‑84, Sensor‑Smoothed)</title><style>:root{--bg:#0b0f12;--ink:#e8f1f0;--line:rgba(255,255,255,.16);--muted:#9fc0b8;--brand:#22d7b7;--accent:#ff4d4d}html,body{height:100%;margin:0;background:radial-gradient(120% 140% at 50% 20%,#131a20 0%,#0b0f12 60%,#06080a 100%);color:var(--ink);font-family:system-ui,-apple-system,"Segoe UI",Roboto,Inter,Arial,sans-serif}#canvas{position:fixed;inset:0;display:block;width:100%;height:100%}.panel{position:fixed;left:12px;top:12px;z-index:10;background:rgba(10,14,18,.76);border:1px solid var(--line);backdrop-filter:blur(6px);padding:.8rem;border-radius:14px;display:flex;flex-direction:column;gap:.55rem;max-width:min(92vw,520px)}.row{display:flex;gap:.5rem;flex-wrap:wrap}.row>label{display:flex;flex:1 1 42%;align-items:center;gap:.35rem;background:rgba(255,255,255,.05);border:1px solid var(--line);padding:.35rem .5rem;border-radius:10px}input[type=number],input[type=text]{width:100%;background:transparent;border:none;outline:none;color:var(--ink);font-variant-numeric:tabular-nums}input[type=range]{width:100%}.btn{appearance:none;border:1px solid var(--line);background:rgba(255,255,255,.06);color:var(--ink);padding:.52rem .8rem;border-radius:12px;font-weight:600;cursor:pointer}.btn:active{transform:translateY(1px)}.tiny{font-size:.85rem;color:var(--muted)}#readout{position:fixed;left:12px;bottom:12px;opacity:.95;font-variant-numeric:tabular-nums;background:rgba(0,0,0,.32);padding:.42rem .65rem;border-radius:10px;border:1px solid var(--line)}</style></head><body><canvas id="canvas"></canvas><div class="panel"><div class="tiny">Arrow points from <b>you → target</b> in true 3D (WGS‑84). Camera follows your device orientation.</div><div class="row"><label>Lat° <input id="tLat" type="number" step="0.000001" placeholder="e.g. 48.137"/></label><label>Lon° <input id="tLon" type="number" step="0.000001" placeholder="e.g. 11.575"/></label></div><div class="row"><label>Alt (m) <input id="tAlt" type="number" step="0.1" placeholder="0"/></label><button id="setTarget" class="btn">Set Target</button></div><div class="row"><button id="useGps" class="btn">Use My Location</button><button id="calYaw" class="btn">Calibrate</button><button id="perm" class="btn">Enable Sensors</button></div><div class="row"><label>Stability <input id="stab" type="range" min="0" max="0.9" step="0.01" value="0.18"/></label><label>Deadband° <input id="dead" type="number" step="0.1" value="0.5"/></label></div><div class="tiny" id="status">Status: awaiting target & location…</div></div><div id="readout">az: —° el: —° | me: —, —, —m</div><script src="https://cdn.jsdelivr.net/npm/three@0.160.1/build/three.min.js" crossorigin="anonymous"></script><script>(()=>{const e=document.getElementById("canvas"),t=new THREE.WebGLRenderer({canvas:e,antialias:!0,alpha:!0});t.setPixelRatio(Math.min(devicePixelRatio,2));const n=new THREE.Scene,i=new THREE.PerspectiveCamera(55,1,.1,1e3);i.position.set(0,0,5),i.lookAt(0,0,0);const o=new THREE.Group;n.add(o),o.add(i),n.add(new THREE.AmbientLight(16777215,.9));const r=new THREE.DirectionalLight(16777215,.45);r.position.set(3,4,5),n.add(r);const a=new THREE.Group,s=new THREE.MeshStandardMaterial({color:15262448,metalness:.25,roughness:.35}),l=new THREE.MeshStandardMaterial({color:16724877,metalness:.35,roughness:.25}),c=new THREE.MeshStandardMaterial({color:2271031,metalness:.35,roughness:.35}),d=new THREE.Mesh(new THREE.CylinderGeometry(.06,.06,2.6,22),s);d.position.z=1.1,d.rotation.x=Math.PI/2;const u=new THREE.Mesh(new THREE.ConeGeometry(.18,.6,30),l);u.position.z=2.4,u.rotation.x=Math.PI/2;const h=new THREE.Mesh(new THREE.CylinderGeometry(.18,.18,.16,30),c);h.position.z=.02,h.rotation.x=Math.PI/2,a.add(d,u,h),n.add(a);const m=new THREE.Mesh(new THREE.CircleGeometry(2.6,96),new THREE.MeshBasicMaterial({color:16777215,transparent:!0,opacity:.06}));m.rotation.x=-Math.PI/2,m.position.y=-.001,n.add(m);const g=document.getElementById("tLat"),f=document.getElementById("tLon"),p=document.getElementById("tAlt"),v=document.getElementById("setTarget"),b=document.getElementById("useGps"),y=document.getElementById("calYaw"),w=document.getElementById("perm"),S=document.getElementById("stab"),E=document.getElementById("dead"),L=document.getElementById("status"),M=document.getElementById("readout");let A={lat:0,lon:0,alt:0,valid:!1},x={lat:0,lon:0,alt:0,valid:!1};const O=6378137,k=1/298.257223563,P=k*(2-k),R=e=>e*Math.PI/180,H=e=>180*e/Math.PI;function q(e,t,n){const i=R(e),o=R(t),r=Math.sin(i),a=Math.cos(i),s=O/Math.sqrt(1-P*r*r),l=(s+n)*a*Math.cos(o),c=(s+n)*a*Math.sin(o),d=(s*(1-P)+n)*r;return{x:l,y:c,z:d}}function T(e,t,n,i,o){const r=R(i),a=R(o),s=Math.sin(r),l=Math.cos(r),c=Math.sin(a),d=Math.cos(a),u=-c*e+d*t,h=-s*d*e-s*c*t+l*n,m=l*d*e+l*c*t+s*n;return{e:u,n:h,u:m}}function C(){if(!A.valid||!x.valid)return null;const e=q(A.lat,A.lon,A.alt),t=q(x.lat,x.lon,x.alt),n=t.x-e.x,i=t.y-e.y,o=t.z-e.z,r=T(n,i,o,A.lat,A.lon),a=(Math.atan2(r.e,r.n)+2*Math.PI)%(2*Math.PI),s=Math.atan2(r.u,Math.hypot(r.e,r.n));return{az:a,el:s,enu:r}}let N=0,j=0,D=0,B=0,I=0,F=0,Y=0,Z=0;const G=new THREE.Vector3(0,0,1),_=new THREE.Quaternion;function z(e){return e%=2*Math.PI,e<-Math.PI&&(e+=2*Math.PI),e>Math.PI&&(e-=2*Math.PI),e}function J(e,t,n){return e+z(t-e)*n}function K(){const e=C();if(!e)return void(M.textContent="az: —° el: —° | me: —, —, —m");const t=parseFloat(S.value)||.18;Y=J(Y,e.az,t),Z=J(Z,e.el,t);const n=new THREE.Vector3(Math.sin(Y)*Math.cos(Z),Math.sin(Z),Math.cos(Y)*Math.cos(Z)).normalize();_.setFromUnitVectors(G,n),a.quaternion.slerp(_,Math.min(.9,1.4*t)),M.textContent=`az: ${H(e.az).toFixed(1)}° el: ${H(e.el).toFixed(1)}° | me: ${A.lat.toFixed(6)}, ${A.lon.toFixed(6)}, ${A.alt.toFixed(1)}m`}function Q(){const e=parseFloat(S.value)||.18,t=parseFloat(E.value)||0,n=(N+B+360)%360,i=((n-I+540)%360-180);Math.abs(i)>t&&(I+=i*e),Math.abs(F-j)>t&&(F+=(j-F)*e),Math.abs(Y-D)>t&&(Y+=(D-Y)*e),o.rotation.set(THREE.MathUtils.degToRad(F),THREE.MathUtils.degToRad(I),THREE.MathUtils.degToRad(Y))}v.addEventListener("click",()=>{const e=parseFloat(g.value),t=parseFloat(f.value),n=parseFloat(p.value)||0;Number.isFinite(e)&&Number.isFinite(t)?(x={lat:e,lon:t,alt:n,valid:!0},L.textContent="Status: target set.",K()):L.textContent="Status: enter valid target lat/lon."}),b.addEventListener("click",()=>{"geolocation"in navigator?(navigator.geolocation.watchPosition(e=>{const t=e.coords,n=.25;A.valid||(A={lat:t.latitude,lon:t.longitude,alt:t.altitude||0,valid:!0}),A.lat=A.lat*(1-n)+t.latitude*n,A.lon=A.lon*(1-n)+t.longitude*n,A.alt=A.alt*(1-n)+(t.altitude||0)*n,L.textContent="Status: tracking your location…"},e=>{L.textContent=`Status: GPS error — ${e.message}`},{enableHighAccuracy:!0,maximumAge:3e3,timeout:15e3})):(L.textContent="Status: Geolocation not available.")}),y.addEventListener("click",()=>{B=(360-N)%360,L.textContent="Status: yaw calibrated."}),w.addEventListener("click",async()=>{try{"undefined"!=typeof DeviceOrientationEvent&&"function"==typeof DeviceOrientationEvent.requestPermission&&await DeviceOrientationEvent.requestPermission()}catch(e){console.warn("Permission request error",e)}if("AbsoluteOrientationSensor"in window||"RelativeOrientationSensor"in window){const e=window.AbsoluteOrientationSensor||window.RelativeOrientationSensor,t=new e({frequency:60,referenceFrame:"device"});t.addEventListener("reading",()=>{const[e,t,i,o]=t.quaternion,r=Math.atan2(2*(o*i+e*t),1-2*(t*t+i*i)),a=Math.asin(THREE.MathUtils.clamp(2*(o*t-i*e),-1,1)),s=Math.atan2(2*(o*e+t*i),1-2*(e*e+t*t));N=((H(r)-90)%360+360)%360,j=H(a),D=H(s),Q(),K()}),t.start()}else window.addEventListener("deviceorientationabsolute"in window?"deviceorientationabsolute":"deviceorientation",e=>{"number"==typeof e.webkitCompassHeading?N=e.webkitCompassHeading:"number"==typeof e.alpha&&(N=(360-e.alpha)%360),j="number"==typeof e.beta?e.beta-90:0,D="number"==typeof e.gamma?e.gamma:0,Q(),K()},!0);L.textContent="Status: sensors enabled."});function U(){const n=e.clientWidth||window.innerWidth,i=e.clientHeight||window.innerHeight;t.setSize(n,i,!1),i.aspect=n/i,i.updateProjectionMatrix()}window.addEventListener("resize",U,{passive:!0}),U(),function n(){requestAnimationFrame(n),t.render(window.scene||window,this.scene||window,n)}.bind({scene:n})()})();</script></body></html>
