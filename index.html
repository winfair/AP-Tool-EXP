<!DOCTYPE html><html lang="en"><head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
<title>Map App ‚Äî Lean (Dots + Glow)</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin="anonymous"/>
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin="anonymous"></script>
<style>
:root{--bg:#0b0f10;--panel:#12181a;--text:#e7f6ef;--accent:#29a36a;--dim:#91c7ae;--danger:#ff6b6b}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);-webkit-tap-highlight-color:transparent}
#map{position:fixed;inset:0;height:100svh;width:100vw}
.dot-pin{border-radius:50%;background:var(--panel);border:2px solid var(--accent);box-shadow:0 4px 10px rgba(0,0,0,.35)}
.guide-hit{filter:drop-shadow(0 0 6px #ff4444)}
.controls{position:fixed;top:env(safe-area-inset-top,12px);left:50%;transform:translateX(-50%);display:flex;gap:8px;background:rgba(18,24,26,.85);padding:8px 10px;border-radius:14px;box-shadow:0 6px 18px rgba(0,0,0,.35);z-index:1100;backdrop-filter:blur(6px)}
.btn{appearance:none;border:1px solid rgba(255,255,255,.12);background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02));color:var(--text);padding:8px 10px;border-radius:10px;font:600 14px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;cursor:pointer}
.btn.primary{border-color:var(--accent)}.btn.toggled{outline:2px solid var(--accent)}
.badge{padding:0 8px;border-radius:999px;background:rgba(255,255,255,.1);font-size:12px;margin-left:6px}
.fab{position:fixed;right:14px;z-index:1100;width:48px;height:48px;border-radius:50%;display:grid;place-items:center;background:rgba(18,24,26,.9);border:1px solid rgba(255,255,255,.12)}
.fab.wp{bottom:calc(env(safe-area-inset-bottom,14px) + 60px)}
.fab.gear{bottom:calc(env(safe-area-inset-bottom,14px) + 8px)}
.panel{position:fixed;right:12px;bottom:calc(env(safe-area-inset-bottom,12px) + 120px);width:min(92vw,360px);max-height:60vh;overflow:auto;background:rgba(18,24,26,.95);border:1px solid rgba(255,255,255,.12);border-radius:16px;padding:12px;z-index:1050;box-shadow:0 12px 32px rgba(0,0,0,.45);display:none}
.panel.open{display:block}
.row{display:grid;gap:8px;margin:10px 0}
.row input,.row button{width:100%;padding:10px 12px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.04);color:var(--text);font:500 14px/1.2 system-ui,sans-serif}
.list{display:grid;gap:8px}
.item{display:grid;grid-template-columns:1fr auto auto auto auto;gap:6px;align-items:center;padding:8px;border:1px solid rgba(255,255,255,.08);border-radius:10px}
.item small{color:var(--dim);display:block}.item button{padding:6px 10px}
.danger{border-color:var(--danger);color:var(--danger)}
.leaflet-control-attribution,.leaflet-control-zoom{filter:drop-shadow(0 6px 12px rgba(0,0,0,.35))}
.leaflet-container a{color:var(--dim)}.leaflet-map-pane{will-change:transform}
.info{position:fixed;left:12px;right:12px;bottom:env(safe-area-inset-bottom,12px);background:rgba(18,24,26,.9);padding:10px 12px;border-radius:14px;font:500 13px/1.25 ui-monospace,SFMono-Regular,Menlo,monospace;color:var(--dim);z-index:900;box-shadow:0 6px 18px rgba(0,0,0,.35);backdrop-filter:blur(6px);pointer-events:none}
.info .metrics{display:flex;flex-wrap:wrap;gap:10px 14px;align-items:baseline}
.info .metric{display:flex;gap:6px;align-items:baseline}
.info .metric span{color:var(--dim);font:600 12px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif}
.info .metric .value{color:var(--text);font:700 15px/1 ui-monospace;letter-spacing:.2px}
.leaflet-popup-content{font:500 13px/1.3 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;color:var(--text)}
.floating-popup .leaflet-popup-content-wrapper{background:rgba(18,24,26,.92);border:1px solid rgba(255,255,255,.12);backdrop-filter:blur(8px);border-radius:12px;box-shadow:0 10px 24px rgba(0,0,0,.45)}
.floating-popup .leaflet-popup-tip{background:rgba(18,24,26,.92);border:1px solid rgba(255,255,255,.12)}
.floating-popup .leaflet-popup-content{margin:10px 12px}
.popup-grid{display:grid;gap:8px}.popup-actions{display:flex;gap:8px;justify-content:flex-end}
.popup-actions .btn{padding:6px 10px;font-size:13px}
.popup-input{width:100%;padding:8px;border-radius:10px;border:1px solid rgba(255,255,255,.12);background:rgba(255,255,255,.06);color:var(--text);font:500 13px/1}
.mini-label{background:rgba(18,24,26,.85);color:var(--text);padding:2px 6px;border:1px solid rgba(255,255,255,.12);border-radius:8px;font:600 12px/1 system-ui,-apple-system,Segoe UI,Roboto,sans-serif;backdrop-filter:blur(4px);pointer-events:none}
.settings-group{display:grid;gap:8px;margin:8px 0}
.settings-label{font:600 13px/1 system-ui}
.settings-note{color:var(--dim);font-size:12px}
</style></head><body>
<div id="map"></div>
<div class="controls" role="toolbar" aria-label="Map controls">
  <button id="btnLocate" class="btn primary">Enable GPS</button>
  <button id="btnFollow" class="btn toggled" aria-pressed="true">Follow: <span id="followState" class="badge">on</span></button>
  <button id="btnCompass" class="btn" aria-pressed="false">Rotate <span id="compassState" class="badge">off</span></button>
  <button id="btnReset" class="btn">Reset</button>
</div>

<!-- FABs -->
<button id="btnWaypoints" class="btn fab wp" title="Waypoints" aria-haspopup="true" aria-controls="wpPanel" aria-expanded="false">üìç</button>
<button id="btnSettings" class="btn fab gear" title="Settings" aria-haspopup="true" aria-controls="settingsPanel" aria-expanded="false">‚öôÔ∏è</button>

<!-- Waypoints Panel -->
<div id="wpPanel" class="panel" aria-hidden="true">
  <div class="row">
    <input id="wpName" placeholder="Name (e.g., Tower SE)" aria-label="Waypoint name"/>
    <input id="wpCoords" placeholder='34.851939 N, -119.168399 W or 34.851939,-119.168399' aria-label="Coordinates"/>
    <button id="wpAdd" class="btn primary">Add / Update</button>
  </div>
  <div class="list" id="wpList" aria-live="polite"></div>
</div>

<!-- Settings Panel -->
<div id="settingsPanel" class="panel" aria-hidden="true">
  <div class="settings-group">
    <div class="settings-label">Declination Offset (¬∞)</div>
    <input id="declInput" type="number" inputmode="decimal" step="0.1" min="-60" max="60" placeholder="0.0" aria-label="Declination degrees"/>
    <div class="settings-note">Applied to compass/GPS heading: True = Magnetic + Declination.</div>
    <button id="declSave" class="btn primary">Save</button>
  </div>
</div>

<div class="info" id="readout"><div class="metrics"></div></div>

<script>
'use strict';
document.addEventListener('DOMContentLoaded',()=>{
// ------- Utils -------
const $=id=>document.getElementById(id),
R=d=>d*Math.PI/180, Dg=r=>r*180/Math.PI, fix=v=>Number(v).toFixed(6),
N=d=>(d%360+360)%360, Œî=(a,b)=>{let d=N(b)-N(a);return d>180?d-360:d<-180?d+360:d},
blend=(p,n,a)=>p==null?n:N(p+a*Œî(p,n)),
haversine=(a,b)=>{const Rm=6371000,œÜ1=R(a.lat),œÜ2=R(b.lat),dœÜ=R(b.lat-a.lat),dŒª=R(b.lng-a.lng),s=Math.sin(dœÜ/2)**2+Math.cos(œÜ1)*Math.cos(œÜ2)*Math.sin(dŒª/2)**2;return 2*Rm*Math.asin(Math.min(1,Math.sqrt(s)))},
bearing=(a,b)=>{const œÜ1=R(a.lat),œÜ2=R(b.lat),Œª1=R(a.lng),Œª2=R(b.lng),y=Math.sin(Œª2-Œª1)*Math.cos(œÜ2),x=Math.cos(œÜ1)*Math.sin(œÜ2)-Math.sin(œÜ1)*Math.cos(œÜ2)*Math.cos(Œª2-Œª1);return N(Dg(Math.atan2(y,x)))},
dest=(ll,b,dm)=>{const br=R(b),dr=dm/6371000,lat1=R(ll.lat),lon1=R(ll.lng),lat2=Math.asin(Math.sin(lat1)*Math.cos(dr)+Math.cos(lat1)*Math.sin(dr)*Math.cos(br)),lon2=lon1+Math.atan2(Math.sin(br)*Math.sin(dr)*Math.cos(lat1),Math.cos(dr)-Math.sin(lat1)*Math.sin(lat2));return L.latLng(Dg(lat2),Dg(lon2))},
fmtDist=m=>m<1000?`${Math.round(m)} m`:`${(m/1000).toFixed(2)} km`,
DotIcon=s=>L.divIcon({className:'dot-pin',iconSize:[s,s],iconAnchor:[s/2,s/2]}),
makeDot=(lat,lng,size=12)=>L.marker([lat,lng],{icon:DotIcon(size),riseOnHover:true}),
parseCoords=t=>{
  const s=t.trim().replace(/\s+/g,' ').replace(/[,;]+/g,',');
  const m=s.match(/^\s*([+-]?\d+(\.\d+)?)\s*,\s*([+-]?\d+(\.\d+)?)\s*$/i);
  if(m){const lat=+m[1],lng=+m[3];if(isFinite(lat)&&isFinite(lng)&&Math.abs(lat)<=90&&Math.abs(lng)<=180)return{lat,lng}}
  const parts=s.split(',');if(parts.length===2){
    const one=q=>{const x=q.trim().match(/^([NSEW])?\s*([+-]?\d+(\.\d+)?)\s*([NSEW])?$/i);if(!x)return null;
      const h=(x[1]||x[4]||'').toUpperCase();let v=parseFloat(x[2]);
      if(h==='S'||h==='W')v=-Math.abs(v); if(h==='N'||h==='E')v=Math.abs(v); return{v,h}};
    const a=one(parts[0]),b=one(parts[1]); if(a&&b){
      const lat=(a.h==='N'||a.h==='S')?a.v:b.v, lng=(a.h==='E'||a.h==='W')?a.v:b.v;
      if(Math.abs(lat)<=90&&Math.abs(lng)<=180)return{lat,lng}
    }
  }
  return null;
};

// Haptics (why: tactile confirmation when aligned)
const Haptics=(()=>{
  let last=0;
  return{
    hit(){ // short buzz, throttled
      const now=performance.now();
      if(now-last<400) return; last=now;
      if(navigator.vibrate) navigator.vibrate(15);
    }
  };
})();

// ------- App Core -------
const App={
 S:{follow:true,heading:null,bearing:0,rotate:true,press:false,fAngle:null,fPivot:null,dest:null,compass:false,decl:0},
 DEF:{lat:34.9,lng:-119.17,z:16},
 map:null,last:null,ray:null,originDot:null,navLine:null,accCircle:null,markers:new Map(),
 _navState:null, _lastOverlayAngle:null, _compassBound:false, watchId:null, _guideHit:false,
 init(){
  // restore minimal state
  try{
    const saved=JSON.parse(localStorage.getItem('mapapp.state.v1')||'{}');
    if(typeof saved.follow==='boolean') this.S.follow=saved.follow;
    if(typeof saved.rotate==='boolean') this.S.rotate=saved.rotate;
    if(typeof saved.bearing==='number') this.S.bearing=N(saved.bearing);
    if(typeof saved.decl==='number') this.S.decl=+saved.decl||0;
  }catch{}

  this.map=L.map('map',{zoomControl:true,attributionControl:true});
  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{maxZoom:20,minZoom:2,attribution:'¬© OpenStreetMap'}).addTo(this.map);
  this.map.setView([this.DEF.lat,this.DEF.lng],this.DEF.z);
  this.accCircle=L.circle([this.DEF.lat,this.DEF.lng],{radius:0,color:'#4db6ff',weight:1,opacity:.6,fillOpacity:.08}).addTo(this.map);

  this.bindUI(); this.bindMap(); this.loop(); WPs.init(this); Pins.init(this);

  // reflect restored toggles
  this.applyBearing(this.S.bearing);
  $('followState').textContent=this.S.follow?'on':'off';
  $('btnFollow').classList.toggle('toggled',this.S.follow);
  $('btnFollow').setAttribute('aria-pressed',String(this.S.follow));
  $('compassState').textContent=this.S.rotate?'on':'off';
  $('btnCompass').classList.toggle('toggled',this.S.rotate);
  $('btnCompass').setAttribute('aria-pressed',String(this.S.rotate));
  // settings initial
  $('declInput').value=String(this.S.decl);

  addEventListener('beforeunload',()=>{this.persist(); this.stopGPS();},{once:true});
 },
 persist(){
  try{
    localStorage.setItem('mapapp.state.v1',JSON.stringify({follow:this.S.follow,rotate:this.S.rotate,bearing:this.S.bearing,decl:this.S.decl}));
  }catch{}
 },
 uprightOverlays(deg){
   if(this._lastOverlayAngle!=null && Math.abs(Œî(this._lastOverlayAngle,deg))<0.1) return;
   this._lastOverlayAngle = deg;
   const rot=` rotate(${deg}deg)`;
   const fixEl=el=>{
     const base=(el.style.transform||'').replace(/rotate\([^)]*\)/g,'').trim();
     el.style.transformOrigin = el.classList.contains('leaflet-popup') ? 'bottom center' : 'left center';
     el.style.transform = base + rot;
   };
   (this.map.getPanes().popupPane?.querySelectorAll('.leaflet-popup')||[]).forEach(fixEl);
   (this.map.getPanes().tooltipPane?.querySelectorAll('.leaflet-tooltip')||[]).forEach(fixEl);
 },
 mpp(){const s=this.map.getSize(),a=this.map.containerPointToLatLng(L.point(s.x/2,s.y/2)),b=this.map.containerPointToLatLng(L.point(s.x/2+1,s.y/2));return this.map.distance(a,b)||1},
 rayLen(){const s=this.map.getSize();return Math.max(Math.hypot(s.x,s.y)*this.mpp()*1.35+200,3000)},
 pivotLL(){return this.last?L.latLng(this.last.coords.latitude,this.last.coords.longitude):this.map.getCenter()},
 applyBearing(d){
   const pane=this.map.getPane('mapPane'); if(!pane)return; let o='50% 50%';
   if(this.last){const p=this.map.latLngToContainerPoint([this.last.coords.latitude,this.last.coords.longitude]);o=`${p.x}px ${p.y}px`;}
   pane.style.transformOrigin=o;
   pane.style.transform=(pane.style.transform||'').replace(/rotate\([^)]*\)/g,'')+` rotate(${-d}deg)`;
   this.uprightOverlays(d);
 },
 refreshRay(){if(!this.last){this.ray?.setLatLngs([]);return}
   const o=L.latLng(this.last.coords.latitude,this.last.coords.longitude);
   if(!this.originDot){this.originDot=L.circleMarker(o,{radius:3,color:'#2aff2a',weight:2,fillColor:'#2aff2a',fillOpacity:1,interactive:false}).addTo(this.map)}
   else this.originDot.setLatLng(o).bringToFront();
   if(this.S.heading==null)return;
   if(!this.ray)this.ray=L.polyline([],{color:'#2aff2a',weight:3,opacity:1,interactive:false}).addTo(this.map);
   this.ray.setLatLngs([o,dest(o,this.S.heading,this.rayLen())]).bringToFront();
 },
 refreshNav(){
   if(!this.S.dest||!this.last){this.navLine?.setLatLngs([]);$('btnReset').textContent='Reset';this._navState=null;this._guideHit=false;return}
   $('btnReset').textContent='Clear Nav';
   const from=L.latLng(this.last.coords.latitude,this.last.coords.longitude),to=L.latLng(this.S.dest.lat,this.S.dest.lng);
   if(!this.navLine)this.navLine=L.polyline([], {color:'#29a36a',weight:3,opacity:.9,interactive:false,dashArray:'6 6'}).addTo(this.map);
   this.navLine.setLatLngs([from,to]).bringToFront();
   const b=bearing(from,to), d=haversine(from,to), err=this.S.heading==null?null:Œî(this.S.heading,b);
   this._navState={b,d,err};
   if(this.S.heading!=null){
     const delta=Math.abs(err);
     const was=this._guideHit, now=delta<.5;
     if(now){this.navLine.setStyle({color:'#ff4444',weight:4,opacity:1});this.navLine.getElement?.().classList.add('guide-hit')}
     else{this.navLine.setStyle({color:'#29a36a',weight:3,opacity:.9});this.navLine.getElement?.().classList.remove('guide-hit')}
     if(!was && now){ Haptics.hit(); } // haptic on transition into hit
     this._guideHit=now;
   }
 },
 updateHUD(){
   const lat=this.last?.coords?.latitude?.toFixed(6)??'‚Äî',
         lng=this.last?.coords?.longitude?.toFixed(6)??'‚Äî',
         acc=this.last?.coords?.accuracy?Math.round(this.last.coords.accuracy):'‚Äî',
         hd=this.S.heading!=null?(this.S.heading).toFixed(2):'‚Äî',
         mb=(N(-this.S.bearing)).toFixed(2);
   let nav=''; if(this.S.dest&&this.last){
     const b=this._navState?.b, d=this._navState?.d, steer=(this._navState?.err!=null)?this._navState.err.toFixed(2):'‚Äî';
     nav=`<div class="metric"><span>To</span><b class="value">${this.S.dest.name||'Dest'}</b></div>
          <div class="metric"><span>Dist</span><b class="value">${fmtDist(d??0)}</b></div>
          <div class="metric"><span>Brg</span><b class="value">${(b??0).toFixed(2)}&deg;</b></div>
          <div class="metric"><span>Œî</span><b class="value">${steer}&deg;</b></div>`;
   }
   $('readout').innerHTML=`<div class="metrics">
      <div class="metric"><span>Lat</span><b class="value">${lat}</b></div>
      <div class="metric"><span>Lng</span><b class="value">${lng}</b></div>
      <div class="metric"><span>Acc</span><b class="value">${acc} m</b></div>
      <div class="metric"><span>Head</span><b class="value">${hd}&deg;</b></div>
      <div class="metric"><span>Map</span><b class="value">${mb}&deg;</b></div>${nav}</div>`;
 },
 loop(){
   const tgt=(this.S.rotate??true)?(this.S.heading??0):0;
   this.S.bearing = blend(this.S.bearing, tgt, 0.18);
   this.applyBearing(this.S.bearing);
   this.refreshRay(); this.refreshNav(); this.updateHUD();
   requestAnimationFrame(()=>this.loop());
 },
 _adaptHeading(raw){
   const eps=0.05;
   const prev=this.S.heading;
   if(prev!=null && Math.abs(Œî(prev, raw))<eps) return;
   let a=0.15;
   if(this._navState?.b!=null){
     const err=Math.abs(Œî(raw,this._navState.b));
     a = err<6 ? 0.35 : err<15 ? 0.25 : 0.15;
   }
   this.S.heading = blend(prev, raw, a);
 },
 onOrient(e){
   let h=typeof e.webkitCompassHeading==='number'?e.webkitCompassHeading:typeof e.alpha==='number'?e.alpha:null;
   if(h==null||isNaN(h))return;
   h=N(h + (this.S.decl||0)); // apply declination
   if(this.S.heading==null){ this.S.heading=h; if(this.S.rotate) this.S.bearing=h; }
   else{ this._adaptHeading(h); }
 },
 async enableCompass(){
   if(this.S.compass) return true;
   try{
     if(location.protocol!=='https:' && location.hostname!=='localhost'){ alert('Compass requires HTTPS on most browsers.'); return false; }
     if(typeof DeviceOrientationEvent!=='undefined'&&typeof DeviceOrientationEvent.requestPermission==='function'){
       const g=await DeviceOrientationEvent.requestPermission(); if(g!=='granted'){alert('Compass permission denied.');return false;}
     }
     if(!this._compassBound){
       const handler=e=>this.onOrient(e);
       addEventListener('deviceorientationabsolute',handler,true);
       addEventListener('deviceorientation',handler,true);
       this._compassBound=true;
     }
     this.S.compass=true; return true;
   }catch{alert('Compass access failed.'); return false}
 },
 startGPS(){
   if(!('geolocation'in navigator))return alert('Geolocation not supported.');
   if(this.watchId!=null) return;
   this.watchId = navigator.geolocation.watchPosition(p=>{
     this.last=p; const {latitude,longitude,accuracy:acc,heading}=p.coords, ll=[latitude,longitude];
     this.accCircle.setLatLng(ll).setRadius(Math.max(acc||0,0));
     if(this.S.follow&&!this.S.press)this.map.setView(ll,Math.max(this.map.getZoom(),16),{animate:false});
     if(Number.isFinite(heading)){
       const h=N(heading + (this.S.decl||0)); // apply declination to course if provided
       if(this.S.heading==null) this.S.heading=h; else this._adaptHeading(h);
     }
   },e=>alert('Unable to get location: '+e.message),{enableHighAccuracy:true,maximumAge:2000,timeout:15000});
 },
 stopGPS(){
   if(this.watchId!=null && 'geolocation'in navigator){ navigator.geolocation.clearWatch(this.watchId); this.watchId=null; }
 },
 resetView(){
   if(this.S.dest){this.S.dest=null; this.refreshNav(); this.updateHUD(); return}
   if(this.last){const{latitude,longitude}=this.last.coords; this.map.setView([latitude,longitude],Math.max(this.map.getZoom(),16))}
   else this.map.setView([this.DEF.lat,this.DEF.lng],this.DEF.z);
   this.applyBearing(this.S.bearing);
 },
 setFollow(v){
   this.S.follow=!!v;
   $('followState').textContent=this.S.follow?'on':'off';
   $('btnFollow').classList.toggle('toggled',this.S.follow);
   $('btnFollow').setAttribute('aria-pressed',String(this.S.follow));
   if(this.S.follow&&this.last){const{latitude,longitude}=this.last.coords; this.map.setView([latitude,longitude],Math.max(this.map.getZoom(),16),{animate:false}); this.applyBearing(this.S.bearing)}
 },
 latLngFromPt(pt){const ang=(this.S.press&&this.S.fAngle!=null)?this.S.fAngle:this.S.bearing,
   layer=this.map.containerPointToLayerPoint(pt), pivot=(this.S.press&&this.S.fPivot)?this.S.fPivot:this.map.latLngToLayerPoint(this.pivotLL()),
   th=R(ang),c=Math.cos(th),s=Math.sin(th),dx=layer.x-pivot.x,dy=layer.y-pivot.y,
   un=L.point(pivot.x+dx*c+dy*s, pivot.y+(-dx*s)+dy*c); return this.map.layerPointToLatLng(un)},
 bindPopup(m,{name,lat,lng}){
   const html=nm=>`<div class="popup-grid">
     <input class="popup-input" type="text" placeholder="Name" value="${nm||`Pin ${fix(lat)},${fix(lng)}`}" data-name/>
     <div style="color:var(--dim);font-size:12px">${fix(lat)}, ${fix(lng)}</div>
     <div class="popup-actions">
       <button class="btn" data-copy>Copy</button>
       <button class="btn" data-min>Minimize</button>
       <button class="btn" data-guide>Guide</button>
       <button class="btn primary" data-save>Save</button>
     </div></div>`;
   m.unbindPopup();
   m.bindPopup(html(name),{className:'floating-popup',autoClose:true,closeButton:true,offset:[0,-10]})
    .off('popupopen').on('popupopen',()=>{
      const el=m.getPopup().getElement(),I=el.querySelector('[data-name]'),C=el.querySelector('[data-copy]'),SAV=el.querySelector('[data-save]'),MIN=el.querySelector('[data-min]'),G=el.querySelector('[data-guide]');
      C?.addEventListener('click',async()=>{const txt=`${fix(lat)}, ${fix(lng)}`;try{await navigator.clipboard.writeText(txt);C.textContent='Copied';setTimeout(()=>C.textContent='Copy',900)}catch{prompt('Copy to clipboard:',txt)}});
      SAV?.addEventListener('click',()=>{const nm=(I?.value||'').trim()||`WP ${Date.now().toString().slice(-5)}`; WPs.upsert(nm,lat,lng); m.closePopup(); m._nm=nm});
      MIN?.addEventListener('click',()=>{const nm=(I?.value||m._nm||'Pin')||'Pin'; m.bindTooltip(nm,{permanent:true,direction:'right',offset:[8,0],className:'mini-label'}).openTooltip(); m.closePopup(); m._nm=nm; App.uprightOverlays(App.S.bearing);});
      G?.addEventListener('click',()=>{App.S.dest={lat,lng,name:(I?.value||m._nm||'Dest')}; App.refreshNav(); App.updateHUD(); m.closePopup();});
      App.uprightOverlays(App.S.bearing);
    });
   m.on('tooltipopen',()=>App.uprightOverlays(App.S.bearing));
 },
 bindUI(){
   $('btnLocate').onclick=()=>this.startGPS();
   $('btnCompass').onclick=async()=>{if(!await this.enableCompass())return; this.S.rotate=!(this.S.rotate??true);
     $('compassState').textContent=this.S.rotate?'on':'off'; $('btnCompass').classList.toggle('toggled',this.S.rotate); $('btnCompass').setAttribute('aria-pressed',String(this.S.rotate));
     this.applyBearing(this.S.bearing); if(this.S.rotate)this.setFollow(true)};
   $('btnReset').onclick=()=>this.resetView();
   $('btnFollow').onclick=()=>this.setFollow(!this.S.follow);

   // Waypoints
   const btnWP=$('btnWaypoints'), wpPanel=$('wpPanel');
   btnWP.onclick=()=>{const open=!wpPanel.classList.contains('open'); wpPanel.classList.toggle('open',open); wpPanel.setAttribute('aria-hidden',open?'false':'true'); btnWP.setAttribute('aria-expanded',String(open))};
   $('wpAdd').onclick=()=>{const p=parseCoords($('wpCoords').value); if(!p)return alert('Could not parse coordinates. Try "34.851939,-119.168399" or "34.851939 N, -119.168399 W".'); WPs.upsert($('wpName').value,p.lat,p.lng); $('wpName').value=''; $('wpCoords').value=''};

   // Waypoint list actions (Go, Guide, Edit, Save, Cancel, Del)
   $('wpList').onclick=e=>{
     const t=e.target;
     const idx = t.getAttribute('data-idx');
     if(idx==null) return;
     const i=+idx;
     if(t.hasAttribute('data-go')){ const w=WPs.load()[i]; if(w){ this.setFollow(false); this.map.setView([w.lat,w.lng],16); WPs.ensureMarker(w.name)?.openPopup(); } }
     else if(t.hasAttribute('data-guide')){ const w=WPs.load()[i]; if(w){ this.S.dest={lat:w.lat,lng:w.lng,name:w.name}; this.refreshNav(); this.updateHUD(); } }
     else if(t.hasAttribute('data-edit')){ WPs.edit(i); }
     else if(t.hasAttribute('data-save-edit')){ WPs.saveEdit(i); }
     else if(t.hasAttribute('data-cancel')){ WPs.render(); }
     else if(t.hasAttribute('data-del')){ WPs.del(i); }
   };

   // Settings
   const btnSettings=$('btnSettings'), settings=$('settingsPanel');
   btnSettings.onclick=()=>{const open=!settings.classList.contains('open'); settings.classList.toggle('open',open); settings.setAttribute('aria-hidden',open?'false':'true'); btnSettings.setAttribute('aria-expanded',String(open))};
   $('declSave').onclick=()=>{ const v=parseFloat(($('declInput').value||'0').trim()); if(Number.isFinite(v)){ this.S.decl=Math.max(-60,Math.min(60,v)); this.persist(); } };
 },
 bindMap(){
   const container=this.map.getContainer(); let timer=null,start=null,last=null; const LONG=420, MOVE=6;
   const pt=e=>{const r=container.getBoundingClientRect(); return L.point(e.clientX-r.left, e.clientY-r.top)};
   const freezeS=()=>{this.S.press=true; this.S.fAngle=this.S.bearing; this.S.fPivot=this.map.latLngToLayerPoint(this.pivotLL())};
   const freezeE=()=>{this.S.press=false; this.S.fAngle=null; this.S.fPivot=null};
   const dropAt=ll=>Pins.drop(ll.lat,ll.lng);
   container.addEventListener('pointerdown',e=>{if(e.button!==0&&e.pointerType==='mouse')return;e.preventDefault(); freezeS(); start=last=pt(e); clearTimeout(timer);
     timer=setTimeout(()=>{timer=null; dropAt(this.latLngFromPt(last)); freezeE()},LONG)},{passive:false});
   container.addEventListener('pointermove',e=>{if(!timer)return;e.preventDefault(); last=pt(e); if(Math.hypot(last.x-start.x,last.y-start.y)>MOVE){clearTimeout(timer); freezeE()}},{passive:false});
   ['pointerup','pointercancel','pointerleave'].forEach(ev=>container.addEventListener(ev,()=>{clearTimeout(timer); freezeE()},{passive:true}));
   this.map.on('contextmenu',e=>{e.originalEvent?.preventDefault(); freezeS(); const p=e.containerPoint??pt(e.originalEvent); dropAt(this.latLngFromPt(p)); freezeE()});
   this.map.on('move moveend zoom zoomend zoomanim',()=>{this.applyBearing(this.S.bearing); this.refreshRay(); this.refreshNav()});
   addEventListener('resize',()=>{this.map.invalidateSize(); this.applyBearing(this.S.bearing); this.refreshRay(); this.refreshNav()},{passive:true});
 }
};

// ------- Waypoints -------
const WPs={
 key:'mapapp.waypoints.v1', app:null, markers:new Map(),
 init(app){this.app=app; this.render(); this.syncMarkers();},
 load(){try{return JSON.parse(localStorage.getItem(this.key)||'[]')}catch{return[]}},
 save(a){localStorage.setItem(this.key,JSON.stringify(a))},
 ensureMarker(name){return this.markers.get(name)||null},
 render(){
   const list=$('wpList'); list.innerHTML='';
   const a=this.load();
   a.forEach((w,i)=>{
     const d=document.createElement('div'); d.className='item';
     d.innerHTML=`
      <div><strong>${w.name}</strong><small>${w.lat.toFixed(6)}, ${w.lng.toFixed(6)}</small></div>
      <button class="btn" data-idx="${i}" data-go>Go</button>
      <button class="btn" data-idx="${i}" data-guide>Guide</button>
      <button class="btn" data-idx="${i}" data-edit>Edit</button>
      <button class="btn danger" data-idx="${i}" data-del>Del</button>`;
     list.appendChild(d);
   });
 },
 edit(i){
   const list=$('wpList'); const a=this.load(); const w=a[i]; if(!w) return;
   const d=list.children[i]; if(!d) return;
   d.className='item'; d.style.gridTemplateColumns='1fr auto auto';
   d.innerHTML=`
     <div style="display:grid;gap:6px">
       <input data-e-name placeholder="Name" value="${w.name}"/>
       <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px">
         <input data-e-lat placeholder="Lat" value="${w.lat.toFixed(6)}"/>
         <input data-e-lng placeholder="Lng" value="${w.lng.toFixed(6)}"/>
       </div>
     </div>
     <button class="btn primary" data-idx="${i}" data-save-edit>Save</button>
     <button class="btn" data-idx="${i}" data-cancel>Cancel</button>`;
 },
 saveEdit(i){
   const a=this.load(); const w=a[i]; if(!w) return;
   const list=$('wpList'); const d=list.children[i]; if(!d) return;
   const nm=(d.querySelector('[data-e-name]')?.value||'').trim()||w.name;
   const lat=parseFloat((d.querySelector('[data-e-lat]')?.value||'').trim());
   const lng=parseFloat((d.querySelector('[data-e-lng]')?.value||'').trim());
   if(!Number.isFinite(lat)||!Number.isFinite(lng)||Math.abs(lat)>90||Math.abs(lng)>180){ alert('Invalid coordinates.'); return; }
   a[i]={name:nm,lat,lng};
   this.save(a); this.render(); this.syncMarkers();
 },
 upsert(name,lat,lng){
   const a=this.load(),nm=(name?.trim())||`WP ${Date.now().toString().slice(-5)}`,i=a.findIndex(w=>w.name.toLowerCase()===nm.toLowerCase()),e={name:nm,lat,lng};
   if(i>=0)a[i]=e; else a.push(e); this.save(a); this.render(); this.syncMarkers()
 },
 del(i){
   const a=this.load(); const[rm]=a.splice(i,1); this.save(a); this.render();
   if(rm&&this.markers.has(rm.name)){App.map.removeLayer(this.markers.get(rm.name)); this.markers.delete(rm.name)}
 },
 syncMarkers(){
   const a=this.load();
   a.forEach(w=>{ if(!this.markers.has(w.name)){const m=makeDot(w.lat,w.lng,12).addTo(App.map); App.bindPopup(m,{name:w.name,lat:w.lat,lng:w.lng}); this.markers.set(w.name,m)}
                  else{const m=this.markers.get(w.name); m.setLatLng([w.lat,w.lng]).setIcon(DotIcon(12)); App.bindPopup(m,{name:w.name,lat:w.lat,lng:w.lng})}});
   [...this.markers.keys()].forEach(n=>{if(!a.some(w=>w.name===n)){App.map.removeLayer(this.markers.get(n)); this.markers.delete(n)}});
 }
};

// ------- Ad-hoc Pins -------
const Pins={
 app:null, pin:null,
 init(app){this.app=app},
 drop(lat,lng){
   if(this.pin)App.map.removeLayer(this.pin);
   this.pin=makeDot(lat,lng,14).addTo(App.map);
   App.bindPopup(this.pin,{name:`Pin ${fix(lat)},${fix(lng)}`,lat,lng});
   this.pin.openPopup();
   App.uprightOverlays(App.S.bearing);
 }
};

// ------- Boot -------
App.init();
});
</script>
</body></html>
